var pgRedrawTaskId=null,PgQuickWindow=(jQuery.fn.redraw=function(){},function(e,a,l,t,n,i,o,s){function r(e,t){var n=null;return t?e=t.get$DOMElement():e&&(n=e.closest("body")),n&&n.length?n:$("body")}function c(){u.dragMoverResizer&&u.dragMoverResizer.ensureVisible(!1,!1)}var d,u=this,h=(this.view=a,this.hideOnClose=!1,this.isClosable=!0,this.visible=!1,this.pinned=i||!1,this.wasMoved=!1,this.wasResized=!1,o&&"1"===pinegrow.getSetting(l+"-float","0")),p=(this.app_win=null,this.$element=$('<div class="pg-quick-win"><div class="pg-quick-win-header lm_handle"><span class="pg-quick-win-header-title">'+e+'</span><div class="pg-quick-win-header-icons"><span class="pg-close pg-quick-win-header-icon">'+'<i class="icon icon-close"></i></span></div></div><div class="pg-quick-win-content"></div><div class="pg-win-resizer"><i class="icon icon-drag-kotni"</div></div>'),s&&this.$element.addClass("pg-quick-win-static"),this.$element.find(".pg-quick-win-content")),g=this.$element.find(".pg-quick-win-header-title"),f=(this.$element.on("keydown",function(e){if("Enter"===e.key)if(u.onEnter)return u.onEnter()}),this.autoSize=function(e){void 0===e&&(e=50);var t=p.css("bottom"),n=(p.css("bottom","auto"),p.height()),n=(p.css("bottom",t),n+e),t=this.$element.offset(),i=this.$element.closest("body").height();100<n&&t.top+n>i&&(n=i-t.top),this.$element.css({height:n+"px"})},this.noRightEdge=function(){p.addClass("no-right-edge")},this.$element.find(".pg-close").on("click",function(e){e.preventDefault(),u.hideOnClose?u.hide():u.destroy()}),pgQuickWindowManager.getSize(l,t||300,n||300)),m=(this.$element.css({width:f.w+"px",height:f.h+"px"}),p.append(a.view.get$Element()),a.view.alwaysVisible=!0,a.view.updateVisibility(),this.addIconToHeader=function(e,t,n){var i=$('<span class="pg-quick-win-header-icon"><i class="icon '+e+'"></i></span>').prependTo(this.$element.find(".pg-quick-win-header-icons"));return i.on("click",function(e){e.preventDefault(),n(i)}),t&&addTooltip(i,t),i},o&&this.addIconToHeader("icon-window","Toggle floating window",function(){u.app_win?(u.$element.removeClass("pg-quick-win-floating"),pinegrow.setSetting(l+"-float","0"),h=!1,u.showFor$El($("body")),pgUIViewManager.forEachView(u.$element,function(e){e.onMovedToAnotherWindow&&e.onMovedToAnotherWindow(window,u.$element)}),pinegrow.selectedElements.reselect(),u.app_win.close(),u.app_win=null):(u.$element.detach(),pinegrow.setSetting(l+"-float","1"),h=!0,m())}),this.setTitle=function(e){g.html(e)},function(){u.$element.addClass("pg-quick-win-floating"),u.isClosable=!1;function i(){$(u.app_win.window.document.body).find(".pg-app-win-header .close").hide(),u.onFloatingChanged&&u.onFloatingChanged(),$(u.app_win.window).off(".qw").on("resize.qw",function(){a.view.onResize&&a.view.onResize()}),a.view.onResize&&a.view.onResize()}u.app_win?(u.app_win.show(),$(u.app_win.window.document.body).find(".pg-quick-win-floating").detach(),$(u.app_win.window.document.body).find("#layout-container").append(u.$element),i()):openPanelInExternalWindow(u.$element,function(e,t,n){u.app_win=n,i()},{},{config:{pg_win_id:l}})}),v=(h&&(v=pgQuickWindowManager.getWindow(l))&&v.app_win&&(this.app_win=v.app_win,v.app_win=null),this.showForPgel=function(e){var t;this.visible=!0,h?m():(t=r(null,e),this.$element.parent().is(t)||this.$element.appendTo(t),d&&d.destroy(),d=new PgPositionNextToPgel(this.$element,e,a),pgUIViewManager.updateVisibilityInArea(p),a.view.onResize&&a.view.onResize())},this.showFor$El=function(e,t,n,i){var o,s;this.visible=!0,h?m():(s=(o=getPageViewOfElement(e))?o.getPageParent$Body():r(e),this.$element.parent().is(s)||this.$element.appendTo(s),d&&d.destroy(),s=pgQuickWindowManager.getPosition(l),t&&s?this.showAtPosition(s.x,s.y,f.w,!1):d=o?new PgPositionNextToPage$El(o,this.$element,e,a,n):new PgPositionNextTo$El(this.$element,e,a,n,i),pgUIViewManager.updateVisibilityInArea(p),a.view.onResize&&a.view.onResize())},this.showCover=function(e){this.visible=!0;var t=r();this.$element.parent().is(t)||this.$element.appendTo(t),d=new PgPositionNextTo$El(this.$element,t,a,0,e||"cover_right"),pgUIViewManager.updateVisibilityInArea(p),a.view.onResize&&a.view.onResize()},this.showAsPrompt=function(){this.showCover("center_bottom_inside")},this.showAtRandomPosition=function(){this.visible=!0;var e=pgQuickWindowManager.getPosition(l);e||((e={}).x=100+parseInt(Math.random()*($("body").width()/4)),e.y=100+parseInt(Math.random()*($("body").height()/4))),this.showAtPosition(e.x,e.y,f.w,!1)},this.showAtPosition=function(e,t,n,i){this.visible=!0,void 0===i&&(i=!0),this.$element.appendTo(r()),n=n||this.$element.width(),this.$element.css({left:e+"px",top:t+"px",margin:"auto",width:n+"px"}),pgUIViewManager.updateVisibilityInArea(p),a.view.onResize&&a.view.onResize(),this.dragMoverResizer.ensureVisible(i,!0)},$(window).on("resize",c),this.close=this.destroy=function(){this.onDestroy&&this.onDestroy(this),d&&d.destroy(),a.view.destroy(),this.$element.get(0).removeEventListener("click",w,!0),this.$element.remove(),this.app_win&&this.app_win.close(),$(window).off("resize",c),this.visible=!1,pgQuickWindowManager.deregister(l)},this.show=function(e){this.visible=!0,this.app_win&&this.app_win.show(),pg$Show(this.$element);var n=!1;this.dragMoverResizer&&this.dragMoverResizer.ensureVisible(e,!0,function(e,t){n=t}),pgUIViewManager.updateVisibilityInArea(p),n&&(a.view.onResize&&a.view.onResize(),this.onResize)&&this.onResize(),this.onShow&&this.onShow()},this.hide=function(e){this.visible=!1,this.app_win&&this.app_win.hide(),pg$Hide(this.$element),pgUIViewManager.updateVisibilityInArea(p),this.onHide&&this.onHide(e)},this.$element.find(".pg-quick-win-header")),w=(v.on("dblclick",function(e){u.show(!0)}),this.dragMoverResizer=new PgMoverAndResizer(this.$element,s?"dummy":v,this.$element.find(".pg-win-resizer"),"body"),this.dragMoverResizer.onResize=function(e,t){this.app_win||(a.view.onResize&&a.view.onResize(),pgQuickWindowManager.rememberSize(l,e,t),u.onResize&&u.onResize(),u.wasResized=!0)},this.dragMoverResizer.onMove=function(e,t){this.app_win||(u.onMove&&u.onMove(),pgQuickWindowManager.rememberPosition(l,e,t),d&&(d.destroy(),d=null),u.wasMoved=!0)},this.dragMoverResizer.onMoveDrag=function(e,t){u.onMoveDrag&&u.onMoveDrag()},this.setFocused=function(e){this.pinned||(e?this.$element.addClass("focused"):this.$element.removeClass("focused"))},function(){u.pinned||pgQuickWindowManager.focus(u)});this.$element.get(0).addEventListener("click",w,!0),pgQuickWindowManager.register(l,this)}),PgQuickWindowManager=function(){function n(e,t){e.hideOnClose?e.hide(t):e.destroy()}var i={},t=this,o={},s={},a={},l=[];this.setRememberInSettings=function(e){o[e]=!0},this.rememberSize=function(e,t,n){s[e]={w:t,h:n}},this.getSize=function(e,t,n){return s[e]||{w:t,h:n}},this.rememberPosition=function(e,t,n){a[e]={x:t,y:n},o[e]&&pinegrow.setSetting("qwin_pos_"+e,JSON.stringify(a[e]))},this.getPosition=function(e){if(o[e]){var t=pinegrow.getSetting("qwin_pos_"+e);if(t)try{a[e]=JSON.parse(t)}catch(e){}}return a[e]||null},this.register=function(e,t){i[e]&&i[e].destroy(),(i[e]=t).pinned||this.focus(t)},this.deregister=function(e){var t=i[e]||null;if(t){i[e]=null;t=l.indexOf(t);0<=t&&l.splice(t,1);for(var n=l.length-1;0<=n;){if(l[n].$element.is(":visible"))return void l[n].setFocused(!0);n--}}};this.isOpen=function(e){return!!i[e]},this.getWindow=function(e){return i[e]||null},this.close=function(e,t){i[e]&&n(i[e],t)},this.focus=function(e,t){var n=l.indexOf(e);0<=n&&l.splice(n,1),l.length&&l[l.length-1].setFocused(!1),l.push(e),e.setFocused(!0)},this.closeLast=function(){var e=this.hasClosableWindows();e&&n(e)},this.hasWindows=function(){return 0<l.length},this.hasClosableWindows=function(){for(var e=l.length-1;0<=e;e--)if(l[e].isClosable&&l[e].visible)return l[e];return null},this.closeAll=function(){var n=[];$.each(i,function(e,t){n.push(e)}),n.forEach(function(e){t.close(e,!0)})}},pgQuickWindowManager=new PgQuickWindowManager;function makeDialog(e,t,n,i,o){var s='<div class="modal-content">                <div class="modal-header">                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>                    <h4 class="modal-title">'+e+'</h4>                </div>                <div class="modal-body">'+("string"==typeof(i=void 0===i?"":i)?i:"")+'                </div>                <div class="modal-footer"><p class="pull-left"></p>',s=(t&&(s+='<button type="button" class="btn btn-default btn-sm cancel">'+t+"</button>"),n&&(s+=o?'<a class="btn btn-primary btn-sm ok" href="'+o+'" target="_blank">'+n+"</a>":'<button type="button" class="btn btn-primary btn-sm ok">'+n+"</button>"),s+="</div>            </div>",$("<div/>",{class:"modal-dialog crsa-dialog-nonmodal"}).html(s));return"object"==typeof i&&s.find(".modal-body").append(i),s}function makeAndShowDialog(e,t,n,i,o,s,a,l){var r=makeDialog(e,t,n,i),c=($("body").append(r),100),d=100;return l&&(c=$("body").width()/2-$(".modal-dialog").width()/2,d=10),r.css("top",d+"px").css("left",c+"px"),r.draggable({handle:".modal-header"}).on("dragstart",function(e,t){$.fn.crsapages("showOverlays")}).on("dragstop",function(){$.fn.crsapages("showOverlays",!0)}),r.find("button.close,button.cancel").click(function(){o&&o(),r.remove()}),r.find("button.ok").click(function(){a&&!a()||(s&&s(),r.remove())}),r.on("hidden.bs.modal",function(){r.remove()}),r}function setDialogNotice(e,t,n){e.find(".modal-footer > p").html(t).attr("class","pull-left "+n)}function makeModalDialog(e,t,n,i,o,s,a){var l=makeDialog(e,t,n,i="function"==typeof i?i():i,"string"==typeof s?s:null),r=(l.removeClass("crsa-dialog-nonmodal"),$("<div/>",{class:"modal aafade",tabIndex:"-1",role:"dialog"}).append(l)),l=(r.find("button.close,button.cancel").click(function(e){o&&o(e),o=null,r.modal("hide")}),"string"==typeof s?r.find("a.ok").click(function(e){}):r.find("button.ok").click(function(e){s&&!1===s(e)||(o=null,r.modal("hide"))}),r.on("hidden.bs.modal",function(){o&&o(),r.remove()}),a&&a(r),r.modal({backdrop:"static"}),pgGetFocusedWindow());return l&&l.window!==window&&pg_app_windows[0].focus(),r}function makeModalDialogWhole(e){"function"==typeof e&&(e=e());var t=$(e),t=$("<div/>",{class:"modal aafade",tabIndex:"-1",role:"dialog"}).append(t);return t.modal({backdrop:"static",keyboard:!1}),t}function showAlert(e,t,n,i,o,s,a,l){var r=makeModalDialog(t=t||"Notice",n,i=i||n?i:"OK",e,o,s);return a&&$('<a href="#" class="btn btn-primary">'+a+"</a>").appendTo(r.find(".modal-footer")).on("click",function(e){e.preventDefault(),l&&l(e),r.modal("hide")}),crsaHandleExternalLinks(r),r}function crsaHandleExternalLinks(e,n){isApp()&&e.on("click","a.external",function(e){e.preventDefault();var t=$(this).attr("href");return t.startsWith("help://")?($("body").trigger("click"),pinegrow.showDocsTopic(t.replace("help://",""))):(require("nw.gui").Shell.openExternal(t),n&&n(t)),!1})}function showNotice(e,t,n,i,o,s,a,l,r,c,d){d=$.extend({},{cancel_label:"Cancel",ok_label:"Ok",got_it_label:"Got it"},d||{});n="notice_hide_"+n;if(!s){if(n in localStorage&&"1"==localStorage[n])return void(i&&i(!1));if(o&&n in localStorage)return void(i&&i(!1))}function u(){i&&i(!0),h.find("input").is(":checked")?localStorage[n]="1":localStorage[n]="0"}var h=$('<label class="pull-left control-label"><input type="checkbox" '+(a?"":'checked="checked"')+"> Don't show this notice again</label>"),p=showAlert(e,t,l?d.cancel_label:null,l?d.ok_label:d.got_it_label,function(){l||u()},u,r,c);return o||p.find(".modal-footer").prepend(h),p}function showPrompt(e,t,n,i,o,s,a,l,r,c){function d(e){var t;return!c||(t=c(e),(m=t)?(g.html(t),pg$Show(g),p.addClass("has-error"),!1):(pg$Hide(g),p.removeClass("has-error"),!0))}var u,h=$('<form role="form" autocomplete="off">        <div class="form-group">        <label for="dlgInput">'+e+'</label>        <input type="text" class="form-control" id="dlgInput" placeholder="'+i+'"  spellcheck="false">        <p class="help-block"></p>        </div>        </form>'),p=h.find(".form-group"),g=h.find(".help-block"),f=(pg$Hide(g),r&&r.length&&(u=$(`<div><p>Select a recent value:</p><ul></ul></div>`).appendTo(h).find("ul"),r.forEach(function(t){$li=$(`<li><a href="#" style="word-break: break-all;">${t}</a></li>`),u.append($li),$li.find("a").on("click",function(e){e.preventDefault(),s(t),v.modal("hide")})})),h.find("input")),m=(h.on("submit",function(e){var t,n;e.preventDefault(),m?pinegrow.showQuickError("The value is not correct. "+m):(t=!0,(t=s&&!1===(n=s(f.val()))?n:t)&&v.modal("hide"))}),n&&f.val(n),!1),v=(c&&f.on("input",function(e){var t=e.target.value;d(t)}),showAlert(h,t,a||"Cancel",l||"Ok",o,function(){var e=f.val();if(s)return d(e)?s(e):(pinegrow.showQuickError("The value is not correct."),!1)}));return v.on("shown.bs.modal",function(){f.focus()}),f.focus(),v}var CrsaCollapsibleSections=function(e){this.show=function(o,s){e.find("li.section > div").on("click",function(e){var t=$(e.delegateTarget).parent(),n=o(t),i=t.find(">ul");t.hasClass("section-closed")?slideToggle(i,function(){var e;t.removeClass("section-closed"),n&&(n.closed=!1,e="sec_open_"+n.key,localStorage[e]="1")}):slideToggle(i,function(){var e;t.addClass("section-closed"),n&&(n.closed=!0,e="sec_open_"+n.key,localStorage[e]="0")}),s&&s(t)}),pinegrow.getSelectedElement()&&s&&s()}},CrsaActionsPanel=function(e){function P(e,t){return t.has_action?t.has_action(e):t.attribute&&e.hasAttr(t.attribute)}var k,S=e||"ACT",T=null,E=null,x=null,M=null,A=(this.showAssignedActions=!0,this);this.show=function(e){function o(e){var t=null,n=!1;if(E=x=null,u=e){if(t=e.getActionsSections(),null==T||null==t)n=!0;else if(T.length!=t.length)n=!0;else for(var i=0;i<t.length;i++)if(t[i]!=T[i]){n=!0;break}}else n=!0;n?y(t):C()}var n=null,t=(k=e).find(">.header"),i=$("<input/>",{class:"form-control filter-form",placeholder:"search",spellcheck:"false"}).appendTo(t),s=(crsaAddCancelSearch(i,"top: 16px;right: 47px;"),$("<div/>",{class:"form-tags"}),$('<a href="#" class="icon-action"><i class="fa fa-cog"></i></a>').appendTo(t)),s=(s.on("click",function(e){var t=pinegrow.getSelectedPage();t||1?($.fn.crsacss("showFrameworkManager",t),e.preventDefault()):showAlert("Open a page first!")}),addTooltip(s,"Manage libraries and plugins for the selected page."),e),a=$("<ul/>",{class:"props-desc-obj"}).appendTo(s),l=($('<ul class="selected-insert"><li class="section"><div><h2></h2></div><ul></ul><div class="insert-help">Right click for options.</div></li></ul>').appendTo(s).hide(),$("<ul/>").appendTo(s)),s=$('<label class="css-opt-label actions-show-help-label"><input class="control-label" type="checkbox" value="1">&nbsp;<span>Show help texts</span></label>').appendTo(t),u=(s.find("input").on("change",function(e){$(e.delegateTarget).is(":checked")?(l.addClass("show-help-text"),pinegrow.setSetting("actions-show-help-text","1")):(l.removeClass("show-help-text"),pinegrow.setSetting("actions-show-help-text","0"))}),"1"==pinegrow.getSetting("actions-show-help-text","1")&&(l.addClass("show-help-text"),s.find("input").attr("checked","checked")),null),r=($("body").on("crsa-page-selected",function(e,t){o(t)}),$("body").on("crsa-element-selected",function(e,t){var n=pinegrow.getSelectedPage(),i=!1;E=(M=t)?(i=null==E,x=M.get$DOMElement(),M):x=null,u!=n?o(n):(i||!M?y:(_(),C))(),$.fn.crsa("showElementDescription",a,M)}),$("body").on("crsa-frameworks-changed",function(e){y()}),[]),c={name:"Assigned actions",framework:{name:"Shortcuts",show_in_action_tab:S},getComponentTypes:function(){return[]}};function g(s,a,e,l){var t=a.sections?Object.values(a.sections):[],r=(a.on_before_show_fields&&a.on_before_show_fields(u,t,s,a),{});try{r=s?getValuesForObject(s,t):{}}catch(e){console.log(e)}var c=$("<div/>",{class:"action-fields"}),d=(t.length,[]);$.each(t,function(e,t){if(t.hasOwnProperty("show")&&!t.show||!t.name)return!0;0<e&&$('<div class="crsa-field crsa-field-label"><label>'+t.name+"</label></div>").appendTo(c);function n(e){$.each(e,function(e,t){var n="custom"==t.type?t.show(i,s,e,t,r):$.fn.crsa("addInputField",i,s,e,t,r,!1,l);t.on_fields_created&&d.push({func:t.on_fields_created,obj:s,field:n,def:t,name:e,default_value:t.default_value||null}),pinegrow.validateField(s,e,r.hasOwnProperty(e)?r[e]:null,t,n,r)})}var i=$("<div/>").appendTo(c),o=(n(t.fields),{});u.callFrameworkHandler("on_show_action_fields",o,a,s),n(o)});for(var n=0;n<d.length;n++){var i=r.hasOwnProperty(d[n].name)?r[d[n].name]:null;null===i&&d[n].default_value&&(i=d[n].default_value),d[n].func(d[n].obj,d[n].name,i,d[n].def,d[n].field,r)}d=null,c.insertAfter(e.find(">name"))}var d,h,f=function(e){e.find(">.action-fields").remove()},p=[],m=[],v=function(e){return p[parseInt(e.attr("data-section-index"))]},w=function(e){return m[parseInt(e.attr("data-action-index"))]},b=function(e,t){var n="",i="",o="",s="",a=null,l="",l="<icons>";if(e.framework&&e.framework.get_preview_for_action&&(l+='<i class="icon icon-wand action-magic only-active"></i>&nbsp;<i class="fa fa-code show-code"></i>'),l+='<i title="Remove action from the element" class="fa fa-times remove-action only-active"></i>&nbsp;</icons>',e.meta&&(i=e.meta.extra_name?"<small> / "+e.meta.extra_name+"</small>":"",o=e.meta.helptext||"",e.meta.helplink&&(o+='<a href="'+e.meta.helplink+'" class="external"><i class="fa fa-question-circle"></i></a>'),e.meta.tags)&&e.meta.tags.length&&(a=s=e.meta.tags.join(" ")),d&&!(t||e.name.match(d)||i.match(d)||s.match(d)))return"";if(!function(e,t){if(t&&0!=t.length){if(!e||0==e.length)return!1;for(var n=0;n<t.length;n++){for(var i=!1,o=0;o<t[n].length;o++)if(0<=e.indexOf(t[n][o])){i=!0;break}if(!i)return!1}}return!0}(a,r))return"";m.push(e),n+='<li data-action-index="'+(m.length-1)+'" class="crsa-action crsa-action-on"><name>'+e.name+i+l+"</name>";return E&&P(E,e)&&0,s.length,o.length&&(n+='<p class="help-text">'+o+"</p>"),n+="</li>"},_=function(){if(A.showAssignedActions){var e=pinegrow.getSelectedPage();if(e&&E){var t=e.getAllActionTypes(E),n="",e=l.find("> .assigned-actions");if(t.length){for(var i=0;i<t.length;i++)t[i].framework.show_in_action_tab==S&&(n+=b(t[i],!1));e.show()}else e.hide();pgRemoveMultiselects(e),e.find(">ul").html(n),crsaHandleExternalLinks(e)}}},y=function(e){var o,t=pinegrow.getSelectedPage();pgRemoveMultiselects(l),l.html(""),n=i.val(),d=n&&0<n.length?new RegExp(escapeRegExp(n),"i"):null;t?(p=[],m=[],e=e||t.getActionsSections(),T=e,pinegrow.getSelectedElement()?(t=e,A.showAssignedActions&&(t=[c].concat(e)),o="",$.each(t,function(e,t){var n,i;t.framework.show_in_action_tab==S&&(n=!0,d&&(n=t.name.match(d)),t!=c&&crsaPopulateSectionClosedStatus(t),p.push(t),i="",$.each(t.getComponentTypes(),function(e,t){t&&(i+=b(t,n))}),i.length||1)&&(o=(o=o+('<li data-section-index="'+(p.length-1)+'" class="'+"section"+(t.closed?" section-closed":"")+(t==c?" assigned-actions":"")+'"><div><h2>'+t.name+"<small> / "+t.framework.name)+"</small>"+'<i class="fa fa-caret-right closed"></i><i class="fa fa-caret-down opened"></i>'+"</h2></div>"+"<ul>")+i+"</ul></li>")}),l.get(0).innerHTML=o,_(),crsaHandleExternalLinks(l),new CrsaCollapsibleSections(l).show(v,C)):l.html('<div class="alert alert-info">Click on any element on the page to edit its actions or to add new HTML elements to the page.</div>')):T=null},C=function(e){var o=e=e||k;e.hasClass("crsa-panel")||(o=e.closest(".crsa-panel")),e.find("li.has-data").removeClass("has-data"),e.find("li.crsa-action").each(function(e,t){var n=$(t),i=(pgRemoveMultiselects(n),n.find(".action-fields").remove(),w(n));E?P(E,i)?(n.addClass("crsa-action-on"),g(M,i,n,o.children(".content")),n.closest(".section").addClass("has-data")):(n.removeClass("crsa-action-on"),f(n)):n.removeClass("crsa-action-on")}),e.find(".section").each(function(e,t){var n=$(t);n.find(">ul").get(0).childNodes.length?n.show():n.hide()})};(t=l.get(0)).addEventListener("mouseenter",function(e){var t,n,i=$(e.target);i.is("i.show-code")&&E&&(i=i.closest("li"),t=(n=w(i)).framework.get_preview_for_action(E,n),(n=crsaFuncs.createPreviewElementFromDefinition(n))?pinegrow.showPreview(i,n,"actions-preview",300,t):pinegrow.showPreview(i,$("<pre>"+escapeHtmlCode(t)+"</pre>"),"cm-preview actions-preview",300))},!0),t.addEventListener("mouseleave",function(e){$(e.target).is("i.show-code")&&pinegrow.hidePreview()},!0),t.addEventListener("contextmenu",function(e){var t,n,i,o,s,a=$(e.target);if(a.is("name")||a.parent().is("name"))return e.stopPropagation(),e.preventDefault(),n=a.closest("li"),t=w(n),n=new CrsaContextMenu(null,n),i=getElementName(x),o="<b>"+t.name+"</b>",x&&E?(P(E,t)?(n.add("Remove action from selected element",null,null,"header"),n.add("Remove "+o+" from <b>"+i+"</b>",null,function(){h(a)})):(n.add("Add action to selected element",null,null,"header"),n.add("Add "+o+" to <b>"+i+"</b>",null,function(){a.closest("name").click()}),t.not_placeable&&pgf.edit_html&&(n.add("",null,null,"divider"),n.add("Can't create new HTML element: "+t.not_placeable,null,null,"header"))),!t.not_placeable&&t.code&&pgf.edit_html&&(s=crsaFuncs.findActionMenuForInsertingDefIntoEl(t,E),n.add("",null,null,"divider"),n.add("Create new HTML element with this action",null,null,"header"),n.add("Prepend to <b>"+i+"</b>",null,function(){crsaFuncs.insertThroughActionMenu(s,x,t,!1,!0)}),n.add("Append to <b>"+i+"</b>",null,function(){crsaFuncs.insertThroughActionMenu(s,x,t,!1,!1)}),n.add("Insert before <b>"+i+"</b>",null,function(){crsaFuncs.insertBeforeOrAfter(x,t,!1,!1)}),n.add("Insert after <b>"+i+"</b>",null,function(){crsaFuncs.insertBeforeOrAfter(x,t,!1,!0)}),n.add("Replace <b>"+i+"</b>",null,function(){crsaFuncs.replaceElement(x,t)}))):pgf.edit_html&&n.add("First select an existing element on the page and then use the right click to place the new element.",null,function(){},"header"),n.showAt(e.pageX,e.pageY),!1},!0),h=function(e,r){var c,d,u=e.closest("li"),h=w(u),t=u.position().top,p=pinegrow.getCollection(),n=(p.forEachElement(function(e,t,n){var i,o,s,a,l;e&&(i=e.getName(),o=new pgParserSourceProblem(e,null,!!h.ignore_lock),s=e.getPage(),e||o.add("element",i,"change"),o.ok()?P(e,h)?r?0==t&&pinegrow.showQuickMessage('Use <i class="fa fa-times"></i> icon to remove the action from the element.',4e3,!1,"error"):canMakeChange(e,"remove_action",h)&&(willMakeChange(s,"Remove action / "+h.name),d="Remove action / "+i,l=$.fn.crsa("removeActionFromElement",e,h,s),c=c||"Action <b>"+h.name+"</b> was removed from <b>"+p.getName()+"</b>",l!=e&&!1||(f(u),u.removeClass("crsa-action-on"))):(a=!0,(a=!h.on_can_add_action||h.on_can_add_action(e,s,h)?a:!1)&&canMakeChange(e,"add_action",h)&&(willMakeChange(s,"Add action / "+i),d="Add action / "+h.name,c=c||"Action <b>"+h.name+"</b> was added to <b>"+p.getName()+"</b>",(l=$.fn.crsa("addActionToElement",e,h,s))!=e&&!1||(g(M,h,u,u.closest(".content")),u.addClass("crsa-action-on")),pinegrow.stats.using("action."+h.type||"unknown"))):showAlert(o.toString(),"Can't edit this element"))}),u.closest(".assigned-actions").length?C():(_(),C(l.find(".assigned-actions"))),u.position().top),i=u.closest(".content"),o=i.scrollTop();i.scrollTop(o-=t-n),pinegrow.changeManager.didChange(p,d),pinegrow.showQuickMessage(c)},t.addEventListener("click",function(e){var t,n,i,o=$(e.target);o.is("i.show-code")?E&&(t=pinegrow.getSelectedPage(),n=o.closest("li"),i=w(n),pinegrow.hidePreview(),e.preventDefault(),e.stopImmediatePropagation(),t.callFrameworkHandler("on_action_show_code_clicked",E,i,n)):o.is("i.remove-action")?(h(o),e.preventDefault(),e.stopImmediatePropagation()):o.is("i.action-magic")?E&&(t=pinegrow.getSelectedPage(),n=o.closest("li"),i=w(n),e.preventDefault(),e.stopImmediatePropagation(),E&&P(E,i)?t.callFrameworkHandler("on_action_magic_clicked",E,i,n):t.callFrameworkHandler("on_action_magic_preview_clicked",E,i,function(e){e&&pinegrow.showPreview(n,e,"actions-preview",300)})):(o.is("name")||o.parent().is("name"))&&(e.preventDefault(),e.stopImmediatePropagation(),h(o,!0))},!0),y(),i.on("input",function(){y()})}},pgWindowManager=function(e,t,n){this.win=e,this.name=t,640==e.width&&480==e.height&&n&&n(e)},pgPageTabs=function(e){var i,o=[],s=$('<div class="file-tabs"><ul></ul></div>'),a=s.find("ul"),l=!1,r=!0,c=(s.prependTo(e).hide(),this.addPage=function(e){o.push(e),c()},this.removePage=function(e){for(var t=o.indexOf(e),n=(o.splice(t,1),null),i=0;i<o.length;i++)if(o[i].visible){n=!0;break}!n&&o.length&&d(o[0],0),c()},this.updateDisplay=function(){c()},this.getHeight=function(){return l?39:0},this.updateHasChangesStatus=function(e){var n=e.hasChanges()?" *":"";a.find('li[data-url="'+e.url+'"]').each(function(e,t){$(t).find(">span").html(n)})},function(){a.html("");for(var e=0;e<o.length;e++){var t=o[e],n=$('<li data-url="'+t.url+'">'+t.tab_name+"<span>"+(t.hasChanges()?" *":"")+"</span></li>").appendTo(a).data("page-index",e);t.visible&&n.addClass("active"),t.live_update&&n.addClass("view")}(i=a.find("li")).on("click",function(e){e.preventDefault();var t=$(e.delegateTarget),t=o[t.data("page-index")],n=!0;e.ctrlKey||e.metaKey||(n=!1,h(t),r&&(crsaQuickMessage("CMD/CTRL + Click to show multiple pages",3e3),r=!1)),(n&&t.visible?u:d)(t),t.rememberWidth||$.fn.crsapages("refresh")}),l!=(l=1<o.length?(s.show(),!0):(s.hide(),!1))&&$.fn.crsapages("refresh")}),d=function(e,t){var n;void 0===t&&(t=o.indexOf(e)),i&&($(i.get(t)).addClass("active"),e.show(),n=null,e.selected_element_pgid&&(n=e.getElementWithPgId(e.selected_element_pgid)),pinegrow.selectElement(n),pinegrow.setSelectedPage(e))},u=function(e,t){void 0===t&&(t=o.indexOf(e)),i&&($(i.get(t)).removeClass("active"),e.hide())},h=function(e){for(var t=0;t<o.length;t++){var n=o[t];n!=e&&u(n,t)}};this.showPage=function(e,t){t&&h(e),d(e),$.fn.crsapages("refresh")},this.hidePage=function(e){u(e),$.fn.crsapages("refresh")},this.hideAll=function(){h(),$.fn.crsapages("refresh")}},PgEditException=function(e,t,n){this.msg=e,this.reason=t,this.on_display=n,this.toString=function(){return this.msg}},PgBoxWithButton=function(e,t,n,i){function o(){r.animate({opacity:0},200,function(){r.detach(),d=!1,s&&s.destroy()})}var s,a=new PgButtonToolbarItem(e,i),l=a.$element,r=$('<div class="news-box"><h3>'+t+'<i class="icon-close close"></i></h3></div>'),c=!1,d=!1,u=this;crsaHandleExternalLinks(r);a.onClick=function(){var e;d?o():(c||((e="function"==typeof n?n():n)instanceof PgUIView?((s=e).get$Element().appendTo(r),s.alwaysVisible=!0,s.updateVisibility()):r.append(e),c=!0),l.closest("body").append(r),r.css("left",l.offset().left+l.outerWidth()-r.width()+"px").css("right","auto"),r.css("opacity",0).animate({opacity:1},200),d=!0,u.opened(),s&&s.onResize&&s.onResize())},r.find(".close").on("click",function(e){e.preventDefault(),o(),u.closed()}),this.getButton=function(){return a},this.get$Box=function(){return r},this.opened=function(){},this.closed=function(){}},PgNewsBox=function(){var i,e=new PgBoxWithButton("icon-cup","Articles &amp; News",'<div class="list"></div><div class="news-box-item"><a href="https://pinegrow.com/articles/" class="external" style="font-size: 12px;">More articles »</a></div><div class="news-box-item"  style="font-size: 12px;"><a href="https://www.getdrip.com/forms/8855293/submissions/new" class="external">Get new articles in your inbox »</a></div>',"Read news and articles"),t=e.get$Box(),n=(this.button=e.getButton(),this.button.$element.addClass("hide")),o=(crsaHandleExternalLinks(t,function(){pinegrow.stats.using("news.click")}),e.opened=function(){i=t.find("div.list"),o(s.list),localStorage.last_news_version=s.news_version,n.removeClass("has-news"),pinegrow.stats.using("news.show")},function(e){i.html("");for(var t=0;t<e.length;t++){var n=$('<div class="news-box-item"><a class="external" href="'+e[t].url+'">'+e[t].name+"<small>"+e[t].tag+"</small></a></div>");i.append(n)}}),s={list:[]};this.setData=function(e){(s=e).news_version!=(localStorage.last_news_version||0)&&n.addClass("has-news"),n.removeClass("hide").css("opacity",0).animate({opacity:1},1e3)}},pgGetOpenPartialInContainerInfo=function(e){var t=pinegrow.getCurrentProject();return t?t.getProjectInfo().getSettingForFile(e,"open_partial_wrapper"):null},pgOpenPartialInContainer=function(n,t,e){var i,o,s,a,l,r,c,d,u,h,p,g=!1,f=pinegrow.getCrsaPageByUrl(n);f?(pinegrow.showQuickMessage("Page is already open."),f.show(!0)):(c=crsaMakeFileFromUrl(n),f=pgGetOpenPartialInContainerInfo(c),f&&(l=f.url||"",r=f.selector||"",g=f.auto_open||!1),d=function(e,t){var n=e.closest(".form-group").find(".error");t?n.html(t).removeClass("hide"):n.html("").addClass("hide")},u=function(){var e=o?o.val():l;return e?require("url").resolve(n,e):null},h=function(){$("body").off("crsa-element-selected.openpartial")},p=function(){var e={wrapper_url:u(),wrapper_selector:r};pinegrow.openOrShowPage(n,t,!0,null,e)},!e&&g&&l&&r?(pinegrow.showQuickMessage("Opening as a partial file in a container. Use Right-click -&gt; Open as partial... to override.",4e3),p()):pinegrow.getComponent("open-partial",function(e){var t=e.html;o=(i=makeAndShowDialog("Open partial in container","Cancel","Open",t,function(){h()},function(){var e=pinegrow.getCurrentProject();e&&((e=e.getProjectInfo()).setSettingForFile(c,"open_partial_wrapper",{url:l,selector:r,auto_open:a.is(":checked")}),e.save()),p(),h()},function(){var e=!0;return l=$.trim(o.val()),r=$.trim(s.val()),d(o,null),d(s,null),l||(d(o,"File url or remote url is required."),e=!1),r||(d(s,"Selector is required. Use <b>body</b> if you have no other idea."),e=!1),e})).find(".input-url").val(l),s=i.find(".input-selector").val(r),a=i.find(".auto-open"),g&&a.prop("checked","checked"),d(o,null),d(s,null),o.closest(".form-group").find("a").on("click",function(e){e.preventDefault(),crsaChooseFile(function(e,t){e=crsaMakeLinkRelativeTo(e,n),o.val(e)},null,null,null,!1)}),s.closest(".form-group").find("a").on("click",function(e){e.preventDefault();var t=u();t?(pinegrow.openOrShowPage(t),$("body").off("crsa-element-selected.openpartial").on("crsa-element-selected.openpartial",function(e,t){var n;t&&(t.get$DOMElement(),(n=pgFindUniqueSelectorForElement(t,t.document))?s.val(n):pinegrow.showQuickMessage("Sorry, can't guess a unique selector."))})):pinegrow.showQuickMessage("Set the url first!",3e3,!1,"error")})}))},PgUILayoutControl=function(e){var o=$('<ul class="ui-lc"></ul>').appendTo(e),t=pinegrow.getSetting("ui-panel-layout","L,P,C,T").split(","),n={L:"Lib",P:"Page",T:"Tree"};t.forEach(function(e){e&&"C"!=e&&o.append($('<li data-panel="'+e+'">'+n[e]+"</li>"))}),o.sortable().on("sortupdate",function(e,t){var i=[],n=(o.children().each(function(e,t){var n=$(t).attr("data-panel");n&&i.push(n)}),i.join(","));pinegrow.setSetting("ui-panel-layout",n),$(window).trigger("resize")})},PgUILayoutControlBox=function(e,t){var n=new PgBoxWithButton(e,"th-large","Drag panels to rearrange them:",'<div class="control"></div>',"Rearrange UI panels"),i=n.get$Box().addClass("ui-lc-box"),o=(n.get$Button().addClass("ui-lc-button"),i.find("div.control")),s=null;n.opened=function(){s=s||new PgUILayoutControl(o)},i.find("a.settings").on("click",function(e){e.preventDefault(),t()})},PgTrialUpgradeBox=function(e){var t=new PgBoxWithButton("icon-276","Power-up with Pinegrow",'<p>Whether you’re a beginner or an advanced web developer / designer, Pinegrow will help you save time, expand your skills and make your workflow more efficient.</p><p>Get a copy of Pinegrow for yourself, risk-free, with our 30 days money-back guarantee.</p><p><a class="external btn btn-primary" href="https://pinegrow.com#buy">Buy Pinegrow</a></p>',"Power-up with Pinegrow");this.button=t.getButton(),this.button.$element.addClass("gift-button");t.get$Box().addClass("powerup-pg"),t.opened=function(){pinegrow.stats.using("app.gift")}},addTooltip=function(n,e,t){var i=n.closest("body"),i={container:i.length?i:"body",placement:"auto",html:!0,title:e,use_title_attr:!1,trigger:"hover",delay:{show:800,hide:100},close_delay:null},o=(t&&(i=$.extend(i,t)),"function"==typeof e&&(i.get_title_func=e,i.title="dummy"),i.class&&(i.template=`<div class="tooltip ${i.class}"><div class="tooltip-arrow"></div><div class="tooltip-inner"></div></div>`),n.tooltip(i),n.attr("data-has-tooltip",!0),n.on("mousedown",function(e){n.tooltip("hide")}),null),s=null===i.close_delay?"manual"===i.trigger?5e3:1e4:i.close_delay;return n.on("show.bs.tooltip",function(){var e=n.closest("body"),t=n.data("bs.tooltip");t.options.container=e.length?e:"body",t.options.use_title_attr&&(t.options.title=n.attr("string"==typeof t.options.use_title_attr?t.options.use_title_attr:"title")),t.options.get_title_func&&(t.options.title=t.options.get_title_func()),n.is(":visible")||(t.options.container=$("#tooltip-garbagebin")),s&&(o=setTimeout(function(){n.tooltip("hide"),o=null},s)),closeAllTooltips()}),n.on("hide.bs.tooltip",function(){o&&(clearTimeout(o),o=null)}),"manual"==i.trigger&&(closeAllTooltips(),n.tooltip("show")),n},closeAllTooltipsTimer=null,closeAllTooltips=function(e){closeAllTooltipsTimer&&clearTimeout(closeAllTooltipsTimer),closeAllTooltipsTimer=setTimeout(function(){pgGetAppWindows().forEach(function(e){$(e.window.document.body).find("[data-has-tooltip]").tooltip("hide")}),setTimeout(function(){pgGetAppWindows().forEach(function(e){$(e.window.document.body).find(".tooltip").remove()})},1e3),closeAllTooltipsTimer=null},e||3e4)},PgCodeEditors=function(){var n=[];this.register=function(e){e&&n.indexOf(e)<0&&n.push(e)},this.unregister=function(e){var t;e&&0<=(t=n.indexOf(e))&&n.splice(t,1)},this.forEachEditor=function(e){n.forEach(e)}},setLightDarkClassForEditor=function(e,t){e.removeClass("dark-theme"),0<=["ambiance","blackboard","mbo","midnight","monokai"].indexOf(t)&&e.addClass("dark-theme")},PgPositionElement=function(r,c,d,u){u=u||r.parent();function e(){var e,t,n=u,i=n.outerWidth(),o=n.outerHeight(),s=r.outerWidth(),a=r.outerHeight(),l=4;switch(c){case"left":e=l;break;case"right":e=i-s-l;break;case"center":e=(i-s)/2}switch(d){case"top":t=l;break;case"bottom":t=o-a-l;break;case"center":t=(o-a)/2}r.css({left:e+"px",top:t+"px",margin:"auto"})}e(),r.addClass("reposition-on-resize"),r.on("reposition",function(){e()})},PgPositionNextToRect=function(m,v,e,w,b,n){function t(){m.hasClass("reposition-on-resize")&&o(),e&&e.onResized&&e.onResized()}var $=m.parent(),_=null,i=pgGetFastdomTasks(m.get(0)).getUniqueKey(),o=function(){var t=n?pgGetFastdomTasks(m.get(0)).create(i):{measure:function(e){e()},mutate:function(e){e()}};t.measure(function(){var n="function"==typeof v?v():v,e=(_=n=n||_,$),i=e.outerWidth(),o=e.outerHeight(),s=m.outerWidth(),a=m.outerHeight(),l=(window.innerWidth,window.innerHeight),r=200,c=200,d=4,u=(null!=w&&(d=w),300),h=s,p=a,g=36,f=32;t.mutate(function(){var e,t;n&&("cover_right"==b?(h=Math.round(.33*i),p=o-g-f,r=i-h,c=g):"cover_left"==b?((h=Math.round(.25*i))<320&&(h=320),p=o-g-f,r=0,c=g):"cover_bottom"==b?(p=Math.round(.5*o),h=i,r=0,c=o-p):"center_bottom_inside"==b?(r=(i-s)/2,c=.9*o-a):"down"==b?(c=n.bottom+d,r=n.left,(r=i<r+s?n.right-s:r)<0&&(r=0),o<c+a&&(p=o-c-20)):"down_top_left"==b?(c=n.bottom+d,(r=n.left)<0&&(r=0),l<c+a&&(c-=a+n.height)):"down_no_resize"==b?(c=n.bottom+d,r=n.left,(r=i<r+s?n.right-s:r)<0&&(r=0),o<c+a&&(c=o-a)):b?(r=n.left,i<r+s&&(r=i-s),(c=n.top-d-a)<43?(c=43,m.addClass("sticky-top")):m.removeClass("sticky-top")):(e=i-(n.left+n.width+d),t=n.left-d,s<e?r=n.left+n.width+d:t<e?(r=n.left+n.width+d,h=Math.max(u,e)):r=s<t?n.left-s-d:d,c=n.top,n.top+a>o&&(c=o-a)<0&&(c=0,p=o),i<(r=r<0?0:r)+h&&(r=i-h))),c<g&&(c=g),r=Math.round(r),c=Math.round(c),m.css({left:r+"px",top:c+"px",margin:"auto",width:h+"px",height:p+"px"})})})};o(),m.addClass("reposition-on-resize");m.on("reposition",t),this.reposition=function(){t()},this.destroy=function(){m.off("reposition",t),m.removeClass("reposition-on-resize"),n&&pgGetFastdomTasks(m.get(0)).stopAll(i)}},PgPositionNextToPgel=function(e,t,n,i,o,s){var a=new PgPositionNextToRect(e,function(){return pinegrow.selectedElements.getElementRect(t)},n,i,o,s);this.destroy=function(){a.destroy()},this.reposition=function(){a.reposition()}},PgPositionNextTo$El=function(e,t,n,i,o,s){var a=new PgPositionNextToRect(e,function(){return t&&0<t.length?t.get(0).getBoundingClientRect():null},n,i,o,s);this.destroy=function(){a.destroy()},this.reposition=function(){a.reposition()}},PgPositionNextToPage$El=function(e,t,n,i,o,s,a){var l=new PgPositionNextToRect(t,function(){return e.get$ElGlobalRect(n)},i,o,s,a);this.destroy=function(){l.destroy()},this.reposition=function(){l.reposition()}},PgPositionManager=function(){var e=null;$(window).on("resize",function(){null!=e&&clearTimeout(e),e=setTimeout(function(){pgGetAppWindows().forEach(function(e){$(e.window.document).find(".reposition-on-resize").trigger("reposition")})},250)})},pgPositionManagerInstance=new PgPositionManager,PgAskAboutElements=function(t,o,s,a){var l=null;this.show=function(){function n(e){var t=pinegrow.getCrsaPageOfPgParserNode(e),n=(pinegrow.getSelectedPage()!=t&&pinegrow.showPage(t,!0),e.get$DOMElement());n?pinegrow.selectElement(n):t.refresh(function(){pinegrow.selectElement(e)})}var i=(l=makeAndShowDialog(s,null,null,o)).find(".modal-footer"),e=(a.forEach(function(t){var e=$('<button class="btn btn-'+(t.primary?"primary":"default")+' btn-sm" type="button">'+t.label+"</button>").on("click",function(e){e.preventDefault(),t.func&&t.func(t.action),l.remove()}).appendTo(i);t.tooltip&&addTooltip(e,t.tooltip)}),new PgPositionElement(l,"center","bottom",$("body")),n(t[0]),l.find("a[data-pg-select-element]"));e.on("click",function(e){e.preventDefault();var t=pgParserNodeCatalogueInstance.get($(e.delegateTarget).attr("data-pg-select-element"));t?(n(t),pinegrow.showQuickMessage("The element was selected in page view.")):pinegrow.showQuickMessage("Sorry, can't find this element in page view.")}),addTooltip(e,"Click to select the element in page view.")}},PgChooseFile=function(a,l){(l=l||{parent_url:null,save_as:null,folder:null,no_proxy:!0,no_url:!1,no_copy_to_folder:!1}).no_proxy=!0,crsaChooseFile(function(i,o){var t,e,s=l.parent_url||null;s?crsaIsFileUrl(s)?(e=(t=pinegrow.getCurrentProject())&&t.isUrlInProject(s)&&!t.isFileInProject(o),l.must_be_in_base_to_be_relative&&!i.startsWith(l.must_be_in_base_to_be_relative)||(i=crsaMakeLinkRelativeTo(i,s)),l.no_proxy||(i=pinegrow.getProxyUrl(i)),!crsaIsAbsoluteUrl(i)&&!e||l.no_url||l.no_copy_to_folder?a(i,o):pinegrow.showAlert("<p>Location of the file doesn't let us use a relative url. This can cause url to break when you upload the page to a server or if you open the page in a browser while Pinegrow is not running.</p><p>Would you like to copy the file in the same folder (or subfolder of folder) where your HTML page is located? Then Pinegrow can create relative urls that will work from wherever you open the page.</p>","The file is not located in the project folder","No, use absolute link","Yes, copy the file",function(){a(i,o)},function(){var n,e=crsaMakeFileFromUrl(crsaGetBaseForUrl(s));t&&(e=(n=t.getProjectInfo()).getSetting("file-picker-copy-folder")||e),crsaChooseFile(function(e,t){if(t!=o)try{crsaCopyFileSync(null,o,t),o=t,(!l.must_be_in_base_to_be_relative||e.startsWith(l.must_be_in_base_to_be_relative))&&(i=crsaMakeLinkRelativeTo(e,s)),!crsaIsAbsoluteUrl(i)||l.no_proxy||(i=pinegrow.getProxyUrl(i)),a(i,o),n&&(n.setSetting("file-picker-copy-folder",require("path").dirname(t)),n.save())}catch(e){pinegrow.showAlert("Could not copy file: "+e,"Error")}},require("path").basename(o),null,e)})):(l.no_proxy||(i=pinegrow.getProxyUrl(i)),a(i,o)):a(i,o)},l.save_as||null,null,null,l.folder||!1)},PgOverlayMessage=function(e,t,n){function i(){a&&(clearTimeout(a),a=null)}var o=this,s=(this.onClick=null,$('<div class="overlay-message"></div>')),a=(s.on("click",function(e){e.preventDefault(),o.onClick&&o.onClick()}),n&&addTooltip(s,n),s.html(e),e&&(s.appendTo($("body")),PgPositionElement(s,"center","center")),this.destroy=function(){s.remove()},null);this.hide=function(e){var t,n;i(),e?a=setTimeout(function(){o.hide()},"number"==typeof e?e:1e3):(t={opacity:0},this.$hideTowards&&(n=this.$hideTowards.get(0).getBoundingClientRect(),t.top=n.top+n.height/2-s.height()/2,t.left=n.left+n.width/2-s.width()/2),s.animate(t,250,function(){s.detach()}))},this.show=function(){i(),s.appendTo($("body")),PgPositionElement(s,"center","center"),s.css("opacity",0),s.animate({opacity:1},150,function(){})},this.clearDelayedHide=function(){i()},this.showIfHidden=function(){s.is(":visible")||this.show()},this.hideIfShown=function(){s.is(":visible")&&this.hide()},this.setMessage=function(e){s.html(e)},t&&setTimeout(function(){s.animate({opacity:0},250,function(){o.destroy()})},1e3)},pgGetDragMenu=function(){return $.fn.crsa("getDragMenu")},PgDragMenu=function(O,i,t,n,e,o){o=$.extend({disableClone:pgf.kids||!1,disableGrid:!1,disableRepeater:!1,disableDisableParentSelector:!1,disableText:!1,dragType:"html"},o||{}),this.dragType=o.dragType,$.fn.crsa("setDraggedMenu",this),pinegrow.selectedElements.temporaryHideMenus(),pinegrow.getAllPageViews().forEach(function(e){e.addHtmlClass("crsa-in-drag")});function s(e,t){i&&(t.alt?(h.removeClass("icon-moveitem").addClass("icon-duplicate"),N.clone=!0):(h.addClass("icon-moveitem").removeClass("icon-duplicate"),N.clone=!1)),n&&(t.shift?(pg$Hide(c),N.parentSelectorDisabled=!0):(pg$Show(c),N.parentSelectorDisabled=!1)),f&&f.setHighlight(t.cmdCtrl)}function a(n){pgGetAppWindows().forEach(function(e){var t=e.window.document.body;n?$(t).css("cursor",i?"move":"grab"):$(t).css("cursor","")})}function B(){return N.insertInText}var l=O.display_name&&e?e.tagName:O.name,r=$('<div class="factory-drag-helper"><div class="factory-drag-helper-inner"><div class="factory-drag-helper-inner-arrow"></div><i class="icon icon-import"></i><span>'+l+'</span> <span class="count" style="text-transform: none;">'+pinegrow.repeater.showLiveRepeatCount()+'</span><div class="help"><p class="clone">Hold '+pgShowKbd("ALT")+' to clone.</p><p class="parent_selector">Trying to insert into <b>'+(n||"")+"</b>. Hold "+pgShowKbd("SHIFT")+' to insert anywhere.</p><p class="grid-drop">Hold '+pgShowKbd("CMD")+' to target grid cells.</p><p class="drop-inside hl">Hold '+pgShowKbd("SHIFT")+' to drop inside collapsed.</p><p class="text-drop">Hold over text to insert into text.</p><p class="repeater">Type '+pgShowKbd("1")+" - "+pgShowKbd("9")+" to insert multiple copies.</p>\x3c!-- <p>"+pgShowKbd("ESC")+" to cancel.</p>--\x3e</div></div></div>").data("crsa-factory-def",O),c=r.find(".parent_selector"),d=(!n||o.disableDisableParentSelector?pg$Hide(c):pinegrow.showQuickMessage("Trying to insert into <b>"+(n||"")+"</b>. Press "+pgShowKbd("SHIFT")+" or use the tree to insert anywhere.",3e3),r.find(".drop-inside")),u=(pg$Hide(d),!1),h=(this.setDropInside=function(e){e!==u&&((e?pg$Show:pg$Hide)(d),u=e)},(o.disableGrid||1)&&pg$Hide(r.find(".grid-drop")),(o.disableRepeater||1)&&pg$Hide(r.find(".repeater")),!o.disableText&&document.caretRangeFromPoint||pg$Hide(r.find(".text-drop")),o.disableClone&&pg$Hide(r.find(".clone")),pgf.kids&&r.find(".text-drop").text("Drag me to the page or to the Structure panel."),t&&$("body").append(r),r.find("i.icon")),W=(this.addElement=function(e){r.append(e)},null),L=null,p=(this.getOver=function(){return W},this.setOver=function(e){W==e||"none"==e&&"tree"==W||(r.removeClass("over-lib over-page over-tree over-none"),r.addClass("over-"+e),W=e)},i?h.removeClass("icon-import").addClass("icon-moveitem"):r.find(".clone").remove(),this.element=null,this.position=null,this.positionElement=null,this.gridPosition=null,this.overInvalidParent=!1,this.elementDefinition=O,this.movedElement=null,this.parentSelectorDisabled=!1,this.pgel,this.positionPgel,this.movedPgel,this.insertInText=!1,this.selectNew="auto",this.forcePositionLabel=null,this.formatHtml=!1,this.clone=!1,this.getCount=function(){return pinegrow.repeater.getCount()},this.window=window,this.getWindow=function(){return this.window},this.setWindow=function(e){this.window=e},beforeElementMovedWithMouse(),!1),g=null,f=null,m=!0,N=(this.getGridOverlayControl=function(){return f},this.setOverGrid=function(e,t){var n;o.disableGrid||p!=e&&(n=r.find(".grid-drop"),e?(n.addClass("hl"),pg$Show(n),f&&g===t.get(0)||(f&&f.destroy(),(f=new PgCSSGridOverlayControl).show(t),g=t.get(0),m&&(pinegrow.showQuickMessage(`Hold ${pgShowKbd("CMD")} to target a grid cell.`),m=!1))):(f&&f.destroy(),g=null,n.removeClass("hl"),pg$Hide(n)),p=e)},this);this.get$Element=function(){return r},pinegrow.showUIPanel("tree",!1,!0),pinegrow.addEventHandler("on_key_state_changed",s),s(0,pinegrow.keyState),a(!0),this.move=function(e,t,n,i){var o;this.window!==n&&(o=$(i),(o=getPageViewOfElement(o))?(o=o.pageRectToGlobalRect({left:e,top:t}),e=o.left,t=o.top):(this.window=n,$(this.window.document.body).append(r))),fastdom.mutate(function(){r&&pg$PositionAt(r,Math.round(e),Math.round(t))})},this.destroy=function(){f&&f.destroy(),g=null,pinegrow.dispatchEvent("on_drag_drop_operation_done",null,this),r.remove(),pgGetAppWindows().forEach(function(e){$(e.window.document.body).find(".factory-drag-helper").remove()}),this.position=null,this.overInvalidParent=!1,pinegrow.removeEventHandler("on_key_state_changed",s),this.pgel=null,this.positionPgel=null,this.movedPgel=null,a(!1),$.fn.crsa("setDraggedMenu",null),pinegrow.selectedElements.restoreShowMenus(),pinegrow.getAllPageViews().forEach(function(e){e.removeHtmlClass("crsa-in-drag")}),pgAutoScrollManager.stopAll(),"tree"!=L&&pinegrow.undoShowUIPanel("tree")},this.get$Target=function(){return this.positionElement.nodeType&&3==this.positionElement.nodeType?$(this.positionElement.parentNode):this.positionElement},isApp();this.handleMoveEvent=function(e){t&&this.move(e.pageX,e.pageY,e.view,e.target),crsaFuncs.elementMovedWithMouse(e,this)},this.insert=function(){var e,n,i,t=!1,z=this.element,s=(this.overInvalidParent,this.positionElement,this.position),o=!1,a="auto"===this.selectNew?!this.movedPgel||this.clone&&pinegrow.selectedElements.isSelectedElement(this.pgel):this.selectNew;if("none"==W)return!1;if(!this.positionPgel)return!1;if(!this.onInsert||!this.onInsert.call(this)){if(this.pgel){if("img"===this.positionPgel.tagName&&"img"===this.pgel.tagName)if("inside-top"===s||"inside-bottom"===s)return n=this.pgel.getAttribute("src"),i=this.pgel.getAttribute("srcset"),n&&(e=pinegrow.selectedElements.isSelectedElement(this.positionPgel)?pinegrow.selectedElements.getCollection():new PgCollection(this.positionPgel),pinegrow.makeChanges(e,"Replace image",function(){e.forEachElement(function(e){var t=e.getPage().makeRelativeUrl(n);e.setAttribute("src",t),i?e.setAttribute("srcset",i):e.hasAttribute("srcset")&&e.removeAttribute("srcset")})})),e;var l=pinegrow.selectedElements.isSelectedElement(this.pgel),r=function(e,t,n){void 0===n&&(dorce=!1);var i=e.getPage();return t=t||N.positionPgel,n||N.clone||N.movedPgel&&i&&i!=t.getPage()?e.clone():e},c=this.pgel,d=c.getPage(),u=(O=d?d.getMainType(null,c):O,new PgCollection),h=this.clone?u:new PgCollection,p=this.positionPgel,g=!0,f=null;if(this.movedPgel){var m=[this.movedPgel];l&&(m=pinegrow.selectedElements.getCollection().getList());for(var v=0;v<m.length;v++){if(!this.clone&&(p.isDescendantOf(m[v])||("inside-top"==this.position||"inside-bottom"==this.position||B())&&m[v]==p)){g=!1,f="Can't move element into itself.";break}if(0<=["html","body","head"].indexOf(m[v].tagName)){g=!1,f="Can't move "+m[v].tagName+" element.";break}}}if(p&&"html"==p.tagName&&0<=["top","bottom","left","right"].indexOf(this.position)&&(g=!1,f="Can't place elements outside of the page."),g||pinegrow.showQuickMessage(f,4e3,!1,"error"),g){t||!this.pgel.parent||canMakeChange(this.pgel.parent,"insert_element",{inserted:c})||(t=!0);var w=null;if(B())w=this.positionPgel;else switch(w=this.positionPgel,s){case"top":case"left":case"bottom":case"right":w=w.parent}var b,$=w.getPage();if(canMakeChange(w,"insert_element",{inserted:c})){willMakeChange($,"Add to page / "+this.pgel.getName());var _=this.getCount(),y=function(){N.morePgels&&N.morePgels.forEach(function(e){(e=e.clone()).insertAfter(H),u.add(e),H=e})};if(B()){var d=N.positionPgel,C=getPgNodeForTextNode(N.positionTextNode);if(C){var P=crsaSplitCharsInArray(C.content),k=d.html(null,!0),S=c=r(c,C,null!==N.movedPgel);if(c.withoutEvents(function(){var e;P.length<=s?c.insertAfter(C):(e=pgCreateNodeFromHtml(crsaGetCharArraySubstring(P,s,P.length)),C.content=crsaGetCharArraySubstring(P,0,s),c.insertAfter(C),e.insertAfter(c),0==C.content.length&&C.remove())}),N.clone||c.removeFromDOM(),d.updateInner(k),h.add(c),y(),1<_)for(var R=2;R<=_;R++){var T=c.clone();T.insertAfter(S),u.add(T),S=T,y()}l&&pinegrow.selectedElements.forEachSubsequentElementOrderedByDocumentPosition(N.pgel,function(t){var n=!1;if(h.forEachElement(function(e){t.isDescendantOf(e)&&(n=!0)}),!n){(t=r(t,S)).insertAfter(S),S=t,h.add(t);for(var e=2;e<=_;e++){var i=t.clone();i.insertAfter(S),u.add(i),S=i}}}),w=N.positionPgel}(pinegrow.selectedElements.isInSelectedElement(d)||pinegrow.selectedElements.isSelectedElement(d))&&pinegrow.showQuickMessage("Inserting into text of multiple selected elements is not supported.",5e3)}else{var E=this.positionPgel;if(t||c&&E||(t=!0,showAlert("The element can't be placed here because the destination is a dynamic element, created by Javascript code.","Can't put it here")),"body"==E.tagName&&"inside-bottom"==s&&"script"!=c.tagName){for(var x=null,v=E.children.length-1;0<=v;v--)if(E.children[v].isElement){if("script"!=E.children[v].tagName)break;x=E.children[v]}x&&(E=x,s="top")}function F(e,t,n){var i=N.positionPgel;switch(n){case"top":case"left":e.insertBefore(t),i=i.parent;break;case"bottom":case"right":e.insertAfter(t),i=i.parent;break;case"inside-top":t.prepend(e);break;case"inside-bottom":t.append(e)}return i}function M(e){if(1<_)for(var t=2;t<=_;t++){var n=e.clone();n.insertAfter(H),H=n,u.add(e),y()}}var A,I,D=E.tagName,V=-1,k=pinegrow.selectedElements.isInSelectedElement(E),w=(k&&(A=k.findIncludingSelf(D).indexOf(E),this.movedPgel)&&(I=this.movedPgel.tagName,V=k.findIncludingSelf(I).indexOf(this.movedPgel)),!k&&pinegrow.selectedElements.isSelectedElement(E)&&(k=E,D="*",A=0),c=r(c,E),F(c,E,s)),H=((c===this.movedPgel?h:u).add(c),c);y();M(c),k&&0<=A&&pinegrow.selectedElements.forEachSubsequentElement(k,function(e){var t,n,i,o="*"==D?[e]:e.findIncludingSelf(D);A<o.length&&(e.getPage(),o=o[A],t=null,(t=0<=V&&(i=e.findIncludingSelf(I)).length>V?i[V]:t)?(n=t,h.add(t)):(n=c.clone(),u.add(n)),F(n,o,s),M(H=n),a=!1)}),l&&pinegrow.selectedElements.forEachSubsequentElementOrderedByDocumentPosition(this.pgel,function(t){var n=!1;h.forEachElement(function(e){t.isDescendantOf(e)&&(n=!0)}),n||((t=r(t,H)).insertAfter(H),H=t,h.add(t),M(t))})}(o=!0)&&(this.inserted_elements=u,this.moved_elements=h,pinegrow.dispatchEvent("on_inserted_with_dragdrop",null,this),pinegrow.changeManager.batchChanges(function(){N.onInsertedElements&&N.onInsertedElements.call(N,u),N.onMovedElements&&N.onMovedElements.call(N,h),u.getLength()&&pinegrow.changeManager.didInsert(u,N.elementDefinition,N.formatHtml),h.getLength()&&h!=u&&pinegrow.changeManager.didMove(h,$,$)},"Drag and drop"))}a?(b=this.pgel,crsaIsInEdit()&&!canMakeChange(b,"edit_content",null,!0)||setTimeout(function(){pinegrow.selectElement(b),b.scrollTo()},10)):pinegrow.selectedElements.reselect()}}return z&&t&&this.pgel.remove(),elementUnderMouse=null,o&&(pinegrow.repeater.repeatDone(),L=W),o}}},PgRepeater=function(o){var n=this,s=1500,a=1,l=0,r=!0;this.getCount=function(){return a||1};function c(e){t(),o.setMessage("&times; "+a),n.$element.html("&times; "+n.getCount()),e&&o.showIfHidden(),a<=1?(r||o.hide(s),n.$element.parent().removeClass("active")):(o.clearDelayedHide(),n.$element.parent().addClass("active"))}(o=new PgOverlayMessage(null,!1,"Repeat the next insert action &times; times. Click here to clear the repeater.")).onClick=function(){n.done()},this.$element=$('<div class="pg-repeater"></div>'),r||(o.$hideTowards=this.$element);var t=function(){$(".repeater-count").each(function(e,t){t.innerHTML=1<a?"&times; "+a:""})},d=null,u=!1;this.keyPressed=function(e){var t,n,i;return!(!pgf.edit_html||pgf.kids||e.ctrlKey||e.metaKey||e.altKey||(t=u&&("Backspace"==e.key||"Delete"==e.key),n=function(e){if(1==e.key.length){var t=e.key.charCodeAt(0)-48;if(0<=t&&t<=9)return t}return-1}(e),!(t||0<=n))||(u=!0,a=t?Math.floor(a/10):(i=(new Date).getTime())-l<s?10*a+n:n,l=i,100<a&&(a=100,pinegrow.showQuickMessage("That would take too long! 100 is max.",3e3,!0)),a<1&&(a=1),c(!0),d&&clearTimeout(d),d=setTimeout(function(){r||o.hide(),d=null,u=!1},s),0))},this.repeat=function(e,t){t=t||e;for(var n=0;n<a;n++)if(e||0!=n)if(!1===(0==n?e:t)(n,a))break},this.repeatDone=this.done=function(){a=1,c(),o.hide(),u=!1,d&&(clearTimeout(d),d=null)},this.repeatOthers=function(e){this.repeat(null,e)},this.showLiveRepeatCount=function(){return'<span class="repeater-count">'+(1<a?"x "+a:"")+"</span>"},this.addToToolbar=function(e){var t=e.addSection("repeater");t.$element.append(this.$element),c(),addTooltip(t.$element,"Repeat action &times; times. Type a number anywhere in the app to set. Type "+pgShowKbd("1")+" or "+pgShowKbd("0")+" to reset."),t.$element.on("click",function(e){e.preventDefault(),1===n.getCount()?pinegrow.showQuickMessage("Type a number to set the repeater."):n.done()})}},PgKeyState=function(s){this.shift=!1,this.alt=!1,this.cmdCtrl=!1,this.ctrl=!1,this.double_key=!1;var a=0,l=null;this.keyChanged=function(e){var t="mac"==s?e.metaKey:e.ctrlKey,n=e.ctrlKey,i=("win"==s&&e.altKey&&(n=!1),e),o=(e.originalEvent&&(i=e.originalEvent),(new Date).getTime());l===e.key&&o-a<500&&!0!==i.repeat?this.double_key=e.key:this.double_key=!1,a=o,l=e.key,this.update(e.shiftKey,e.altKey,t,n)},this.update=function(e,t,n,i,o){this.shift===e&&this.alt===t&&this.cmdCtrl===n&&this.ctrl===i||(this.shift=e,this.alt=t,this.cmdCtrl=n,this.ctrl=i,pinegrow.dispatchEvent("on_key_state_changed",null,this))}},PgSearchBox=function(n){function i(){t=a.getValue(),s.onSearch&&s.onSearch(t),o&&!n.toolbar_on&&(t.length?o.show():o.hide()),t.length?(pg$Show(c),pg$Hide(r)):pg$Hide(c),d=null}var o,e={input_type:"text",placeholder:"find text or selector",placeholder_active:pgf.kids?null:"find text or selector ($... to force sel)",toolbar_on:!1,delay:!1,delay_time:500,search_on_input:!0},n=$.extend(e,n||{}),t="",s=this,a=(this.onSearch=function(e){},this.$element=$("<div></div>",{class:"pg-search-box"}),new PgInputField("search",{type:n.input_type||"text",show_empty:!1,name:"Search",without_text:!0,slider_def_unit:"",placeholder:n.placeholder,get_menu_options:n.input_get_menu_options||null,menu_no_not_set_option:n.input_menu_no_not_set_option||null})),l="text"==n.input_type?"input":"change",r=(a.appendTo(this.$element),$('<i class="icon field-icon-infield icon-search"></i>')),c=(n.no_search_icon||r.appendTo(a.$field),$('<i class="icon field-icon-infield icon-close"></i>').appendTo(a.$field)),d=(pg$Hide(c),c.on("click",function(e){e.preventDefault(),s.setValue("")}),null);a.on(l,function(e){var t="function"==typeof n.search_on_input?n.search_on_input():n.search_on_input;t&&(d&&(clearTimeout(d),d=null),n.delay?d=setTimeout(i,n.delay_time):i())}),a.on("keydown",function(e){13==e.which&&i()}),a.on("focus",function(){a.$input.attr("placeholder",n.placeholder_active||n.placeholder),pg$Hide(r)}),a.on("blur",function(){a.$input.attr("placeholder",n.placeholder),0===t.length&&pg$Show(r)});this.getToolbar=function(){return o||((o=new PgButtonToolbar).$element.appendTo(this.$element),n.toolbar_on)||o.hide(),o},this.addIcon=function(e){var t;if(this.getToolbar(),e)return t=new PgButtonToolbarItem(e.icon,e.label,e),o.addItem("icons",t),t.onClick=function(){e.func(t)},t},this.focus=function(){a.$input.get(0).focus()},this.setValue=function(e){t=e,a.$input.val(e).trigger(l),e||pg$Show(r)},this.getValue=function(){return a.$input.val()},this.getInput=function(){return a},this.destroy=function(){d&&(clearTimeout(d),d=null)}},PgSearchBoxSpacer=function(){this.$element=$("<div></div>",{class:"pg-search-box-spacer"})},PgButtonToolbar=function(e){var i=[],o={},s=0;this.$element=$('<div class="pg-button-toolbar"></div>'),e&&this.$element.addClass("pg-button-toolbar-small"),this.getSection=function(e){return o[e]||null},this.addSection=function(e,t){var n=$('<div class="pg-button-toolbar-section '+e+'"></div').appendTo(this.$element),n=(t&&n.css("flex-direction","row-reverse"),{key:e,items:[],$element:n});return i.push(n),o[e]=n},this.addItem=function(e,t){var n=this.getSection(e)||this.addSection(e);n.items.push(t),n.$element.append(t.$element),t.section=e,s++,this.updateCount()},this.removeItem=function(e){var t=this.getSection(e.section),n=t.items.indexOf(e);0<=n&&t.items.splice(n,1),e.$element.remove(),s--,this.updateCount()},this.showSection=function(e){var t=this.getSection(e);pg$Show(t.$element,"inline-flex")},this.hideSection=function(e){var t=this.getSection(e);pg$Hide(t.$element)},this.show=function(){this.$element.show()},this.hide=function(){this.$element.hide()},this.updateCount=function(){this.$element.attr("data-items",s)},this.destroy=function(){i.forEach(function(e){e.destroy()}),this.$element.remove()}},PgButtonToolbarItem=function(e,t,n,i){var o,s=this,a=!1;this.dontHandleClicks=!1,this.data=n,"string"==typeof e?(o=e.startsWith("<")?e:'<i class="icon '+e+'"></i>',this.$element=$('<div class="pg-button-toolbar-item">'+o+"</div>")):this.$element=$('<div class="pg-button-toolbar-item"></div>').append(e),(!o||0<=o.indexOf("<span"))&&this.$element.addClass("has-text"),t&&setTimeout(function(){addTooltip(s.$element,t)},1),this.onClick=function(){},this.onContextClick=function(){},this.onCarretClick=function(){},i&&($('<i class="icon icon-down carret"></i>').appendTo(this.$element).on("click",function(e){e.preventDefault(),e.stopPropagation(),s.onCarretClick.call(s)}),this.$element.addClass("with-carret")),this.$element.on("click",function(e){if(!s.dontHandleClicks)return e.preventDefault(),e.stopPropagation(),$(this).data("pg-menu")||pgCloseContextMenus(),s.onClick.call(s),!1}),this.$element.on("contextmenu",function(e){return e.preventDefault(),e.stopPropagation(),s.onContextClick.call(s),!1}),this.setActive=function(e){(a=e)?this.$element.addClass("active-item"):this.$element.removeClass("active-item"),this.$element.addClass("active-toggle")},this.getActive=function(){return a},this.show=function(){pg$Show(this.$element,"inline-block")},this.hide=function(){pg$Hide(this.$element)},this.setLabel=function(e){this.$element.find("span").html(e)},this.setTooltip=function(e){addTooltip(s.$element,e)}},PgToolbarTabButtons=function(s,a){function l(){o(this),r.onTabSelected&&r.onTabSelected(this)}var r=this,c=(s.addSection(a),[]),i=null,o=function(e){i&&i.setActive(!1),e&&e.setActive(!0),i=e};this.setActive=o;this.findTabWithData=function(e){for(var t=0;t<c.length;t++)if(c[t].data==e)return c[t];return null},this.findTabWithFilter=function(e){for(var t=0;t<c.length;t++)if(e(c[t]))return c[t];return null},this.addTab=function(e,t,n,i){var o=new PgButtonToolbarItem("<span>"+e+'</span><i class="icon icon-close"></i>',t,n);return s.addItem(a,o),o.onClick=l,o.$element.find("i.icon-close").on("click",function(e){return r.removeTab(o),!1}),c.push(o),i&&l.call(o),o.setClosable=function(e){return e||(o.$element.find(".icon-close").remove(),o.$element.addClass("without-close")),o},o},this.selectTab=function(e){l.call(e)},this.removeTab=function(e){this.onTabClosed&&this.onTabClosed(e),s.removeItem(e);var t=c.indexOf(e);if(0<=t&&c.splice(t,1),e==i){e=c[Math.min(c.length-1,t)];for(var n=!1;e.tabHidden;){if(--t<0){if(n){e=c[0];break}t=c.length-1,n=!0}e=c[Math.min(c.length-1,t)]}o(e),r.onTabSelected(i)}},this.getTabs=function(){return c},this.hideTab=function(e){e.tabHidden=!0,pg$Hide(e.$element)},this.showTab=function(e){e.tabHidden=!1,pg$Show(e.$element)},this.isTabVisible=function(e){return e.$element.is(":visible")},this.getActiveTab=function(){return i}},PgButtonToolbarItemWithDropdown=function(e,t,n,i){function o(){var t=new CrsaContextMenu(null,a.toolbarItem.$element);a.onBeforeShow.call(a,t),s.forEach(function(e){t.add(e)}),t.showForElement(a.toolbarItem.$element,null,8)}var s=[],a=this;this.addAction=function(e,t,n,i){s.push("object"==typeof e?e:{label:e,action:t,check:n,show_filter:i})},this.clearActions=function(){s=[]},this.onBeforeShow=function(){},this.toolbarItem=new PgButtonToolbarItem(e,t,n,i);this.toolbarItem.onClick=function(){i||o()},this.toolbarItem.onContextClick=function(){o()},this.toolbarItem.onCarretClick=function(){o()}},PgButtonToolbarItemWithDropdownView=function(e,t,n){var i,o,s=this,a=null;this.$element=null,this.closeButton=!0,this.onGetView=function(){},this.onShown=function(){},this.toolbarItem=new PgButtonToolbarItem(e,t,n),this.toolbarItem.onClick=function(){a?s.close():(i=s.toolbarItem.$element.closest("body"),s.$element=$('<div class="pg-quick-dropdown"></div>').appendTo(i),s.closeButton&&$('<i class="icon icon-close"></i>').appendTo(s.$element).on("click",function(e){e.preventDefault(),s.close()}),((a=s.onGetView(s)).view.quickWin=s).$element.append(a.view.get$Element()),a.view.alwaysVisible=!0,a.view.updateVisibility(),s.onShown&&s.onShown(s),o=new PgPositionNextTo$El(s.$element,s.toolbarItem.$element,null,0,"down"),a.onResized&&a.onResized())},this.autoResize=function(e){var t=a.view.get$Element().height();this.$element.css({height:(t=e&&t<e?e:t)+36+"px"})},this.close=function(){a&&(o.destroy(),a.view.destroy(),s.$element.remove(),a=null)}},PgZoomControl=function(){function e(e){var t=l(),t=(t+=e)%10==0?t:10*Math.floor(t/10);i.setValue((t=t<=10?10:t)+"%"),o(t)}var t=this,n="fit",n=pinegrow.getSetting("view-zoom",n),i=new PgInputField("zoom",{type:"select",show_empty:!1,name:"Zoom",without_text:!0,slider_def_unit:"",can_add_items:!0,append_new_to_list:!1,options:function(){for(var e=[{key:"fit",name:"Fit"}],t=10;0<t;t--)e.push({key:10*t,name:10*t+"%"});return e}}),o=(i.setValue(n),i.setWidth(30),function(e){n=e||i.getValue(),t.onSetSize&&t.onSetSize(n),pinegrow.getAllPages().forEach(function(e){e.view.updateSize()}),pinegrow.setSetting("view-zoom",n)}),s=(i.on("change",function(){o()}),new PgButtonToolbarItem("icon-minus-circle","Zoom out "+pgShowKbdCombo("CMD+-")+"<br>Press "+pgShowKbdCombo("CMD+0")+" to reset.")),a=new PgButtonToolbarItem("icon-plus-circle","Zoom in "+pgShowKbdCombo("CMD+PLUS")+"<br>Press "+pgShowKbdCombo("CMD+0")+" to reset."),l=(a.onClick=function(){e(10)},s.onClick=function(){e(-10)},this.addToToolbar=function(e){e.addSection("zoom"),e.addItem("zoom",s),e.addItem("zoom",a),s.$element.addClass("zoom-out"),a.$element.addClass("zoom-in"),i.$field.insertAfter(s.$element)},this.zoomOut=function(){e(-10)},this.zoomIn=function(){e(10)},this.zoomReset=function(){i.setValue("100%"),o(100)},this.getZoom=function(){var e;return"fit"==n?n:1e3<(e=(e=parseInt(n))<=0?1:e)?1e3:e},function(){var e;return"fit"==n?(e=pinegrow.getSelectedPage())?100*e.view.currentZoom:100:parseInt(n)})},pgCurrentContextMenu=null,pgCloseContextMenus=function(){var e=!1;return pgCurrentContextMenu&&(pgCurrentContextMenu.close(),e=!0),pgCurrentContextMenu=null,e},pgMakeParentContextMenusTransparent=function(e){e?$("body").addClass("pg-transparent-context-menus"):$("body").removeClass("pg-transparent-context-menus")},CrsaContextMenu=function(e,i,c){var d,u,h,p,g,f,m,v=this,w=(c||i&&i.data("pg-menu")||pgCloseContextMenus(),this.open_submenu=null,this.submenu_open_on_left=!1,this.actions=e||[],this.$target,this.targetPgel,this.$clicked=i,this.$element=i,this.closeOnMouseOut=!1,this.keepOpenOnClick=!1,this.allowRightClick=!1,this.ignore_mouseenter_on_show=!1,!1),b=(this.onClosed=null,this.add=function(e,t,n,i,o,s,a){return"object"==typeof e?this.actions.push(e):this.actions.push({label:e,kbd:t,action:n,type:i=i||"link",data:o,check:s,onShow:a}),this.actions[this.actions.length-1]},this.addMany=function(e){e.forEach(function(e){v.actions.push(e)})},$("body")),_=document,y=window,t=(i&&null===getIframeOfElement(i)&&(b=i.closest("body"),_=i.get(0).ownerDocument,y=_.defaultView),this.set$Body=function(e){b=e},this.setDocument=function(e){_=e},null),n=(this._ignore_mouseenter=!1,null);this.ignoreMouseenterForAMoment=function(){n&&clearTimeout(n),n=setTimeout(function(){v._ignore_mouseenter=!1},100),this._ignore_mouseenter=!0},this.closed=!1,this.close=function(e){t&&(clearTimeout(t),t=null),v.closed=!0,v.$clicked&&v.$clicked.removeClass("has-menu"),d&&(pgRemoveMultiselects(d),d.remove()),d=null,this.positioner&&(this.positioner.destroy(),this.positioner=null),c||$(_).off(".crsamenu"),h&&h.off(".crsamenu"),u&&(u.remove(),u=null),v.$element&&v.$element.data("pg-menu",0),v.onClosed&&v.onClosed(),c&&(c.open_submenu=null,i&&i.removeClass("hovered"),e&&c.close(!0),c.$menu_ul.removeClass("has-open-submenu"),v.parent_action.on_submenu_close)&&v.parent_action.on_submenu_close(),v.open_submenu&&v.open_submenu.close(),pgCurrentContextMenu==v&&(pgCurrentContextMenu=null),this.mover&&this.mover.destroy(),pgPreview.hide(),crsaFuncs.showInsertionLine(null),pgMakeParentContextMenusTransparent(!1)},this.closeSubmenus=function(){v.open_submenu&&v.open_submenu.close()},this.isMouseOverOrSubmenuOpen=function(){return w||this.open_submenu},this.addSmartInput=function(i,e){(i=i||new PgSmartInputForMenu(e)).onUpdated=function(){v.mover&&(v.mover.update("dummy"),v.mover.selectFirstItem())},this.actions.splice(0,0,{type:"smartinput",input:i,on_menu_shown:function(){i.focus();var e=v.mover=new PgArrowsMover(i.field.$input,d,"> li:not(.smartinput,.divider,.header)"),s=(e.select_first=!0,e.onEnter=function(e,t){var n=e.find("> a").data("action");n&&n.action.call(n,v.targetPgel,t,e,n.data),v.keepOpenOnClick?i.setValue(""):v.close(!0)},null),a=null;e.onSelected=function(e,t,n){var i,o;s&&(s.on_mouseleave&&s.on_mouseleave.call(s,a,n),a=s=null),e&&e.length&&((o=(i=e.find("> a")).data("action"))&&o.on_mouseenter&&o.on_mouseenter.call(o,i,n),s=o,a=i)}}},{type:"divider"})},this.showForElement=function(e,t,n,i,o){n=n||0,i=i||0;var s,a=e.data("pg-menu");a?a.close():(this.$element=e,b=e.closest("body"),_=e.get(0).ownerDocument,e.data("pg-menu",this),a=e.offset(),s=e.height(),this.showAtInternal(a.left+i,a.top+s+n,t,o),this.updatePosition())},this.showAt=function(e,t,n){i&&i.data("pg-menu")?i.data("pg-menu").close():(i&&(i.data("pg-menu",this),n=n||i.closest("body")),this.showAtInternal(e,t,n))},this.showAtPgel=function(e){this.showAt(0,0),this.positioner=new PgPositionNextToPgel(d,e,null),this.updatePosition()},this.showActions=function(e){this.ignoreMouseenterForAMoment(),d.find("> li:not(.smartinput)").remove(),$.fn.crsa("buildActionsDropDownMenu",e,this.targetPgel,d,this.close,this),this.updatePosition()},this.showAtInternal=function(e,t,i,n){var o,s,a,l,r=this.pos_checked_at_mouse||!1;if(0!==this.actions.length)return c&&(c.open_submenu=this),v.$clicked&&v.$clicked.addClass("has-menu"),c||$(_).trigger("click"),this.ignore_mouseenter_on_show&&this.ignoreMouseenterForAMoment(),d=$('<ul class="dropdown-menu context-menu" role="menu"></ul>'),$.fn.crsa("buildActionsDropDownMenu",this.actions,this.targetPgel,d,this.close,this),this.allowRightClick&&d.addClass("pg-allow-right-click"),this.$menu_ul=d,this.onBeforeMenuShown&&this.onBeforeMenuShown(),b.append(d),this.inModal&&d.css("z-index",2e3),n&&(o=n(d,e,t))&&(e=o.x,t=o.y),this.in_dialog&&d.css("zIndex",2e3),d.css("top",t+"px").css("left",e+"px"),a=t,o=e,"ontouchstart"in _.documentElement&&(u=$('<div class="dropdown-backdrop"/>').insertBefore(d).on("click",this.close)),d.on("click",function(e){$(e.target).closest(".crsa-field")||(e.preventDefault(),v.close())}).on("contextmenu",function(e){if(!v.allowRightClick)return v.close(),!1}),c&&d.on("mouseleave",function(){v.open_submenu||v.close(),w=!1}),d.on("mouseleave",function(){v.closeOnMouseOut&&!v.open_submenu&&v.close(),w=!1}),d.on("mouseenter",function(){w=!0}),c||$(_).off(".crsamenu").on("click.crsamenu",function(e){$.contains(d.get(0),e.target)||v.close()}),i&&(i.off(".crsamenu").on("scroll.crsamenu",function(e){var t=a+(p-i.scrollTop()),n=(d.css("top",t+"px"),0);t<g&&(n=g-t-2)<0&&(n=0),d.css("clip","rect("+n+"px, "+m+"px, "+f+"px, 0px)")}),p=i.scrollTop(),g=i.offset().top),h=i,d.data("menu",this),d.show(),f=d.outerHeight(),m=d.outerWidth(),s=$(y).height(),l=!1,r&&(0===(r=d.find("i.check-icon.icon-check:visible").first().closest("li")).length?0:(r=r.position(),l=!0,(a=a-r.top-10)<(r=0)&&(r=-a,a=0),s<a+f&&(f=s-a),d.css({top:a+"px",left:(o-=10)+"px",overflowY:"auto",height:f+"px"}),0!==r&&d.scrollTop(r))),(i||1)&&(!l&&s<a+f&&((a=s-f)<0?(a=0,d.css({top:a+"px",height:s+"px",overflowY:"auto"})):d.css("top",a+"px")),(r=$(y).width())-4<o+m)&&((o=r-m-4)<4&&(o=4,d.css("max-width","98%")),d.css("left",o+"px")),this.resetCloseTimer(),c||(pgCurrentContextMenu=this),this.actions.forEach(function(e){e.on_menu_shown&&e.on_menu_shown(e)}),d},this.resetCloseTimer=function(e){t&&clearTimeout(t),t=setTimeout(function(){v.close()},pgIsDev()?1e6:e||3e4),c&&c.resetCloseTimer()},this.updatePosition=function(e){var t,n,i,o,s,a,l;d&&(this.positioner?this.positioner.reposition():(n=l=0,e?(l=(t=d.parent()).offset().top,n=t.offset().left):t=$(y),i=d.offset(),s=d.height(),o=t.height(),s+i.top>o+l&&(0<i.top-s?d.css({top:i.top-s+"px"}):(a=i.top+s-(l+o),i.top,s=o-10+l-i.top,d.css({height:s,"overflow-y":"auto"}))),o=d.width(),l=t.width(),o+i.left>l+n&&(s=l-i.left-o,l=i.left<s||1?(a=i.left+o-(n+t.width()),parseInt(d.css("left"),10)-a):0,d.css("left",l))))}},PgDropdownButton=function(e,t){var n=this;this.$element=$('<a href="#" class="actions button">'+(e?"<span>"+e+"</span> ":"")+'<i class="icon icon-down"></i></a>').on("click",function(e){return t(e,n),!1}),this.setTooltip=function(e){addTooltip(this.$element,e)}},PgDropdownMenu=function(n){var i=this;this.onGetActions=null,n.on("click",function(e){e.preventDefault(),n.addClass("open");var t=new CrsaContextMenu(null,n);return i.onGetActions(t),t.onClosed=function(){n.removeClass("open")},t.showForElement(n,n.closest("body")),!1}),this.show=function(e){var t=new CrsaContextMenu(null,e);i.onGetActions(t),t.onClosed=function(){e.removeClass("open")},t.showForElement(e,e.closest("body"),8)}},pgShowKbd=function(e){return"<kbd>"+crsaGetKbdDisplay(e,!0)+"</kbd>"},pgShowKbdCombo=function(e){for(var t=e.split("+"),n=0;n<t.length;n++)t[n]=t[n].replace(/^PLUS$/,"+"),t[n]=pgShowKbd(t[n]);return t.join(" + ")},PgPreview=function(){var u=this,h=$("<div/>",{id:"crsa-preview",class:"preview"}).html('<div class="content clearfix"></div><div class="description"></div><div class="pre-holder"><pre></pre></div>').appendTo($("body")),s=(h.on("mouseover mousemove",function(e){u.hide()}),this.isVisible=function(){return h.is(":visible")},h.find(">.content")),a=h.find(">.description"),p=(pg$Hide(h),!1),l=(this.setContentSize=function(e,t){s.css({width:e+"px",height:t+"px"}),0<e&&h.css({width:e+16+"px"})},this.setDescription=function(e){a.html(e),pgShow(a.get(0))},null),g=(this.show=function(r,e,t,n,i){var o=e,c=(l=r,pgGetFastdomTasks(r.get(0)).create("showPreview")),d=r.get(0).ownerDocument.defaultView;d!==h.get(0).ownerDocument.defaultView&&h.appendTo(d.document.body),c.mutate(function(){var e;(o?pgShow:(o=$('<div style="display:none;"></div>'),pgHide))(s.get(0)),(i?(a.html(i),pgShow):(a.html(""),pgHide))(a.get(0)),o&&(s.html(""),u.onShowFirstMutate?(u.onShowFirstMutate(d),u.onShowFirstMutate=null):s.append(o),t&&h.addClass(t).data("custom-class",t),s.css({width:"",height:""}),h.css({width:""}),e=h.find(">div.pre-holder pre"),(n?(n=pinegrow.formatHtml(n),e.html(escapeHtmlCode(n)),pgShow):pgHide)(e.parent().get(0)),c.measure(function(){var e=r.offset(),t=$(d).height(),n=$(d).width(),i=h.height(),o=e.top-i/2,e=(t<o+i&&(o=t-i),h.width()),i=r.closest(".pg-grid-col"),s=(0==i.length&&(i=r),{}),a=g(e,i,s,d),l=!1;n<a+e&&(o<t/2?o+=80:o=0,l=!(a=0)),s.x=a,s.y=o,u.onShowSecondMeasure&&(u.onShowSecondMeasure(),u.onShowSecondMeasure=null),c.mutate(function(){var e;pgShow(h.get(0)),u.onShowThirdMutate&&((e=u.onShowThirdMutate(a,o,s,l))&&(a=e.x,o=e.y),u.onShowThirdMutate=null),h.css({left:a+"px",top:o+"px"}),p=!0})}))})},this.hide=function(){var e;p&&(e=pgGetFastdomTasks(l?l.get(0):null).create("showPreview"),u.onHide&&(u.onHide(),u.onHide=null),e.mutate(function(){p=!1,s.empty(),pg$Hide(h);var e=h.data("custom-class");e&&h.removeClass(e).data("custom-class",null)}))},function(e,t,n,i){n=n||{},i=i||window;var o=t.offset(),s=$(window).width(),a=(n.win_w=s,n.target_pos=o,n.container_w=t.width(),n.win_h=$(i).height(),0);return o.left>s-o.left-n.container_w?(n.pos="left",(a=o.left-e-20)<0&&(a=0)):(n.pos="right",s<(a=o.left+n.container_w+0)+e&&(a=s-e)),a})},pgPreview=new PgPreview,pgOpenViewInFloatingPanel=function(e,t,n){var i=myLayout._$normalizeContentItem({type:"stack",width:15,isClosable:!1,isFloating:!0,isAutoDocked:!1,content:[{type:"component",componentName:"custom",title:e,isClosable:!1}]});return i.contentItems[0].container.getElement().append(n.get$Element()),n.addedToLayout(i.contentItems[0].container),i},PgMoverAndResizer=function(s,e,t,m){var a,l,r=this,n="string"==typeof e?new PgDragHelper(s,e):new PgDragHelper(e),i=(this.dragListener=n,this.wholeVisible=!1,0),o=0,c=0,d=0,u=0,h=(n.on("dragStart",function(e,t){var n=s.closest(m).offset(),n=(i=n.top,s.offset());o=e-n.left,c=t-n.top,$.fn.crsapages("showOverlays")},this),n.on("drag",function(e,t,n){e=n.pageX,t=n.pageY,d=e-o,u=t-i-c,s.css({left:d+"px",top:u+"px"}),r.onMoveDrag&&r.onMoveDrag()},this),n.on("dragStop",function(e,t){$.fn.crsapages("showOverlays",!0),f(s,function(){r.onMove&&r.onMove(d,u)},r.wholeVisible)},this),new GoldenLayout.__lm.utils.DragListener(t,null,!1)),p=(this.dragResizer=h,0),g=0,f=(h.on("dragStart",function(e,t){var n=s.closest(m),i=s.position();p=s.width(),g=s.height(),a=n.width()-i.left,l=n.height()-i.top,$.fn.crsapages("showOverlays")},this),h.on("drag",function(e,t,n){var i=Math.max(200,Math.min(p+e,a)),o=Math.max(200,Math.min(g+t,l));s.css({width:i+"px",height:o+"px"}),r.onResize&&r.onResize(i,o)},this),h.on("dragStop",function(e,t){$.fn.crsapages("showOverlays",!0),f(s,null,r.wholeVisible)},this),this.destroy=function(){n.destroy(),h.destroy()},this.ensureVisible=function(e,t,n){return f(s,n,e,t)},function(e,t,n,i){var o,s,a,l,r,c=window.innerWidth,d=window.innerHeight,u=e.offset(),h=e.width(),p=e.height(),g=38,f=e.closest(m);if(".lm_goldenlayout"==m&&(g=0,d=f.height()),0!=f.length)return f=f.offset(),u.top-=f.top,s=o=!1,u.top<g&&(u.top=g,o=!0),r=40,l=a=!1,n&&("width"===n?a=!0:"height"===n?l=!0:a=l=!0),l&&(r=p),d-u.top-f.top<r&&(u.top=d-r-f.top,o=!0),u.left+h<(r=a?h:40)&&(u.left=-h+r,o=!0),u.left>c-r&&(u.left=c-r,o=!0),l&&u.top<g&&(u.top=g,u.top+p>d)&&(p=d-g,o=s=!0),l&&u.top+p>d&&(u.top=d-p,u.top<0)&&(p=d-g,u.top=g,o=s=!0),a&&u.left<0&&(u.left=0,u.left+h>c)&&(h=c,o=s=!0),a&&u.left+h>c&&(u.left=c-h,u.left<0)&&(h=c,o=s=!0),o?(i||e.addClass("lm_floating_animate"),e.css({left:u.left+"px",top:u.top+"px"}),s&&e.css({width:h+"px",height:p+"px"}),i?t&&t(o,s):setTimeout(function(){e.removeClass("lm_floating_animate"),t&&t(o,s)},500)):t&&t(),o||s?{x:u.left,y:u.top,w:h,h:p}:void 0;t&&t()})},pgDoElementsIntersect=function(e,t){var n=e.getBoundingClientRect(),i=t.getBoundingClientRect();return!(n.left+n.width<i.left||n.left>i.left+i.width||n.top+n.height<i.top||n.top>i.top+i.height)},pgConnectorId=0,PgConnector=function(){this.fromRect=null,this.toRect=null,this.$from=null,this.$to=null,this.parent,this.color="orange",this.fromOffset=0,this.toOffset=0;function r(e,t){return[[e.left+e.width/2,e.top+t,"V"],[e.left+e.width-t,e.top+e.height/2,"H"],[e.left+e.width/2,e.top+e.height-t,"V"],[e.left+t,e.top+e.height/2,"H"]]}var l={orange:"#ffa14d",blue:"#0098cc"},c=(this.create=function(){var e="connector_"+ ++pgConnectorId,t=$('<svg><path fill="none" stroke-width="4" stroke="'+l[this.color]+'" d="M149,106 C251,110 285,276 398,284" id="'+e+'" /><circle id="'+e+'_c1" r="4" fill="'+l[this.color]+'"/><circle id="'+e+'_c2" r="4" fill="'+l[this.color]+'"/></svg>');this.$element=t.find("#"+e),this.$circle1=t.find("#"+e+"_c1"),this.$circle2=t.find("#"+e+"_c2")},this.updatePosition=function(){var e,t,n,i,o=!0,s=(this.$from&&((s=this.$from.closest(":visible")).length?this.fromRect=s.get(0).getBoundingClientRect():o=!1),this.$to&&((s=this.$to.closest(":visible")).length?this.toRect=s.get(0).getBoundingClientRect():o=!1),this.$from.get(0).ownerDocument!==this.$to.get(0).ownerDocument&&(o=!1),this.fromRect),a=this.toRect,o=!o||!(s.left+s.width<a.left||a.left+a.width<s.left||s.top+s.height<a.top||a.top+a.height<s.top),a=o?"none":l[this.color];this.$element.attr("stroke",a),this.$circle1.attr("fill",a),this.$circle2.attr("fill",a),o||("H"==(s=c(this.fromRect,this.toRect,this.fromOffset,this.toOffset)).a[2]?(e=(s.a[0]+s.b[0])/2,t=s.a[1]):(t=(s.a[1]+s.b[1])/2,e=s.a[0]),"H"==s.b[2]?(n=(s.b[0]+s.a[0])/2,i=s.b[1]):(i=(s.b[1]+s.a[1])/2,n=s.b[0]),a="M"+s.a[0].toString()+","+s.a[1].toString()+" C"+e.toString()+","+t.toString()+" "+n.toString()+","+i.toString()+" "+s.b[0].toString()+","+s.b[1].toString(),this.$element.attr("d",a),this.$circle1.attr("cx",s.a[0]),this.$circle1.attr("cy",s.a[1]),this.$circle2.attr("cx",s.b[0]),this.$circle2.attr("cy",s.b[1]))},this.show=function(){this.updatePosition()},function(e,t,n,i){var o=r(e,n),s=r(t,i),a=9999999999999,l=null;return o.forEach(function(n){s.forEach(function(e){var t=(n[0]-e[0])*(n[0]-e[0])+(n[1]-e[1])*(n[1]-e[1]);t<a&&(a=t,l={a:n,b:e})})}),l});this.destroy=function(){this.$element&&(this.$element.remove(),this.$circle1.remove(),this.$circle2.remove(),this.parent.remove(this))}},PgConnectors=function(){var n=[],i=$('<svg class="pg-connectors" width="100%" height="100%"></svg>').appendTo($("body"));pg$Hide(i),this.add=function(e){var t=n.indexOf(e);0<=t&&n.splice(t,1),n.push(e),pg$Show(i),e.create(),i.append(e.$element),i.append(e.$circle1),i.append(e.$circle2),e.parent=this,e.show()},this.remove=function(e){var t=n.indexOf(e);0<=t&&n.splice(t,1),0===n.length&&pg$Hide(i)},this.update=function(){n.forEach(function(e){e.updatePosition()})}},PgPageViewHelper=function(e,o,i,s,n,t,a,l,r,c){function d(){w("1"==pinegrow.getSetting(o,t))}function u(){return h[p]||h[r]||"red"}var h={lightblue:"#00BFFF",blue:"#6875ff",green:"#00d021",yellow:"#fdff00",orange:"#ffba00",darkorange:"#ff7f00",red:"#ff5858",purple:"#e100ff",gray:"#848484"},p=r||"blue",g=this,f=(s=s||$("<div></div>"),void 0===t&&(t="1"),!0),m=!1,v=!1,w=(this.onChange=function(){},this.onExtraCmd=function(){},this.onGetCurrentValue=null,i.startsWith("UI:")&&(m=!0,i=i.replace("UI:","")),i.startsWith("!")&&(v=!0,i=i.replace("!","")),function(e){var t=!!c||pinegrow.getShowDisplayHelpers(),n=v?!e||!t:e&&t,t=(m?n?$("body").addClass(i):$("body").removeClass(i):$.each(pinegrow.getAllPages(),function(e,t){t.getPageViews().forEach(function(e){var t=e.get$Html();t&&(n?t.addClass(i):t.removeClass(i))})}),s.find("i"));e?t.show():t.hide(),f!=e&&g.onChange(e),f=e}),b=(w("1"===pinegrow.getSetting(o,t)),l&&(p=pinegrow.getSetting(o+"-color",p)),function(e,t){var n,i=!f||t;w(i),pinegrow.setSetting(o,i?"1":"0"),e&&(n=e.find("i"),(i?pg$Show:pg$Hide)(n))}),_=(this.setValue=function(e){f=!e,b()},s.on("click",function(e){e.preventDefault(),b()}),pinegrow.addEventHandler("on_page_loaded",d),pinegrow.addEventHandler("on_page_refreshed",d),c||pinegrow.addEventHandler("on_show_display_helpers_changed",function(e,t){d()}),n&&pinegrow.addEventHandler("on_set_inline_style",function(e,t){t.css+=n.replace(/\#COLOR\#/g,u())}),this.getCurrentValue=function(){return g.onGetCurrentValue?g.onGetCurrentValue():f}),y={label:e,action:function(e,t,n){b(n),pinegrow.selectedElements.reselect()},check:function(){return _()},show_filter:function(){if(a){var e=pinegrow.getSelectedPage();if(!e||!e.hasFramework(a))return!1}return!0},extra_action:function(){g.onExtraCmd()}};l&&(y.submenu=function(){var e=[],n=[];return $.each(h,function(e,t){n.push({label:`<span class="pg-menu-color-swatch" style="background:${t};"></span>`,action:function(){p=e,pinegrow.setSetting(o+"-color",p),pinegrow.getAllPages().forEach(function(e){e.addCrsaStyles()}),b(null,!0)}})}),e.push({buttons:n}),e.push({type:"divider"}),e.push({label:"None",action:function(){b(null,!1)}}),e},y.submenu_class="pg-menu-fixed-size-md",y.label+=`<span class="pg-menu-color-swatch pg-menu-color-swatch-right" style="background:${u()};"></span>`,y.on_painted=function(e){e.find(".pg-menu-color-swatch").css("background",u())}),c||pinegrow.helpersToolbarItem.addAction(y)},PgArrowsMover=function(e,o,s,t){var i=this,a=null,n=(this.flat=!0,this.select_first=!1,s.replace(/^\s*>\s*/,"")),l=(e.on("focus.mover",function(e){l(i.get$Item())}),e.on("blur.mover",function(e){l(null)}),e.on("keydown.mover",function(e){var t;switch(e.key){case"ArrowDown":return t=a?a.next(n):o.find(s).first(),l(t,e),!1;case"ArrowUp":return t=a?a.prev(n):o.find(s).last(),l(t,e),!1;case"Enter":return i.onEnter(a,e),!1}}),this.onEnter=function(){},this.get$Item=function(){return(a=!a&&this.select_first?o.find(s).first():a)&&a.length?a:null},this.set$Item=function(e){l(e)},function(e,t){e&&0===e.length&&(e=null);var n=a;a&&a.removeClass("arrow-selected"),e&&(e.addClass("arrow-selected"),pgScrollToItemInContainer(e,o)),a=e,i.onSelected&&i.onSelected(a,n,t)});this.selectFirstItem=function(){a=null,l(this.get$Item())},this.update=function(e,t){var n=this.get$Item(),i=null;n&&(i=n.attr(e)),t&&t(),i&&(0==(n=o.find("["+e+'="'+i+'"]')).length&&(n=o.find(s+":first")),this.set$Item(n))},this.destroy=function(){e.off(".mover")}},PgDelayedTasks=function(){var i={},o={};this.cancel=function(e){i[e]&&(clearTimeout(i[e]),delete i[e],delete o[e])},this.run=function(e,t,n){this.cancel(e),i[e]=setTimeout(function(){t(),delete i[e],delete o[e]},n),o[e]=t},this.runAllNow=function(){$.each(i,function(e,t){clearTimeout(t),o[e]()}),i={},o={}},this.clearAll=function(){$.each(i,function(e,t){clearTimeout(t)}),i={},o={}},this.destroy=function(){this.clearAll()}},PgQuickDialog=function(e,t,n){n=$.extend(o,n||{});var i=new PgQuickDialogView(t),o={key:"quickDialog"+i.view.getId(),width:400,target:null,auto_size_padding:80,on_close:null,auto_size:!0},o=(n=$.extend(o,n||{}),this.win=new PgQuickWindow(e,i,n.key,n.width,n.height||250));n.target?o.showFor$El(n.target):o.showAtRandomPosition(),n.auto_size&&o.autoSize(n.auto_size_padding),o.onDestroy=function(){n.on_close&&n.on_close()}},PgQuickDialogView=function(e){var t=$('<div class="pg-quick-dialog"></div>'),n=this.view=new PgUIView(t),i="string"==typeof e?e:e(t);t.append(i),n.onDestroy=function(){}},PgWorkflowMode=function(e,t){this.activate=function(){},this.deactivate=function(){}},PgFocusBarMode=function(){this.mode=null,this.pgel=null,this.name=null,this.onlyTopLevel=!1,this.insert=[],this.isActiveForPgel=function(e){return!1},this.getName=function(e){return e?this.name+" - "+e.getName({short:!0}):this.name},this.getPgelForPage=function(e,t){t(null)},this.onActivated=function(e){}},PgFocusBar=function(){function r(){pgf.focus_in_tree||($("#layout-container").addClass("with-focus-bar"),pg$Show(d.$element,"flex"),$(window).trigger("resize"))}function c(){pgf.focus_in_tree||($("#layout-container").removeClass("with-focus-bar"),pg$Hide(d.$element),d.focusButton.setActive(!1),$(window).trigger("resize"))}var d=this,u=[],e=new PgFocusBarMode,e=(e.mode="body",e.name="Page Layout",e.onlyTopLevel=!0,e.isActiveForPgel=function(e){return"body"===e.tagName},e.getPgelForPage=function(e,t){t(e.sourceNode.findOne("body"))},e.onActivated=function(e){pinegrow.showUIPanel("tree",!1,!0)},u.push(e),new PgFocusBarMode),h=(e.mode="html",e.name="Page Settings",e.isActiveForPgel=function(e){return"html"===e.tagName},e.getPgelForPage=function(e,t){t(e.sourceNode.findOne("html"))},e.onActivated=function(e){pinegrow.selectElement(e.getPage().sourceNode.findOne("html")),pinegrow.showUIPanel("prop",!1)},null),p=null,e=(this.$element=$(`<div class="pg-focus-bar"><i class="pg-focus-bar-decoration icon icon-focus"></i>
<div class="pg-focus-bar-title">Focusing on&nbsp;<span class="pg-focus-bar-title-object"></span><i class="icon icon-close"></i></div>
<div class="pg-focus-bar-insert"><label>Insert:</label> <ul></ul></div>
</div>`),this.$element.find(".pg-focus-bar-title")),g=this.$element.find(".pg-focus-bar-title-object"),e=e.find(".icon-close"),f=this.$element.find(".pg-focus-bar-insert"),m=f.find("ul"),v=(m.on("click","li",function(e){e.preventDefault();var t=$(this),n=t.data("action-menu"),t=t.data("crsa-factory-def");crsaFuncs.insertThroughActionMenu(n,p,t,!0)}),e.on("click",function(e){e.preventDefault(),pinegrow.isolateElement(null)}),g.on("click",function(e){return e.preventDefault(),d.showMenu(g),!1}),function(e){var t=pinegrow.repeater.showLiveRepeatCount();return $("<li/>",{class:"crsa-factory-element crsa-factory-element-text crsa-factory-element-type-"+e.type}).html("<name>"+e.name+t+"</name>").data("crsa-factory-def",e)});this.showMenu=function(e){var n=new CrsaContextMenu(null,e),t=pinegrow.selectedElements.getLastSelected();n.add({type:"header",label:"Focus on:"}),u.forEach(function(t){n.add({label:t.getName(),action:function(){var e=pinegrow.getSelectedPage();e?t.getPgelForPage(e,function(e){e&&pinegrow.isolateElement(e,{drag_drop_only_top_level:t.onlyTopLevel})}):pinegrow.showQuickError("Please open a page first.")}})}),n.add({label:t?"Selected element: "+t.getName({short:!0}):"Selected element",action:function(){var e=pinegrow.selectedElements.getLastSelected();e?pinegrow.isolateElement(e):pinegrow.showQuickError("Select an element first.")},kbd:"CMD+F"}),n.add({type:"divider"}),n.add({label:"Clear",action:function(){pinegrow.isolateElement(null)}}),n.showForElement(e,null,8)},pinegrow.addEventHandler("on_element_isolated",function(e,t){if(t){r();var n=t;h=null,p=n;for(var i=0;i<u.length;i++)if(u[i].isActiveForPgel(n)){h=u[i];break}h?(g.html(h.getName(n)),h.onActivated(n)):g.html(n.getName({short:!0})),d.focusButton.setActive(!0);var o=!1,s=(m.empty(),n.getPage()),a=s.getAllTypes(null,n),l=[];$.each(a,function(e,t){t.action_menu&&t.action_menu.add&&l.push(t.action_menu)}),$.each(l,function(e,i){$.each(i.add,function(e,t){var n=s.getTypeDefinition(t);n&&((n=v(n)).data("action-menu",i),n.addClass("crsa-factory-element-link"),n.appendTo(m),o=!0)})}),o?pg$Show(f,"flex"):pg$Hide(f)}else p=h=null,c()}),pinegrow.addEventHandler("on_page_selected",function(e){e&&p&&(p.getPage()!==e?h?h.getPgelForPage(e,function(e){e?pinegrow.isolateElement(e):c()}):c():r())}),this.$element.insertAfter($("#crsa-topbar"))},PgDeviceSizesControl=function(u,h,p){var g,f=this,m=!1,v=(void 0===h&&(h=pinegrow.getSyncCurrentDeviceSizeWithPageView()),void 0===u&&(u=!0),void 0===p&&(p=!0),this.$element=$('<div class="pg-dm-sizes-control"></div>'),this.onHasTabSizeClassesOrRules=function(e,t){return!1},null),w=null,b={},_=null,y=null,C=null,P={},k=null,S=(this.setStatesOptions=function(e){P=e},this.show=function(e){var t=pinegrow.getSelectedPage();if(t){m&&(pg$Show(this.$element,"flex"),m=!1);pinegrow.selectedElements.getLastSelected();var n={},i=(g=t.activeView.getDeviceSizes(n),t.activeView,null),o=(y=e||pinegrow.getCurrentDeviceSize(),C=y.size||"all",this.$element.empty(),this.$element);v=new PgButtonToolbar,o.prepend(v.$element.addClass("pg-tabs-toolbar")),$(`<div class="pg-dm-sizes-control-notice"></div>`),w=new PgToolbarTabButtons(v,"tabs"),b={},k="";for(var s=0;s<g.length;s++){var a=g[s],l=!1;if(i)for(var r=i.getItemsForSize(a.size),c=0;c<r.length;c++)if(r[c].isSet()){l=!0;break}var d=C===a.size,d=w.addTab((a.name_short||a.name)+'<i class="icon icon-hide"></i>',null,a,d).setClosable(!1);b[a.size]=d,l&&d.$element.append('<i class="icon icon-check"></i>'),d.$element.attr("data-size",a.size);f.onHasTabSizeClassesOrRules(a.size,a)&&d.$element.addClass("has-info"),k+="_"+a.name,addTooltip(d.$element,`<code>${a.w_range[0]}px</code> and up.${""}<br>Click to select. Right-click to resize the page.`),!function(n){n.$element.on("contextmenu",function(e){var t=pinegrow.selectedElements.getLastSelected(),t=(t&&t.setData("selectedCssRule",null),h);h=!0,w.setActive(n),w.onTabSelected(n),h=t})}(d)}addTooltip(v.$element.find("i.icon-hide"),"This size is not visible in the active page view."),S(t),w.onTabSelected=function(e){var t,n=e.data,i=(C=n.size||"all",y=n,pinegrow.getSelectedPage());h&&(t=i.view.setActiveViewSizeWithDef(n),i.view.setActiveView(t)),pinegrow.setCurrentDeviceSize(n,i,i.activeView,!0),f.onDeviceSizeChanged&&f.onDeviceSizeChanged(i,n),i&&S(i)},_=new PgPseudoStatesControl(n.states);o=new PgButtonToolbarItem(_.$element),o=($.each(P,function(e,t){_[e]=t}),_.$addClassTo=o.$element.addClass("pg-pseudo-dropdown-container"),_.show(),_.onStateChanged=function(e){var t=pinegrow.getSelectedPage();pinegrow.setCurrentDeviceSize(pinegrow.getCurrentDeviceSize(),t,t.activeView,!0)},u&&(v.addSection("pseudo").$element.css("height","28px"),v.addItem("pseudo",o)),p&&(v.addSection("settings",!0).$element.css("height","28px"),n=new PgButtonToolbarItem("icon-tools","Settings &amp; Tools."),v.addItem("settings",n),n.onClick=function(){var e=[];e.push({label:"Sync with page view",check:h,action:function(){var e;(h=!h)&&t.view.getPage()&&(e=t.view.setActiveViewSizeWithDef(y),t.view.setActiveView(e)),pinegrow.setSyncCurrentDeviceSizeWithPageView(h),pinegrow.showMode("Sync with the page view",h)}}),pinegrow.dispatchEvent("on_device_size_selector_settings",pinegrow.getSelectedPage(),e,f),new CrsaContextMenu(e,this.$element).showForElement(this.$element)}),new PgButtonToolbarItem("icon-Transform_X","Sync with page view display."));o.onClick=function(){var e;h=!this.getActive(),this.setActive(h),h&&t.view.getPage()&&(e=t.view.setActiveViewSizeWithDef(y),t.view.setActiveView(e)),pinegrow.setSetting("prop-device-size-sync",h?"1":"0"),pinegrow.showMode("Sync with page view",h)},o.setActive(h)}},function(e){var t=!1;e.getPageViews().forEach(function(e){!t&&e.isDeviceSizeVisible(y)&&(t=!0)}),t?b[C]&&b[C].$element.removeClass("not-visible"):b[C]&&b[C].$element.addClass("not-visible")});this.updateOrShow=function(e){!function(){if(null===k)return!1;var e="",t=pinegrow.getSelectedPage();if(t)for(var n=t.activeView.getDeviceSizes({}),i=0;i<n.length;i++)e+="_"+n[i].name;return k===e}()?this.show(e):this.update(e)},this.update=function(e){var t,n,i=pinegrow.getSelectedPage();i&&(m&&(pg$Show(this.$element,"flex"),m=!1),i.activeView,(n=(t=e||pinegrow.getCurrentDeviceSize()).size||"all")!==C&&(n?w.setActive(b[n]&&b[n]):w.setActive(null)),C=n,y=t,(n=pinegrow.selectedElements.getLastSelected())&&_.update(n),$.each(b,function(e,t){f.onHasTabSizeClassesOrRules(e,t.data)?t.$element.addClass("has-info"):t.$element.removeClass("has-info")}),S(i))},this.hide=function(){pg$Hide(this.$element),m=!0}},PgPseudoStatesControl=function(i){var o=this,l={},r=function(){var e=pinegrow.getSelectedPage();return e?(e.callFrameworkHandler("on_get_pseudo_states_for_pseudo_control",e=[]),e):i},s=["active","hover","focus","visited","focus-within"],c=this.$element=$('<div class="pg-pseudo-dropdown"><span></span><i class="icon icon-down"></i></div>'),d=(this.$addClassTo=c).find("span"),u="";this.show=function(){addTooltip(c,"Select pseudo state.",{use_title_attr:!0}),c.on("click",function(e){function t(e){var t=r(),n=(u=e,t.forEach(function(e){l[e]=e===u}),t),i=[];t.forEach(function(e){l[e]&&0<=s.indexOf(e)&&i.push(e)}),pinegrow.getCollection().forEachElementAsync(function(e,t){e.get$DOMElements().forEach(function(n){r().forEach(function(e){var t=`pg-state-`+e;l[e]?(n.addClass(t),n.attr("data-"+t,"")):(n.removeClass(t),n.removeAttr("data-"+t))})}),pinegrow.devTools.forcePseudoStates(e,i,t)},function(e){pinegrow.dispatchEvent("on_current_pseudo_state_changed",pinegrow.getSelectedPage(),n),o.onStateChanged&&o.onStateChanged(n)})}var n=[{type:"header",label:"Select a pseudo class:"},{label:"None",check:""===u,action:function(){t("")}},{type:"divider"}];return i.forEach(function(e){n.push({label:e,check:u===e,action:function(){t(e)}})}),o.onShowMenu&&o.onShowMenu(n),new CrsaContextMenu(n,d).showForElement(d),!1});var e=pinegrow.selectedElements.getLastSelected();this.update(e)},this.update=function(e){e&&(t=e.get$DOMElement());for(var t,n=[],i=(u="",r()),o=0;o<i.length;o++){var s=i[o];if(t&&(l[s]=t.hasClass(`pg-state-`+s)||t.get(0).hasAttribute("data-pg-state-"+s),l[s])){u=s,n.push(s);break}}var a=u;this.onUpdateDisplay&&(a=this.onUpdateDisplay(a)),d.text(a||"Pseudo class"),a?this.$addClassTo.addClass("has-state"):this.$addClassTo.removeClass("has-state"),c.attr("title",u?"Edit the <b>:"+u+"</b> state. Click to change.":"Click to select a pseudo state..."),pinegrow.dispatchEvent("on_current_pseudo_state_changed",pinegrow.getSelectedPage(),n)}},PgColorPicker=function(s,a,i,l,r){r=r||{};function e(e){var t=s.get(0).value;f(p(t)||"",t)}function t(e){!c||$(e.target).closest(c).length||$(e.target).closest(o).length||m()}var n,c=null,d=this,o=(this.close_on_mouseleave=!1,this.keepOpenOnClick=!1,$('<div class="pg-color-picker-field"></div>').insertAfter(s)),u=new PgUIView(o),h=null,p=function(e){for(var t="function"==typeof a?a(l()):a,n=0;n<t.length;n++)for(var i=0;i<t[n].length;i++)if(t[n][i].key===e)return t[n][i].color;return null},g=this.show=function(){c=$('<div class="pg-color-picker"><i class="close icon icon-close"></i></div>').appendTo($("body"));var e=$('<div class="pg-color-picker-grid"></div>').appendTo(c),i=(c.find(".close").on("click",function(e){e.preventDefault(),m()}),""),t="function"==typeof a?a(l&&l()):a,o=s.val();t.forEach(function(e){i+='<div class="pg-color-picker-row">',e.forEach(function(e){var t=e.color,n=e.key;i+=`<div class="pg-color-picker-c ${o===n?"selected":""}" title="${e.name||""}" data-val="${n}" data-color="${t}"><div style="background-color:${t};"></div></div>`}),i+="</div>"}),i+='<button class="pg-button">No color</button>',e.html(i),e.on("click","button",function(e){o=null,r.on_value_set&&r.on_value_set(""),f(""),s.val(""),d.keepOpenOnClick?c.find(".pg-color-picker-c.selected").removeClass("selected"):m(),s.trigger("change")}),e.on("click",".pg-color-picker-c",function(e){var t=$(this),n=t.attr("data-val");r.on_value_set&&r.on_value_set(n),s.val(n),f(t.attr("data-color"),n),d.keepOpenOnClick?(c.find(".pg-color-picker-c.selected").removeClass("selected"),t.addClass("selected")):m(),s.trigger("change")}),r.on_color_highlighted&&(e.on("mouseenter",".pg-color-picker-c",function(e){var t=$(this).attr("data-val");r.on_color_highlighted&&r.on_color_highlighted(t)}),e.on("mouseleave",".pg-color-picker-c",function(e){r.on_color_highlighted&&r.on_color_highlighted(null)})),c.on("mouseleave",b),c.on("mouseenter",w),r.on_show&&r.on_show()},f=function(e,t){if(o.text(t),e){var n;try{n=chroma(e)}catch(e){n=chroma("rgba(0,0,0,0)")}0==n.alpha()&&(e=(n=n.alpha(1)).css()),h=e}else h=null;i?o.css({color:e,"background-color":n?chroma.contrast("#ffffff",n)<4.5?"rgba(0,0,0,1)":"rgba(255, 255, 255, 1)":""}):o.css({"background-color":e,color:n?chroma.contrast("#ffffff",n)<4.5?"rgba(0,0,0,0.7)":"rgba(255, 255, 255, 0.7)":""})},m=(this.getColorValue=function(){return h},this.isOpen=function(){return null!==c},this.close=function(){c&&(n&&n.destroy(),n=null,c.off("mouseenter",w),c.off("mouseleave",b),c.remove(),c=null),r.on_hide&&r.on_hide()}),v=(s.on("pg-on-value-updated",e),this.get$Input=function(){return s},this.showWithPosition=function(e){g(),n=new PgPositionNextTo$El(c,e||s,null,0,"down_no_resize")},o.on("click",function(e){c?m():d.showWithPosition(s)}),document.addEventListener("mousedown",t,!0),!1),w=function(e){v=!0},b=function(e){v=!1,d.close_on_mouseleave&&d.close()};this.isMouseOver=function(){return v},u.onDestroy=function(){document.removeEventListener("mousedown",t),s.off("pg-on-value-updated",e),d.close()}},PgElementClassesControlTEST=function(){this.$element=$('<div class="pg-el-classes-control clearable-area"></div>');var e=new PgUISection("ElementClassesControl","",{collapse_tooltip:"Click to expand / collapse the class list."}),t=(this.$element.append(e.$element),e.$content);new PgClassTree;this.show=function(e){pg$Show(this.$element),t.trigger("crsa-will-clear-area"),t.empty()},this.hide=function(){this.show(null),pg$Hide(this.$element)},this.destroy=function(){this.show(null)}},PgElementClassesControl=function(){this.ignore_update=!1,this.$element=$('<div class="pg-el-classes-control clearable-area"></div>');var e=new PgUISection("ElementClassesControl","",{collapse_tooltip:"Click to expand / collapse the class list."}),t=(this.$element.append(e.$element),e.$content);this.show=function(e){this.ignore_update||(pg$Show(this.$element),t.trigger("crsa-will-clear-area"),t.empty(),e&&crsaFuncs.updateRulesList(t,e,null,null,!0,this))},this.hide=function(){this.show(null),pg$Hide(this.$element)},this.destroy=function(){this.show(null)}},PgSectionNavigator=function(){var i,t=$('<div class="pg-css-gui-filter"></div>'),o=(this.$element=t,null),n=(this.setGrid=function(e){o=e},this.addSection=function(e){filter_sections.push(e)},[]),s=function(e){if(e.sub_sections){for(var t=0;t<e.sub_sections.length;t++)if(s(e.sub_sections[t]))return!0}else for(t=0;t<e.sections.length;t++)if(o.hasData(e.sections[t]))return!0;return!1},a=!0;this.show=function(e){!function(e){if(n.length!==e.length)return!1;for(var t=0;t<e.length;t++)if(n[t].name!==e[t].name)return!1;return!0}(e)?(i&&i.destroy(),(i=new PgButtonToolbar(!0)).$element.appendTo(t),i.addSection("sections"),e.forEach(function(t){var n=new PgButtonToolbarItem(t.icon,t.name,t);t.active=!1,n.setActive(s(t)),i.addItem("sections",n),(t.toolbarItem=n).onClick=function(){var e;t.sub_sections?(e=t.sub_sections.map(function(e){return{label:e.name,check:s(e),action:function(){o.scrollTo(e.sections)}}}),new CrsaContextMenu(e,n.$element).showForElement(n.$element)):o.scrollTo(t.sections)}})):this.update(e),n=e,a||(pg$Show(this.$element),a=!0)},this.hide=function(){a&&(pg$Hide(this.$element),a=!1)},this.update=function(e){e.forEach(function(e){var t=!1;e.sub_sections?e.sub_sections.forEach(function(e){t=t||s(e)}):t=s(e),e.toolbarItem.setActive(t)})},this.updateHasData=function(){this.update(n)}},PgDraggableReorder=function(i,o,s,t){function a(e){e.preventDefault();var t=$(this);c?this!==d&&r!==this&&(r&&r.classList.remove("drop-target"),(r=this).classList.contains("drop-target")||r.classList.add("drop-target")):t.hasClass("drop-target")||n.insertBefore(t)}var l=new PgDragHelper(i,o,null,"force"),n=(t&&(l.onGetDropEffect=function(e){return"function"==typeof t?t(e):t}),$(`<div class="${o.replace(".","")} drop-target" draggable="true"></div>`)),r=null,c=!0,d=null;l.on("dragStart",function(e,t,n){$.fn.crsapages("showOverlays"),d=l.dragTarget.get(0),r=null,i.on("dragover",o,a),i.on("dragenter",o,a)},this),l.on("drag",function(e,t,n){n.originalEvent.dataTransfer.dropEffect},this),l.on("dragStop",function(e,t,n){$.fn.crsapages("showOverlays",!0),i.off("dragover",o,a),i.off("dragenter",o,a),r&&r.classList.remove("drop-target"),s&&s(d,r,e.originalEvent.dataTransfer.dropEffect,e)},this)};class PgCSSFieldExtension{constructor(e,t,n,i){this.fdef=t,this.$container=n,this.$input=i;var o=this;this.css_property=e,t.css_property&&(this.css_property=t.css_property),this.$container.on("contextmenu",function(e){return e.preventDefault(),o.showMenu(),!1}),t.on_get_value_from_field=this.onGetValue.bind(this),t.on_set_field_value=this.onSetValue.bind(this),this.add_default_unit="px","add_default_unit"in t?this.add_default_unit=t.add_default_unit:"select"===t.type&&(this.add_default_unit=""),this.info=pgParseCSSValue(this.$input.val()),"select"===t.type&&!1||(this.$element=$(pgE("div",{class:"pg-css-field-pill"})),this.$container.get(0).appendChild(this.$element.get(0)),n.addClass("pg-field-with-css-ext"),n.closest(".crsa-field").addClass("pg-field-with-css-ext-on-crsa-field"),this.$element.on("click",function(e){return e.preventDefault(),o.showMenu(),!1}),this.$input.on("blur",this.onBlur.bind(this)),this.updatePill())}onBlur(e){this.updatePill();var t=this.$input.val(),n=pgParseCSSValue(t);null!==t&&""!==t&&"0"!==t&&0!==t&&this.add_default_unit&&"value"===n.type&&t!==(t=pgGetCSSValueFromParsedInfo(n))&&this.$input.val(t)}onGetValue(e,t){var n;return null!==e&&""!==e&&"0"!==e&&0!==e&&this.add_default_unit?this.fdef.skip_adding_units_on_input&&"input"===t.type?e:("value"===(n=pgParseCSSValue(e)).type&&(this.info.value=n.val,n.unit||(n.unit=this.info.unit||"px")),n.important||(n.important=this.info.important),this.info=n,pgGetCSSValueFromParsedInfo(this.info)):(this.info.important&&!(n=pgParseCSSValue(e)).important&&(e+=" !important"),e)}onSetValue(e){return this.info=pgParseCSSValue(e),this.info.important&&(e=this.info.original_without_important),this.updatePill(),e}destroy(){}updatePill(){var e=this.$element.get(0);this.info.important,e.innerHTML="!",e.setAttribute("data-important",this.info.important?"true":"false")}showMenu(){const n=this;var i,t,o,s,a,l=[],e=pinegrow.selectedElements.getLastSelected(),r=pinegrow.getSelectedPage(),e=(e&&(i=e.get$DOMElement()),"select"!==n.fdef.type&&"color"!==n.fdef.type&&"custom"!==n.fdef.type),c=(e&&(l.push({type:"header",label:"Convert unit"}),t=function(e){var t=n.$input.val(),t=pgParseCSSValue(t);null!==t.value&&(t=pgConvertCSSUnit(t.value,t.unit,e,i,n.css_property),n.info.unit=e,n.$input.val(t+e),n.updatePill(),n.$input.change())},["px","%","em","rem","pt","vw","vh"].forEach(function(e){l.push({label:e,check:e===n.info.unit,action:function(){t(e)}})}),l.push({label:"More units",submenu:["cm","mm","Q","in","pc","ex","ch","lh","vmin","vmax"].map(function(e){return{label:e,check:e===n.info.unit,action:function(){t(e)}}})}),l.push({type:"divider"})),l.push({label:"!important",action:function(){var e=n.$input.val(),e=pgParseCSSValue(e);e.important&&(n.info.important=!0),n.info.important=e.important=!n.info.important,n.updatePill(),n.$input.val(e.original_without_important),n.$input.change()},check:n.info.important}),"select"!==n.fdef.type&&"custom"!==n.fdef.type);i&&c&&(o=new PgGetCSSValueHTML,c=pinegrow.insight.getCSSVarsForPage(r),s=r.activeView.getWindow().getComputedStyle(i.get(0)),a=[],c.forEach(function(e){var t=s.getPropertyValue(e.key);null!==t&&""!==t&&a.push({label:e.key+" / "+o.getHTML((t+"").trim()),action:function(){n.$input.val(`var(${e.key})`),n.$input.change(),n.updatePill()}})}),a.length)&&(l.push({type:"divider"}),l.push({label:"CSS variables",submenu:a})),e&&(l.push({type:"divider"}),l.push({label:"Calculate",action:function(){var e=n.$input.val(),t=pgParseCSSValue(e);t.calc||(e=null!==t.value?`calc(${t.original_without_important} + 0px)`:(isApp(),`calc(${e=""===e?"0":e} + 0px)`),t.important&&(n.info.important=!0),n.$input.val(e),n.$input.change(),n.updatePill())}})),new CrsaContextMenu(l,this.$element||this.$container).showForElement(this.$element||this.$container)}}class PgMousePosition{constructor(){this.pos={top:0,left:0,target:null},this.prev_pos={top:0,left:0},this.prev_time=0,this.last_time=0;var t=this;$("body").on("mousemove",function(e){t.updateData(e)})}updateData(e,t){var n=performance.now();100<n-this.prev_time&&(this.prev_pos.top=this.pos.top,this.prev_pos.left=this.pos.left,this.prev_time=this.last_time,this.last_time=n),this.pos.top=e.pageY,this.pos.left=e.pageX,this.pos.target=t}registerPositionInIframe(e){this.updateData(e,e.target)}getVelocity(){var e,t,n=performance.now();return 100<n-this.last_time||n-this.last_time==0?0:(e=Math.abs(this.pos.top-this.prev_pos.top),t=Math.abs(this.pos.left-this.prev_pos.left),Math.sqrt(e*e+t*t)/(n-this.last_time)*1e3)}getYVelocity(){var e=performance.now();return 100<e-this.last_time||e-this.last_time==0?0:Math.abs(this.pos.top-this.prev_pos.top)/(e-this.last_time)*1e3}getPosition(){var e;return this.pos.target&&(e=getPageViewOfElement($(this.pos.target)))&&(e=e.pageRectToGlobalRect({left:this.pos.left,top:this.pos.top,width:0,height:0}),this.pos.left=e.left,this.pos.top=e.top,this.pos.target=null),this.pos}}var PgFocusRect=function(){function i(e,t){var n=t.get(0).getBoundingClientRect();a.css({height:e.top}),l.css({height:n.height-e.top-e.height}),r.css({top:e.top,width:e.left,height:e.height}),c.css({top:e.top,width:n.width-e.left-e.width,height:e.height}),s.appendTo(t),pinegrow.selectedElements.onRepositionMenus=o.update}var o=this,s=$('<div class="pg-focus-rect"><div class="pg-focus-rect-top"></div><div class="pg-focus-rect-bottom"></div><div class="pg-focus-rect-left"></div><div class="pg-focus-rect-right"></div></div>'),a=s.find(".pg-focus-rect-top"),l=s.find(".pg-focus-rect-bottom"),r=s.find(".pg-focus-rect-left"),c=s.find(".pg-focus-rect-right"),d=(this.onHide=null,this.onHideByClick=null,s.on("click",function(e){e.preventDefault(),pinegrow.dispatchEvent("on_focus_rect_closed",null),o.hide(),o.onHideByClick&&o.onHideByClick()}),null);this.hide=function(){s.detach(),d=null,pinegrow.selectedElements.onRepositionMenus=null,this.onHide&&this.onHide()},this.showFor$El=function(e,t){this.onHideByClick=t,(d=function(){i(e.get(0).getBoundingClientRect(),e.closest("body")),e.closest(".modal").length?s.css("z-index","10000"):s.css("z-index","")})()},this.showForPage$El=function(n){(d=function(){var e=getPageViewOfElement(n),t=e.get$ElGlobalRect(n);i(t,e.getPageParent$Body())})()},this.coverAll=function(){(d=function(){i({x:0,left:0,top:0,y:0,width:0,height:0,right:0,bottom:0},$("body"))})()},this.update=function(){d&&d()},this.destroy=function(){this.hide(),s.remove()}},PgUIElementExplainer=function(n,e,t){var i,o,s=$.extend({},{show_delay:100,close_delay:3e3,focus:!1,position:"down",scroll_container:null,button:null,next_step:null,on_button_clicked:null,on_close:null},t),a=(s.button&&(e+=`<p><button class="btn pg-button">${s.button}</button></p>`),this.$element=$(`<div class="pg-ui-element-explainer" style="visibility:hidden;opacity:0;" data-position="${s.position}">${e}<i class="icon icon-close"></i></div>`).appendTo(n.closest("body")),this.$element.find("button").on("click",function(e){e.preventDefault(),s.on_button_clicked&&s.on_button_clicked(),r()}),(s.scroll_container||$("body")).one("scroll",function(e){r()}),this),l=null,r=(this.$element.find("i.icon-close").on("click",function(e){e.preventDefault(),r()}),function(){clearTimeout(o),o=null,c&&clearTimeout(c),c=null,pgia.play(a.$element.get(0),"Hide"),i&&i.destroy(),i=null,l&&(l.onHide=null,l.destroy()),s.next_step&&s.next_step(),s.on_close&&s.on_close()}),c=setTimeout(function(){function e(){i=new PgPositionNextTo$El(a.$element,n,null,4,s.position),pgia.play(a.$element.get(0),"Show",t),s.focus&&((l=new PgFocusRect).showFor$El(n),l.onHide=function(){r()}),o=setTimeout(function(){r()},s.close_delay)}var t={l:[{name:"Show",trg:"no",a:{down:{show:"fadeInUp"},up:{show:"fadeInDown"}}[s.position].show,po:"true"},{name:"Hide",trg:"no",a:{l:[{t:"",l:[{t:"set",p:0,d:0,l:{autoAlpha:1,y:0},e:"Power1.easeOut"},{t:"tween",p:0,d:.5,l:{autoAlpha:0,y:"-0%"},e:"Power1.easeOut"},{t:"tween",p:.5,d:.5,l:{pgDom:{remove:1}}}]}]},po:"true"}]};s.scroll_container?pgScrollToItemInContainer(n,s.scroll_container,!1,!0,e,-100):e()},s.show_delay);this.close=r};class PgCodeEditorInput{constructor(){this.$element=$('<div class="pg-code-insert"><div class="pg-code-insert-editor"></div>\x3c!-- <i class="clear icon icon-close"></i> --\x3e</div>');var e=this.view=new PgUIView(this.$element,"code_input"),t=(this.$editor=this.$element.find("> .pg-code-insert-editor"),this.CodeEditorVsc=null,this.$element.find(".clear")),n=(t.on("click",function(e){return this.CodeEditorVsc&&this.CodeEditorVsc.setValue(""),!1}),addTooltip(t,"Clear code in the text editor."),this);e.onBeforeMovedToAnotherWindow=function(){n.destroy()},e.onMovedToAnotherWindow=function(e){n.makeEditor(),n.CodeEditorVsc.layout()}}getValue(){return this.CodeEditorVsc.getValue({preserveBOM:!0})}setValue(e){this.CodeEditorVsc.setValue(e)}focus(){}makeEditor(){const t=this;var e=this.$editor.get(0).ownerDocument.defaultView;this.CodeEditorVsc=monacoInstance.openEditor(null,null,e,this.$element.children(),!0),pinegrow.code_editors.register(this.CodeEditorVsc),this.CodeEditorVsc.updateOptions({wordWrap:"on",contextmenu:!1,lineNumbers:!1,glyphMargin:!1,folding:!1,lineDecorationsWidth:10,lineNumbersMinChars:0,wrappingIndent:"none",automaticLayout:!0}),this.CodeEditorVsc.onDidChangeModelContent(async function(){var e=t.CodeEditorVsc.getValue({preserveBOM:!0});t.onChanged&&t.onChanged(e)}),this.CodeEditorVsc.onDidFocusEditorText(function(){pgEditorAttributeIntellisense.focusedUrl=pinegrow.getSelectedPage().url}),this.CodeEditorVsc.setModel(monaco.editor.createModel(this.CodeEditorVsc.getValue(),"html"))}destroy(){pinegrow.code_editors.unregister(this.CodeEditorVsc),this.CodeEditorVsc.dispose(),this.CodeEditorVsc=null,this.$element.remove()}resized(){this.CodeEditorVsc&&this.CodeEditorVsc.getModel()||(this.CodeEditorVsc&&this.CodeEditorVsc.dispose(),this.makeEditor()),this.CodeEditorVsc&&this.CodeEditorVsc.layout()}}