class PgApi{constructor(){this.preview_elements={}}previewCodeInPage(e,n,t,r){this.clearPreviewCodeInPage(e);var a=r?getPgNodeByPgId(r):pinegrow.getSelectedElement();if(a){var o=a.get$DOMElement();if(o){var i=$(n).attr("data-pg-preview-ref",e);switch(t){case"append":o.append(i);break;case"prepend":o.prepend(i);break;case"insertAfter":i.insertAfter(o);break;case"insertBefore":i.insertBefore(i)}this.preview_elements[e]=i}}}clearPreviewCodeInPage(e){this.preview_elements[e]&&(this.preview_elements[e].remove(),delete this.preview_elements[e])}duplicateElements(e,c,g){var p,d=pinegrow.getCollection(e),u=new PgCollection,f=null,r=(g&&d.orderByDocumentPosition(),!0);if(d.forEachElement(function(e,n,t){e.canDuplicate()||(pinegrow.showQuickError(`Can't duplicate ${e.tagName} element.`),r=!1)}),!r)return u;pinegrow.repeater.repeat(function(l,s){d.forEachElement(function(n,t,e){p=pinegrow.selectedElements.isSelectedElement(n);var r,a,o,i=new pgParserSourceProblem(n);n||i.add("element",n.getName(),"duplicate"),i.ok()?canMakeChange(n,"duplicate_element")&&(r=pinegrow.getCrsaPageOfPgParserNode(n),willMakeChange(n.getPage(),"Duplicate element / "+n.getName()),a=t==e-1&&l==s-1,o=n.clone(),pinegrow.dispatchEvent("on_duplicate_element_async",r,o,function(e){f=f||n,g&&0==t&&(f=d.getLast()),e.insertAfter(f),u.add(e),f=e,a&&(c&&c(u),pinegrow.repeater.done(),pinegrow.changeManager.didInsert(u),p&&(u.getLength()<=12?pinegrow.selectedElements.selectMany(u,!0):pinegrow.selectElement(f)),pgf.kids)&&pinegrow.showQuickMessage("Element duplicated and selected.")})):showAlert(i.toString(),"Can't duplicate this element")})})}removeElements(e){var s=pinegrow.getCollection(e);s.forEachElement(function(r,a,o){var i,l=pinegrow.selectedElements.isSelectedElement(r),e=new pgParserSourceProblem(r);r||e.add("element","Element","remove"),e.ok()?canMakeChange(r,"delete_element")&&(i=r.getPage(),pinegrow.dispatchEvent("on_before_delete_element_async",i,r,function(e){var n,t;e&&(willMakeChange(i,"Delete element / "+r.getName(),r,"delete"),t=null,(n=a==o-1)&&l&&(t=(t=(t=r.next())||r.prev())||r.parent),r.remove(),n)&&(t&&pinegrow.selectElement(t),pinegrow.changeManager.didDelete(s),pinegrow.highlightElement(null))})):showAlert(e.toString(),"Can't remove this element")})}mergeElements(e,r){var n=pinegrow.getCollection(e),a=(n.normalize(),n.orderByDocumentPosition(),new PgCollection),o=r.getPositionInDocument();canMakeChange(r,"insert_element")&&(n.forEachElement(function(e,n,t){e!=r&&canMakeChange(e,"delete_element")&&(e.positionInDocument<o?e.moveChildrenToElement(r,!0):e.moveChildrenToElement(r,!1),e.remove(),a.add(e))}),pinegrow.changeManager.batchChanges(function(){pinegrow.changeManager.didDelete(a),pinegrow.changeManager.didChange(r,"Merge elements")},"Merge elements"),pinegrow.selectElement(r))}splitParent(e){var n=pinegrow.getCollection(e),l=new PgCollection,s=new PgCollection;n.normalize(),n.forEachElement(function(e,n,t){if(e.parent&&e.parent.parent&&canMakeChange(e.parent,"edit_content")&&canMakeChange(e.parent.parent,"insert_element")){for(var r=e.parent.clone(!1,!1,!0),a=(r.insertAfter(e.parent),e.parent.children.indexOf(e)),o=e.parent.children;0<=a&&a<o.length;){var i=o[a];r.append(i)}l.add(r),s.add(e.parent.parent)}}),pinegrow.changeManager.batchChanges(function(){pinegrow.changeManager.didInsert(l),pinegrow.changeManager.didChange(s,"Split element")},"Split element")}insertElements(e,n,c,g){g=g||{},g=$.extend({select:!1,scroll:!1,highlight:!1,repeater:!1,format_html:!1,fix_placement:!1,before_body_scripts:!1,append_before_selector:null,skip_event:!1},g),c=c||"append";var t=g.repeater?pinegrow.repeater.getCount():1,r=pinegrow.getCollection(n),p=new PgCollection,d="append"==c||"prepend"==c,a=!1;if("string"==typeof e){var u=[],o=new pgParser;o.parse(e);for(var i=0;i<t;i++)for(var l=0;l<o.rootNode.children.length;l++)u.push(0==i?o.rootNode.children[l]:o.rootNode.children[l].clone())}else{u=pinegrow.getCollection(e).getList().slice();for(i=1;i<t;i++)pinegrow.getCollection(e).getList().forEach(function(e){u.push(e.clone())})}for(l=0;l<u.length;l++)if(!u[l].isElementOrScript){a=!0;break}function s(){r.forEachElement(function(e,n,t){for(var r,a,o=c,n=0;n<u.length;n++)if(u[n].isElementOrScript&&!canMakeChange(d?e:e.parent,"insert_element",{inserted:u[n]}))return p;if(("append"==o||"prepend"==o)&&!e.canHaveChildren()){if(!g.fix_placement)return void pinegrow.showQuickError(e.getName({short:!0})+` can't have sub-elements.`);o="insertAfter"}g.fix_placement&&0<=["body","head","html"].indexOf(e.tagName)&&("insertAfter"==o||"insertBefore"==o)&&(o="append"),"body"==e.tagName&&"append"==o&&g.before_body_scripts&&(r=!1,u.forEach(function(e){"script"==e.tagName&&(r=!0)}),r||(o=(a=e.findLastNonScriptChild())?(e=a,"insertAfter"):"prepend")),g.append_before_selector&&(a=e.findOne(g.append_before_selector))&&(e=a,o="insertBefore");for(var i=u.slice();i.length;){var l="insertAfter"==o||"prepend"==o?i.length-1:0,s=1<t?i[l].clone():i[l];switch(p.add(s),!m&&s.isElementOrScript&&(m=s),o){case"append":e.append(s);break;case"prepend":e.prepend(s);break;case"insertAfter":s.insertAfter(e);break;case"insertBefore":s.insertBefore(e)}i.splice(l,1)}})}var f,h,m=null,v=new PgCollection,w=(r.forEachElement(function(e,n,t){"insertAfter"==c||"insertBefore"==c?v.add(e.parent):v.add(e)}),v.normalize(),null);a&&(f=new Map,v.forEachElement(function(e){f.set(e,e.html(null,!0)),w=w||e}));return a?(w.withoutEvents(function(){s()}),v.forEachElement(function(e){e.updateInner(f.get(e))}),g.skip_event||pinegrow.changeManager.didChange(v,"Insert elements")):(s(),g.skip_event||pinegrow.changeManager.didInsert(p,null,g.format_html)),g.repeater&&pinegrow.repeater.done(),m&&(h=m.get$DOMElement())&&(g.select?pinegrow.selectElement(h):g.scroll&&m.scrollTo(),g.highlight)&&setTimeout(function(){pinegrow.highlightElement(h)},250),p}pasteAttributes(e,n){for(var t=pinegrow.getCollection(e),r=[],a=$("<span "+n+"></span>"),o=0,i=a[0].attributes,l=i.length;o<l;o++)r.push({name:i[o].nodeName,value:a.attr(i[o].nodeName)});var s=!0;t.forEachElement(function(e){for(var n=0;n<r.length;n++)if(!canMakeChange(e,"attr",r[n].name)){s=!1;break}}),s&&(t.forEachElement(function(e){for(var n=0;n<r.length;n++)e.setAttr(r[n].name,r[n].value)}),pinegrow.changeManager.didChange(t,"Paste attributes"))}setImageUrl(e,t,r,a){var n,o,i,l=pinegrow.getCollection(e);0!==l.getLength()&&(n=!0,l.forEachElement(function(e){canMakeChange(e,"attr",r?"style":"src")||(n=!1)}),n)&&(o=pinegrow.getCurrentProject(),l.forEachElement(function(e){var n=e.getPage().makeRelativeUrl(t);o&&(n=o.mapDOMUrlToSourceUrl(n)),r?e.setInlineBackgroundImage(n):"img"===e.tagName&&e.setAttr("src",n,!1,null,a&&a.event_info?a.event_info:null)}),a&&a.no_change_event||(i=a&&a.event_name?a.event_name:"Set image",pinegrow.changeManager.didChange(l,i,a)))}setAttribute(e,n,t,r){var a,o,i,l=pinegrow.getCollection(e);0!=l.getLength()&&(a="string"==typeof n?[{name:n,value:t}]:n,o=!0,l.forEachElement(function(n){a.forEach(function(e){canMakeChange(n,"attr",e.name)||(o=!1)})}),o)&&(l.forEachElement(function(t){a.forEach(function(e){var n=null;"string"==typeof e.value&&(0<=e.value.indexOf(`"`)&&(n=`'`),0<=e.value.indexOf(`'`))&&(n=`"`),t.setAttr(e.name,e.value,!1,n,r&&r.event_info?r.event_info:null)})}),r&&r.no_change_event||(i=r&&r.event_name?r.event_name:(1==a.length?"Set attribute ":"Set attributes ")+a.map(function(e){return e.name}).join(", "),pinegrow.changeManager.didChange(l,i,r)))}removeAttribute(e,n,t){var r,a,o=pinegrow.getCollection(e);0!=o.getLength()&&(r="string"==typeof n?[n]:n,a=!0,o.forEachElement(function(n){r.forEach(function(e){canMakeChange(n,"attr",e)||(a=!1)})}),a)&&(o.forEachElement(function(n){r.forEach(function(e){n.removeAttr(e)})}),pinegrow.changeManager.didChange(o,(1==r.length?"Remove attribute ":"Remove attributes ")+r.join(", "),t))}getClassSorter(e){var n=e.getPage();return n&&n.classSorter||null}addClass(e,r,n,a){var t,o=this,i=pinegrow.getCollection(e),l=("string"==typeof r&&(r=[r]),!0);i.forEachElement(function(e){for(var n=0;n<r.length;n++)if(!canMakeChange(e,"add_class",r[n])){l=!1;break}}),l&&(i.forEachElement(function(n){var e,t=n.getPage();a&&(e="function"==typeof(e=a)?a(n):e).forEach(function(e){t?t.classSetter.removeClass(n,e,o.getClassSorter(n)):n.removeClass(e,o.getClassSorter(n))}),r.forEach(function(e){t?t.classSetter.addClass(n,e,o.getClassSorter(n)):n.addClass(e,o.getClassSorter(n)),pinegrow.recentClasses.add(e,!0)})}),t=1==r.length?r[0]:r[0]+" + "+(r.length-1)+" more",pinegrow.changeManager.didChange(i,"Add class "+t,n),pinegrow.dispatchEventDelayed("on_element_classes_changed",null,i,n))}getFlexSettings(e){var n,t={flex:!1,inline:!1,direction:!1,grid:!1},r=e.get$DOMElement();return r&&("flex"===(n=r.css("display"))?t.flex=!0:"inline-flex"===n?(t.flex=!0,t.inline=!0):(t.inline=0<=n.indexOf("inline"),t.grid=0<=n.indexOf("grid")),n=r.css("flex-direction"))&&(0<=n.indexOf("row")?t.direction="row":t.direction="column"),t}hasClass(e,n){var t=e.getPage();return t?t.classSetter.hasClass(e,n):e.hasClass(n)}getClasses(e){var n=e.getPage();return n?n.classSetter.getClasses(e):e.getClasses()}removeClass(e,r,n){var t,a=this,o=pinegrow.getCollection(e),i=("string"==typeof r&&(r=[r]),!0);o.forEachElement(function(e){for(var n=0;n<r.length;n++)if(!canMakeChange(e,"remove_class",r[n])){i=!1;break}}),i&&(o.forEachElement(function(n){var t=n.getPage();r.forEach(function(e){pinegrow.classStyles&&pinegrow.classStyles.ensureStyleWithClassIsSelected(n,e),t?t.classSetter.removeClass(n,e,a.getClassSorter(n)):n.removeClass(e,a.getClassSorter(n))})}),t=1==r.length?r[0]:r[0]+" + "+(r.length-1)+" more",pinegrow.changeManager.didChange(o,"Remove class "+t,n),pinegrow.dispatchEventDelayed("on_element_classes_changed",null,o,n))}setClassProperty(e,n,r,t,a){var o=pinegrow.getCollection(e),i=o.getFirst();if(!i)return!1;function l(e){for(var n={},t=0;t<e.length;t++)n[e[t]]=!0;for(t=0;t<r.length;t++)if(n[r[t].key])return r[t].key;return null}var s=t="auto"===t?pinegrow.classStyles.getCurrentStyleForPgel(i):t,c=null,g=!0;if(o.forEachElement(function(e){canMakeChange(e,"add_class",n)||(g=!1)}),g){if(s){if(s.locked)return pinegrow.showQuickError("The style is locked."),!1;c=l(s.getClasses()),pinegrow.makeChanges(i,"Set "+n,function(){pinegrow.classStyles.addClassToStyle(i,s,n,c)},a)}else pinegrow.classStyles.getStylesForPgel(i).length?pinegrow.makeChanges(o,"Set "+n,function(){o.forEachElement(function(e){c=l(pinegrow.classStyles.getInlineClassesForPgel(e)),pinegrow.classStyles.addClassToStyle(e,null,n,c)})},a):this.addClass(o,[n],a,function(e){var n=l(e.getClasses());return n?[n]:[]});return!0}}addAction(e,t,n,r){var a,o=pinegrow.getCollection(e),i=!0;o.forEachElement(function(e){canMakeChange(e,"add_action",t)||(i=!1)}),i&&(a="Add action / "+t.name,o.forEachElement(function(e){var n=!0;(n=!t.on_can_add_action||t.on_can_add_action(e,e.getPage(),t)?n:!1)&&$.fn.crsa("addActionToElement",e,t,e.getPage(),r)}),n&&n.no_change_event||pinegrow.changeManager.didChange(o,a,n))}removeAction(e,n,t){var r,a=pinegrow.getCollection(e),o=!0;a.forEachElement(function(e){canMakeChange(e,"add_action",n)||(o=!1)}),o&&(r="Remove action / "+n.name,a.forEachElement(function(e){$.fn.crsa("removeActionFromElement",e,n,e.getPage())}),t&&t.no_change_event||pinegrow.changeManager.didChange(a,r,t))}changeTag(e,n){var t,r=pinegrow.getCollection(e),a="string"==typeof n?{tag:n}:n,o=(a.change_parent=a.change_parent||[],!0);r.forEachElement(function(e){canMakeChange(e,"delete_element")||(o=!1),e.parent&&a.parent_tag&&e.parent.tagName!=a.parent_tag&&(canMakeChange(e.parent,"insert_element")||(o=!1))}),o&&(t=new PgCollection,r.orderByDocumentPosition(),r.forEachElement(function(e){var n;e=e.replaceTag(a.tag),a.parent_tag&&e.parent&&e.parent.tagName!=a.parent_tag&&((n=e.prev())&&n.tagName==a.parent_tag?e.appendTo(n):0<=a.change_parent.indexOf(e.parent.tagName)?t.add(e.parent):((n=pgCreate("<"+a.parent_tag+"></"+a.parent_tag+">")).insertBefore(e),e.appendTo(n)))}),t.forEachElement(function(e){e.replaceTag(a.parent_tag)}),pinegrow.changeManager.didChange(r,"Change to "+a.tag))}wrapWithElement(e,o,i,l,s){var n=pinegrow.getCollection(e).clone(),c=new PgCollection;n.forEachElement(function(e,n,t){var r,a=new pgParserSourceProblem(e);e||a.add("element",e,"wrap with element"),a.ok()?canMakeChange(e.parent,"insert_element")&&((r=!!i&&i(e))?pinegrow.showQuickMessage(r,4e3,!1,"error"):((r=pgCreateNodeFromHtml(o)).insertBefore(e),r.append(e),l&&l(r,e),s||pinegrow.selectedElements.replace(e,r),c.add(r),n==t-1&&(pinegrow.changeManager.didInsert(c),pinegrow.selectedElements.reselect()))):showAlert(a.toString(),"Can't create the element")})}wrapContentWithElement(e,o,i,l){var n=pinegrow.getCollection(e).clone(),s=new PgCollection;n.forEachElement(function(e,n,t){var r,a=new pgParserSourceProblem(e);e||a.add("element",e,"wrap with element"),a.ok()?canMakeChange(e,"insert_element")&&((r=!!i&&i(e))?pinegrow.showQuickMessage(r,4e3,!1,"error"):(r=pgCreateNodeFromHtml(o),e.moveChildrenToElement(r,!1,!0),e.append(r),l&&l(r,e),s.add(r),n==t-1&&(pinegrow.changeManager.didInsert(s),pinegrow.selectedElements.reselect()))):showAlert(a.toString(),"Can't create the element")})}setInlineStyle(e,n,t){var r,a=pinegrow.getCollection(e);0===a.getLength()||(r="",n.nodes.forEach(function(e){"decl"===e.type&&e.prop.length&&e.value.length?r+=`${e.prop}: ${e.value+(e.important?" !important":"")};`:"comment"===e.type&&(r+=`/* ${e.text} */`)}),this.setAttribute(a,"style",r,t),a=a.getFirst(),t&&t.skip_change_event)||pinegrow.dispatchEvent("on_css_attribute_style_changed",a.getPage(),a,t)}addCSSRuleToStylesheet(e,o,i,l,s,c,g){"object"==typeof e&&(e=o.getSourceForRules(e),e=o.filterSource(e,!0)),o.parseSource(e,function(e,n,r){if(e)s&&s(e),pinegrow.showAlert("<p>Could not insert the CSS rule.</p><p>"+e+"</p>","Error");else{var t=0;if("object"==typeof i){var t=-1,a=i;r.nodes.forEach(function(e){g?pgcssh.insertNodeBefore(e,a):(pgcssh.insertNodeAfter(e,a),a=e),t<0&&(t=e.parent.nodes.indexOf(e))})}else{switch(i){case"append":t=o.getRootNode().nodes.length;break;case"prepend":t=0;break;default:t=i}pgcssh.insertNodesAt(r.nodes,o.getRootNode(),t)}o.regenerateAndSetCssSource(function(){o.getRootNode();for(var e=[],n=0;n<r.nodes.length;n++)e.push(r.nodes[n]);var t="object"==typeof l?l:{action:l||"Add CSS rule"};t.list=[o],pinegrow.dispatchEvent("on_css_source_changed",null,t),s&&s(null,e,c)})}},!1)}overrideCSSVariableOLD(e,n,t,s){var r,a,d=function(e,n,r,a){var t=n.parent.nodes.indexOf(n),o=[];a=a||{};for(var i=t-1;0<=i;i--)u(n.parent.nodes[i])&&(o.push(n.parent.nodes[i].prop),a[n.parent.nodes[i].prop]=n.parent.nodes[i]);function l(e){var n=e.match(/\$[a-z0-9_\-]+/gi);n&&n.forEach(function(e){var n=[],t=!1;r.indexOf(e)<0&&e in a&&(n.push(e),t=!0),n.forEach(function(e){l(a[e].value)}),t&&r.push(e)})}return l(s||n.value),o},u=pgcssh.isVariable,o=pgcssh.getStylesheetForNode(e),i=null,f=[],l=(o==n?(i="append",r="Duplicate"):(r="Override",i=function(e,n,t,r){for(var a,o=[],i={},l=(r=r||{},d(e,t,o,i)),s=n.getRootNode(),c=null,g=null,p=s.nodes.length-1;0<=p;p--)u(s.nodes[p])?(g||(c=s.nodes[p],0<=l.indexOf(s.nodes[p].prop)&&(g=s.nodes[p])),0<=(a=o.indexOf(s.nodes[p].value))&&o.splice(a,1)):"atrule"==s.nodes[p].type&&"import"==s.nodes[p].name&&(c=null);r.used_vars=o,r.used_vars_code="";for(p=o.length-1;0<=p;p--)f.unshift(i[o[p]]),r.used_vars_code=`${o[p]}: ${i[o[p]].value.replace(/ !global/g,"")};`+r.used_vars_code;if(g)return g;if(!c)for(p=0;p<s.nodes.length&&"comment"==s.nodes[p].type;p++)c=s.nodes[p];return c||"prepend"}(o,n,e,a={})),o.getSourceForRules(e)),l=o.filterSource(l,!0);s&&(l=e.prop+`: ${s};`),a&&a.used_vars_code&&(l=a.used_vars_code+l),o!==n&&u(e)&&(l=l.replace(/ !default/g,"")),f.push(e),this.addCSSRuleToStylesheet(l,n,i,{action:r+" "+pgcssh.getNodeDisplayName(e)},t,f)}async overrideCSSVariable(e,l,r,s){function n(e,n,r,a){var t=n.parent.nodes.indexOf(n),o=[];a=a||{};for(var i=t-1;0<=i;i--)p(n.parent.nodes[i])&&(o.push(n.parent.nodes[i].prop),a[n.parent.nodes[i].prop]=n.parent.nodes[i]);function l(e){var n=e.match(c);n&&n.forEach(function(e){var n=[],t=!1;r.indexOf(e)<0&&e in a&&(n.push(e),t=!0),n.forEach(function(e){l(a[e].value)}),t&&r.push(e)})}return l(s||n.value),o}function a(e){for(var n=0;n<d.length;n++)if(d[n].prop==e.prop)return d[n]}function t(e){return e.replace(/ !global/g,"").replace(/ !default/g,"")}async function o(t,e,n){for(var r=0;r<e.length;r++){var a=e[r],o=a.value;if(function(e){if(-1<e.indexOf("(")){var n=getCSSFunctionNameAndParams(e)["name"];if(!t.isBuitInFunction(n))return!0}return!1}(o)){try{o=await async function(a){return new Promise(function(e,n){var t=pinegrow.showAlert("<p><b>"+a.prop+"</b> is using a custom function. Using this function in the value of the custom variable will most likely cause compilation errors.</p><p>Please input the custom value here:</p><p><div class='node-value'></div></p>","Set the variable value","Cancel","Ok",function(){n("delete")},function(){e(r.getValue())}).find(".node-value"),r=new PgInputField("node-value",{type:"text",name:"Value",without_text:!1});r.setValue(a.value),r.appendTo(t)})}(a)}catch(e){if("delete"==e)return!1}a.value=o}n(a)}return!0}var c=new RegExp("\\"+l.getDeclCharachter()+"[a-z0-9_\\-]*","ig"),g=pinegrow.pgPostCSSHelper,p=pgcssh.isVariable,i=pgcssh.getStylesheetForNode(e),d=[],u=[],f=[],h=null;if(i==l&&(h=e.value),i!=l)for(var h=t(e.value),m=l,v=[],w={},C=(n(0,e,v,w),v.length-1);0<=C;C--){var E=w[v[C]];d.unshift(E),u.unshift(g.createNode("decl",v[C],t(E.value),null,m))}var h=g.createNode("decl",e.prop,h,null,l),_=(s&&(h.value=s),u.push(h),d.push(e),[]);if(i==l?await o(l,u,function(e,n){var t=a(e);g.insertNodeInside(e,t.parent),_.push(e),n&&n()}):await o(l,u,function(e,n){var t=a(e),r=g.getNodeLevel(t),t=function(e,n,t){var r=l.getRootNode(),a=r.last;if(!a)return{node:r,fun:g.insertNodeInside};for(var o=null;a;)if("decl"==a.type){var i=g.findNodeInside("decl","prop",a.prop,e.parent);if(!i)return{node:a,fun:g.insertNodeAfter};if(e.prop==a.prop)return null;if(g.getNodeIndices(i)[t]-n<0)return{node:a,fun:g.insertNodeAfter};a=(o=a).prev()}else"import"==g.getNodeType(a)&&(o=a),a=a.prev();return o?{node:o,fun:g.insertNodeBefore}:{fun:g.insertNodeAt,node:r,index:0}}(t,g.getNodeIndices(t)[r],r);null!=t&&(_.push(e),t.fun(e,t.node,t.index)),n&&n()})){for(var S=0;S<_.length;S++)f.push(g.getNodeIndices(_[S]));l.setSourceForRules(l.rootNode,function(){for(var e=[],n=0;n<f.length;n++){var t=g.getNodeByIndices(l.rootNode,f[n]);e.push(t),pinegrow.dispatchEvent("on_css_node_added",null,{node:t,stylesheet:l})}r&&r(e,d)})}}editCSSRule(e){pinegrow.selectRule(e)}extractCSSForElementAndSelector(e,n,t){function r(e,n){e.rootNode&&d(e,e.rootNode,n),e.importedFiles&&e.importedFiles.forEach(r)}var a=e.getPage(),l="",s=new RegExp(`^${escapeRegExp(n)}($|[\\s>])`,"gm"),c=[],g=[],p=function(e){for(var n="",t=e;t<c.length;t++)n+=c[t]+" {\n";return n},d=function(n,e,t){if("rule"!==e.type||e.selector!==t&&!e.selector.match(s))e.nodes&&("atrule"===e.type&&c.push(`@${e.name} `+e.params),e.nodes.forEach(function(e){d(n,e,t)}),"atrule"===e.type)&&c.pop();else{for(var r=0,r=0;r<c.length&&g[r]===c[r];r++);for(var a=r;a<g.length;a++)l+="}\n";g=c.slice(0);var o=p(r),i=n.getSourceForRules(e);l+=o+"\n"+i}};a.stylesheets.stylesheets.forEach(function(e){(e=e.sourceStylesheet?e.sourceStylesheet:e).loaded&&(console.log(e.rootNode),r(e,n))});for(var o=0;o<g.length;o++)l+="}\n";var i=require("postcss");(0,i.postcss)().process(l,{syntax:i.postcssSCSS,parser:i.postcssSCSS,stringifier:i.postcssSCSS.stringify}).then(function(e){var n=e.root,n=(pgcssf.updateNodeRaws(n,!1,{},!0,null),pinegrow.pgPostCSSHelper.getSource(n,i.postcssSCSS.stringify));t(n)})}extractComponent(e,n){function t(){n&&n(i)}var r=e.getAttr("data-pgc-define"),a=e.getAttr("data-pgc-define-extract-css"),o=e.getPage(),i={html:e.toStringOriginal(!0)},o=o.sourceNode.findOne(`script[data-pgc-define-script="${r}"]`);o&&(i.js=o.html());a?this.extractCSSForElementAndSelector(e,a,function(e){i.css=e,t()}):t()}transformElement(e,r){var n=pinegrow.getCollectionForElement(e);pinegrow.makeChanges(n,"Transform element",function(){n.forEachElement(function(n){var t;n&&("svg"===(t=r.clone()).tagName&&["id","class","style","width","height"].forEach(function(e){n.hasAttribute(e)&&t.setAttribute(e,n.getAttribute(e))}),n.replaceWith(t),pinegrow.selectedElements.replace(n,t))})}),0<n.getLength()&&pinegrow.changeManager.didChange(n,"Replace")}moveUpOrDown(e,a){var o=pinegrow.getCollection(e),i=new PgCollection,n=a?"Move up":"Move down";o.normalize(),a||o.reverse(),o.forEachElement(function(e,n,t){var r;e.parent&&e.parent.parent&&canMakeChange(e.parent,"edit_content")&&(a?(r=e.prev())?(o.contains(r)?e.insertAfter(r):e.insertBefore(r),i.add(e.parent)):pinegrow.showQuickError("The element is already at the top."):(r=e.next())?(o.contains(r)?e.insertBefore(r):e.insertAfter(r),i.add(e.parent)):pinegrow.showQuickError("The element is already at the bottom."),n===t-1)&&e.scrollTo()}),0<i.getLength()&&pinegrow.changeManager.didChange(i,n)}moveUp(e){return this.moveUpOrDown(e,!0)}moveDown(e){return this.moveUpOrDown(e,!1)}}