var PgPageTreeManager=function(){var e=new PgEventHandler;e.on_event=function(e){e.page.tree&&e.page.tree.handleEvent(e)},e.start(),this.destroy=function(){e.destroy()}},PgTreeView=function(){pinegrow.registerTreeView(this);function F(e,n){var i=!0,a=!1,o=0,t=null;b(e,function(e){(t=pinegrow.getCollection(e)).forEachElement(function(e){o++;var t=e[n]();i=i&&t,a=a||t})}),i||(1==o?pinegrow.showQuickMessage("The element could not be moved."):pinegrow.showQuickMessage("Some elements could not be moved.")),a&&pinegrow.changeManager.didChange(t,"Level "+n)}var t,n,g,i,a,p,o=$("<div/>",{id:"pg-tree",class:"pg-tree"}),L=$("<div/>",{class:"pg-tree-container"}).appendTo(o),e=new PgSearchBox({toolbar_on:!pgf.kids}),l=(pgf.kids||(e.addIcon({icon:"icon-130",label:"Select search results",func:function(){B("select")}}),e.addIcon({icon:"icon-137",label:"Add search results to selection",func:function(){B("add")}}),e.addIcon({icon:"icon-138",label:"Deselect search results",func:function(){B("deselect")}})),this.toolbar=e.getToolbar()),s=(pgf.kids?e.$element.css({"margin-right":"10px"}):l.addSection("settings").$element,new PgButtonToolbarItem("icon-filter","Select what kind of elements to show in the tree.")),r=(pgf.kids||l.addItem("settings",s),{styles:{label:"Inline styles",desc:"Show only the elements with inline styles"},images:{label:"Images",desc:"Show only images"},links:{label:"Links",desc:"Show only links"},texts:{label:"Texts",desc:"Show only the elements with textual content"},components:{label:"Components &amp; Editable",desc:"Show only components and editable areas"}}),c=((pinegrow.hasActivatedProduct("WP")||pinegrow.isTrial())&&(r.wp={label:"WordPress actions",desc:"Show only the elements with WordPress actions"}),(pinegrow.hasActivatedProduct("WC")||pinegrow.isTrial())&&(r.wc={label:"WooCommerce actions",desc:"Show only the elements with WooCommerce actions"}),!1),d=((pinegrow.hasActivatedProduct("IA")||pinegrow.isTrial())&&(r.ia={label:"Interactions",desc:"Show only the elements with Interactions"},c="1"===pinegrow.getSetting("pgia-show-in-tree","1")),pgf.components||delete r.components,{}),u=($.each(r,function(e,t){d[e]=!1}),d),h=(s.onClick=function(){var n=new CrsaContextMenu(null,this.$element);n.add({type:"header",label:"Filter (show el. with):"}),$.each(r,function(t,e){n.add({label:e.label,action:function(){var e=!(!0===u[t]);_.setFilterOption(e?t:null)},check:!0===u[t]})}),n.add({type:"divider"}),n.add({label:"Clear filter",action:function(){_.setFilterOption(null)}}),n.add({type:"divider"}),n.add({type:"header",label:"Settings"}),(pinegrow.hasActivatedProduct("IA")||pinegrow.isTrial())&&n.add({label:"Show interactions",action:function(){c=!c,pinegrow.setSetting("pgia-show-in-tree",c?"1":"0"),i.tree.setShowInteractions(c),i.tree.create(),T(i)},check:!0===c}),n.showForElement(this.$element,null,8)},this.setFilterOption=function(e,t){var n;u=$.extend({},d),e?(n=r[e],u[e]=!0,s.setActive(!0),pinegrow.showMode(n.desc,!0),V(n.label)):(s.setActive(!1),V()),i.tree.setFilterOptions(u),t||g&&g.tree.research(!0)},new PgButtonToolbarItem("icon-down","Tree options (Source or DOM, auto collapse...)")),f=(pgf.kids||l.addItem("settings",h),"1"===pinegrow.getSetting("tree-dom-mode","0")),m=parseInt(pinegrow.getSetting("tree-auto-collapse",(isApp(),0))),W=(h.onClick=function(){var e=[{type:"header",label:"Show"},{label:"Source code structure",help:"Show the page structure as defined in the source code.",check:!f,action:function(){f=!1,pinegrow.showMode("Show source code structure",!0),pinegrow.setSetting("tree-dom-mode",f?"1":"0"),i.tree.setDomMode(f),i.tree.create(),T(i)}},{label:"DOM structure",help:"Show the current DOM browser structure.",check:f,action:function(){f=!0,pinegrow.showMode("Show DOM structure",!0),pinegrow.setSetting("tree-dom-mode","1"),i.tree.setDomMode(f),i.tree.create(),T(i)}},{type:"divider"},{type:"header",label:"Options"},{label:"Auto collapse",check:0<m,submenu:[0,"Off",1,2,3,4,5].map(function(e){return 0===e?{type:"header",label:"Collapse from level"}:{label:e,action:function(){m="Off"===e?0:e,pinegrow.setSetting("tree-auto-collapse",m),i.tree.setAutoCollapse(m),i.tree.create(),T(i),pinegrow.showMode("Auto collapse tree","Off"!==e)},check:m===("Off"===e?0:e)}})}];return new CrsaContextMenu(e,h.$element).showForElement(h.$element),!1},e.$element.find(".pg-button-toolbar-section.icons")),B=(pgf.kids||(e.$element.appendTo(o),(new PgSearchBoxSpacer).$element.appendTo(o)),e.onSearch=function(e){var t=new CrsaProfile;g&&g.tree.search(e),e.length?pg$Show(W,"inline-block"):pg$Hide(W),t.show("SEARCH")},pg$Hide(W),function(e){var n=new PgCollection;D.data.forEach(function(e){var t;1===e.search&&(t=_.getPgel(e))&&n.add(t)});"select"==e&&pinegrow.selectedElements.clear(),"deselect"==e?pinegrow.selectedElements.deselectMany(n):pinegrow.selectedElements.selectMany(n)}),v=$('<div class="pg-tree-filter-msg"><div>Show only: <span></span><i class="close icon icon-close"></i></div></div>').appendTo(o),V=(pg$Hide(v),v.on("click",function(e){e.preventDefault(),_.setFilterOption(null)}),function(e){e?(v.find("span").html(e),pg$Show(v,"flex"),o.addClass("with-filter-msg")):(pg$Hide(v),o.removeClass("with-filter-msg"))}),w=(pgf.auto_focus&&((t=$('<div class="pg-tree-filter-msg"><div>Focus on: <span></span><i class="icon icon-down"></i></div><label><input type="checkbox" name="checkbox" value="1"'+(pinegrow.getAutoFocus()?" checked":"")+">Auto-focus on sections</label></div>").appendTo(o)).find("> div").on("click",function(e){e.preventDefault();var t,n=$(this),i=pinegrow.getSelectedPage();return i?(t=[],pinegrow.getIsolatedElement(i)&&(t.push({label:"Show whole page",action:function(){pinegrow.isolateElement(null)}}),t.push({type:"divider"})),t.push({type:"header",label:"Focus on:"}),t.push({label:"Page structure",action:function(){pinegrow.isolateElement(i.sourceNode.findOne("body"),{tree_hide_scripts:!0,drag_drop_only_top_level:!0})}}),i.sourceNode.find("header,footer,section").forEach(function(e){t.push({label:e.getName({short:!0}),action:function(){pinegrow.isolateElement(e,{},!0),pinegrow.selectElement(e),e.scrollTo()}})}),new CrsaContextMenu(t,n).showForElement(n)):pinegrow.showQuickError("Please open a page first"),!1}),t.find("input").on("change",function(e){var t=$(this).is(":checked");pinegrow.setAutoFocus(t)}),n=function(e){e?(t.find("> div").html(`Focus on <span>${e}</span><i class="icon icon-down"></i>`),t.removeClass("inactive")):(t.find("> div").html(`Whole page is displayed<i class="icon icon-down"></i>`),t.addClass("inactive"))}),o.find(".editor"),this.view=new PgUIView(o,"tree","Tree")),_=(w.classForContainer="pg-tree-panel-container",this),G=(w.tabIcon="icon-Pin11",new PgPageTreeManager),b=(w.onShow=function(){g&&g.tree.scrollToSelected&&(D.scrollToDelayed(g.tree.scrollToSelected),g.tree.scrollToSelected=null)},function(e,t,n){var i=_.getPgelOfDataItem(e);i&&(pinegrow.selectedElements.isSelectedElement(i)&&!n?t(pinegrow.selectedElements.getCollection()):t(i))}),R=function(e){b(e,function(e){var t=e instanceof pgParserNode?e:e.getFirst();t.isHidden()?pinegrow.getCollection(e).forEachElement(function(e){e.show()}):(t.scrollTo(),setTimeout(function(){pinegrow.highlightElement(t.get$DOMElement())},50))})},j=function(e,t){"svg"===e.tagName?t?e.removeAttr("data-pg-collapsed"):e.setAttr("data-pg-collapsed","false"):t?e.setAttr("data-pg-collapsed"):e.removeAttr("data-pg-collapsed"),pinegrow.dispatchEventDelayed("on_elements_collapsed_expanded",e.getPage())},l=[],e=!0,I=(pgf.edit_html&&e&&(l.push({icon:"icon-bin",name:"Delete",func:function(e){b(e,function(e){(new PgApi).removeElements(e)})},show:function(e,t){var n=t.pgel||_.getPgelOfDataItem(e);return(t.pgel=n)&&n.canDelete()}}),l.push({icon:"icon-duplicate",name:"Duplicate",func:function(e){b(e,function(e){(new PgApi).duplicateElements(e)})},show:function(e,t){var n=t.pgel||_.getPgelOfDataItem(e);return(t.pgel=n)&&n.canDuplicate()}})),e&&!pgf.kids&&l.push({icon:"icon-hide",name:"Hide / show in Pinegrow",key:"hide",func:function(e,i){b(e,function(e){var t=pinegrow.getCollection(e),n=i.find("i").hasClass("icon-hide");t.forEachElement(function(e){n?e.hide():e.show()}),i.find("i").removeClass("icon-hide icon-see").addClass(n?"icon-see":"icon-hide")})}}),pgf.edit_html&&!pgf.kids&&(l.push({icon:"icon-up",name:"Move up",func:function(e){var t=new PgApi;b(e,function(e){t.moveUp(e)})},show:function(e,t){var n=t.pgel||_.getPgelOfDataItem(e);return(t.pgel=n)&&n.canMove()}}),l.push({icon:"icon-down",name:"Move down",func:function(e){var t=new PgApi;b(e,function(e){t.moveDown(e)})},show:function(e,t){var n=t.pgel||_.getPgelOfDataItem(e);return(t.pgel=n)&&n.canMove()}}),l.push({icon:"icon-131",name:"Indent one level",func:function(e){F(e,"indent")},show:function(e,t){var n=t.pgel||_.getPgelOfDataItem(e);return(t.pgel=n)&&n.canMove()}}),l.push({icon:"icon-132",name:"Outdent one level",func:function(e){F(e,"outdent")},show:function(e,t){var n=t.pgel||_.getPgelOfDataItem(e);return(t.pgel=n)&&n.canMove()}}),l.push({icon:'<i class="icon icon-Ins_before"><span class="path1"></span><span class="path2"></span></i>',name:"Insert before",func:function(e){S(e,"insertBefore")},show:function(e,t){var n=t.pgel||_.getPgelOfDataItem(e);return(t.pgel=n)&&n.canHaveSiblings()}}),l.push({icon:'<i class="icon icon-Ins_after"><span class="path1"></span><span class="path2"></span></i>',name:"Insert after",func:function(e){S(e,"insertAfter")},show:function(e,t){var n=t.pgel||_.getPgelOfDataItem(e);return(t.pgel=n)&&n.canHaveSiblings()}}),l.push({icon:'<i class="icon icon-Append"><span class="path1"></span><span class="path2"></span></i>',name:"Insert into at beginning (prepend)",func:function(e){S(e,"prepend")},show:function(e,t){var n=t.pgel||_.getPgelOfDataItem(e);return(t.pgel=n)&&n.canHaveChildren()}}),l.push({icon:'<i class="icon icon-Prepend"><span class="path1"></span><span class="path2"></span></i>',name:"Insert into at end (append)",func:function(e){S(e,"append")},show:function(e,t){var n=t.pgel||_.getPgelOfDataItem(e);return(t.pgel=n)&&n.canHaveChildren()}})),pgf.kids||l.push({icon:"icon-right",name:"Collapse / Expand all",func:function(e){var n,t=!_.getPgelOfDataItem(e).isCollapsed();n=t,D.forEachDataAndDescendants(e,function(e){e.collapsed=n;var t=_.getPgel(e);t&&j(t,e.collapsed)}),D.refresh()}}),new PgTreeNodeMenu(l)),D=(I.hide(),this.setPage=function(e){i=e},new PgTableGrid),P=(pgf.kids&&D.$element.css("top",0),D.draggable=pgf.edit_html,null),Y=(this.getPgel=function(e){return this.getPgelOfDataItem(e)},D.onScroll=function(){P&&P.updatePosition(),N()},L.append(D.$element),I.$element.appendTo(o),D.setTemplate('<div><i data-element="icon" class="collapse-icon icon-down"></i><name data-element="name"></name><i data-element="hidden" class="icon icon-hide show-hide"></i></div>'),D.setTemplate('<div><i data-element="icon" class="collapse-icon icon-113"></i><name data-element="name"></name><div data-element="progress" class="pgia-progress"></div></div>',"interaction"),D.setTemplate('<div><i data-element="icon" class="collapse-icon icon-Scene_Scroll"></i><name data-element="name"></name><div data-element="progress" class="pgia-progress"></div></div>',"scrollscene"),D.onSetDataToCell=function(e,t){_.populateDataItem(e),"interaction"===t.type||"scrollscene"===t.type?(t.setHtml("name",e.name),t.getElement("progress").style.width="0",pgInteractionsTreeCellManager.register(e.pgia.id,t),n=t.getElement("name"),e.pgia.desc?(n.setAttribute("title",e.pgia.desc),n.classList.add("has-desc")):(n.removeAttribute("title"),n.classList.remove("has-desc"))):(t.setHtml("name",e.name),(e.selected||!1)!==(t.isSelected||!1)&&(e.selected?t.$element.addClass("selected"):t.$element.removeClass("selected"),t.isSelected=e.selected),n=null,D.hasChildren(e)?e.collapsed?(n="icon-right",t.$element.addClass("collapsed")):(n="icon-down",t.$element.removeClass("collapsed")):(n=e.icon||"icon-minus",t.$element.removeClass("collapsed")),n!==(t.icon_cls||"icon-down")&&(t.removeClass("icon",t.icon_cls||"icon-down"),t.addClass("icon",n),t.icon_cls=n),e.hide_in_pg?(t.getElement("hidden").style.display="block",t.$element.addClass("hide-in-pg")):e.hide_in_pg_child?(t.getElement("hidden").style.display="none",t.$element.addClass("hide-in-pg")):(t.getElement("hidden").style.display="none",t.$element.removeClass("hide-in-pg")),e.pgel?t.$element.removeClass("dyn"):t.$element.addClass("dyn"),pgf.focus_in_tree||(e.focused?t.$element.addClass("focused"):t.$element.removeClass("focused")));var n=e.search||0;t.$element.removeClass("search-1 search-2 search-0").addClass("search-"+n)},D.onRepaint=function(){I.setBottom(D.getHScrollBarSize()),I.setRight(D.getVScrollBarSize()),N()},this.getPgelOfDataItem=function(e){if(e.pgid)return getPgNodeByPgId(e.pgid);if(e.dyn_element){var t=getElementPgNode($(e.dyn_element));if(t)return e.pgid=t.getId(),g&&g.tree&&(g.tree.treeData_PgIdMap[e.pgid]=e),t}return null},null),q=-1,y=(this.populateDataItem=function(e,t,n){var i,a,o;e.populated||(e.populated=!0,(n=n||e.pgel||_.getPgelOfDataItem(e))?((a=g.getMainType(null,n))&&(o=g.getActionTag(n),(o={def:a,num_classes:0<=q?q:o?1:2,action_tag:o,classes_filter:Y}).name=n.getAttr("data-pg-name"),n.parent&&n.parent.rootNode&&!n.dynamic&&(i=n.getPage())&&(o.name=o.name?"<pagename>"+i.getName()+"</pagename> / "+o.name:"<pagename>"+i.getName()+"</pagename>"),e.name=n.getName(o),e.search_string=o.search_string||"",a.tags,i=g.getActionTag(n,!0))&&(e.search_string+=":"+i),n.getAttribute("style")&&!pgf.kids&&(e.name+=' <icons><i class="inline-styles icon icon-Pin15" title="Inline style is set. Click to edit it in the Style panel."></i></icons>'),e.pgel=n,e.hide_in_pg=n.hasAttr("data-pg-hidden")):(a=Q(e))&&(o={},e.name=pgGetDOMElementName(a,!0,!0,o),e.search_string=o.search_string))},null),E=null,S=(this.markInsertPositionInTree=function(e,t,n){var i,a,o,l;e instanceof pgParserNode?g==e.getPage()&&(i=g.tree.getTreeDataItemForPgId(e.getId()),t=function(e){switch(e){case"left":case"top":return"insertBefore";case"right":case"bottom":return"insertAfter";case"inside-top":case"inside-left":return"prepend";case"inside-bottom":case"inside-right":return"append"}return e}(t)):i=e,i&&!i.hidden?(l=0,"insertBefore"==t?(a=i.visible_idx,o=i.level):"insertAfter"==t?(a=i.visible_idx+1+D.getNumberOfDescendants(i.visible_idx,D.visibleData),o=i.level):"prepend"==t?(a=i.visible_idx+1,o=i.level+1,l=1):"append"==t&&(a=i.visible_idx+1+D.getNumberOfDescendants(i.visible_idx,D.visibleData),o=i.level+1,l=1),"self"===t?(D.showInsertionLineAt(-1),D.setEmptyLineAt(-1)):(D.showInsertionLineAt(a,o),D.setEmptyLineAt(a)),D.borderItem(i,l),n||D.scrollTo(i)):(D.showInsertionLineAt(-1),D.setEmptyLineAt(-1),D.borderItem(null))},this.markRangeInTree=function(e,t){var n,i,a;return e&&t&&g==e.getPage()&&(n=g.tree.getTreeDataItemForPgId(e.getId()),i=g.tree.getTreeDataItemForPgId(t.getId())),n&&!n.hidden&&i&&!i.hidden?(a=1+D.getNumberOfDescendants(n.visible_idx,D.visibleData),e!=t&&(a=i.visible_idx-n.visible_idx+D.getNumberOfDescendants(i.visible_idx,D.visibleData)+1),D.scrollTo(n),D.borderItem(n,!1,a)):(D.borderItem(null),!1)},function(e,t){if(!e)return!1;var n=_.getPgel(e);if(!n)return!1;y=t;function i(){_.markInsertPositionInTree(e,y)}function a(e){e==g&&(D.updateDataIndexes(),i(),P.updatePosition())}pgQuickWindowManager.close("quickInsert"),E=e,i(),D.quickInsertLine.hide();var o=new PgQuickInsert(n,t,!1,D.$insertionLine);(P=new PgConnector).$from=D.$insertionLine,P.toOffset=0,P.$to=o.getWindow().$element,pinegrow.connectors.add(P),o.getWindow().onMoveDrag=o.getWindow().onMove=o.getWindow().onResize=function(){P.updatePosition()};pinegrow.addEventHandler("on_page_changes_done",a),o.getLib().onBeforeInserted=function(){"prepend"!=y&&"append"!=y||!e.collapsed||(e.collapsed=!1,n.removeAttr("data-pg-collapsed"))},o.getWindow().onDestroy=function(){P.destroy(),P=null,D.setEmptyLineAt(-1),D.showInsertionLineAt(-1),D.borderItem(null),E=null,pinegrow.removeEventHandler("on_page_changes_done",a)}}),k=function(e){var t=$(e.currentTarget).closest("div");return D.visibleData[parseInt(t.attr("data-visible-idx"))]},z=function(e){var t=k(e);return _.getPgelOfDataItem(t)},Q=function(e,t){t=t||g.get$Html().get(0);var n,i=e.treeId;if(i&&t){if(t.getAttribute("data-pg-tree-id")==i)return t;n=t.querySelector('[data-pg-tree-id="'+i+'"]')}if(e.pgid){if(t.getAttribute("data-pg-id")==e.pgid)return t;n=t.querySelector('[data-pg-id="'+e.pgid+'"]')}return n},C=(this.isOverTree=function(e,t){return(!t||"html"===t.dragType)&&w.getWindow()===e.view&&w.isVisible()&&e.pageX>=a.left&&e.pageX<=a.right-(I.isHidden()?0:I.width+D.getVScrollBarSize())&&e.pageY>=a.top&&e.pageY<=a.bottom?{left:e.pageX-a.left,top:e.pageY-a.top}:null},this.getDropPositionInfo=function(e,t,n){var i,a,o=D.dragOver(n);return o&&(o.data.pgid||(o.invalid="Dyn element","bottom"==o.position?(i=o.data.visible_idx,(a=D.visibleData.length>i?D.visibleData[i]:null)&&a.level==o.data.level&&a.pgid?(o.data=a,o.position="top",o.invalid=!1):a&&a.level<o.data.level&&(a=D.getParentWithLevel(i,o.data.level-1))&&a.pgid&&(o.data=a,o.position="inside-bottom",o.invalid=!1)):"top"==o.position&&((a=0<=(i=o.data.visible_idx)-1?D.visibleData[i-1]:null)&&a.level==o.data.level&&a.pgid?(o.data=a,o.position="bottom",o.invalid=!1):a&&a.level<o.data.level&&a.pgid&&(o.data=a,o.position="inside-top",o.invalid=!1)),o.data.pgid))&&(o.target_pgel=getPgNodeByPgId(o.data.pgid),o.$e=o.target_pgel.get$DOMElement()),D.showInsertionPoint(o),o},D.$container.on("contextmenu",".pg-table-grid-cell",function(e){var t,n;return e.preventDefault(),e.stopPropagation(),pgf.kids||(t=k(e),n=z(e),t&&"interaction"===t.template_type)||(n?pinegrow.showContextMenuForElement(n,e,$(this),D.$container.closest(".pg-tree-container")):pgDynElementMessage("Can't edit dynamic elements.")),!1}).on("mouseover",".pg-table-grid-cell",function(e){var t;D.inScroll||(t=k(e),pinegrow.getDragMenu())||(t=_.getPgelOfDataItem(t))&&pinegrow.highlightElement(t.get$DOMElement()),e.stopImmediatePropagation()}).on("mouseout",".pg-table-grid-cell",function(e){D.inScroll||pinegrow.getDragMenu()||pinegrow.highlightElement(null),e.stopImmediatePropagation()}).on("click","i.collapse-icon",function(e){var n=k(e),t=_.getPgelOfDataItem(n);n.collapsed=!(n.collapsed||0),t&&(j(t,n.collapsed),"head"==t.tagName)&&(t.getPage().show_head_in_tree=!n.collapsed),e.altKey&&D.forEachVisibleSibling(n,function(e){e.collapsed=n.collapsed;var t=_.getPgel(e);t&&j(t,e.collapsed)}),D.refresh(),e.preventDefault(),e.stopPropagation()}).on("click","i.icon-hide",function(e){var t=k(e);R(t),e.preventDefault(),e.stopPropagation()}).on("click",".pg-table-grid-cell",function(e){var t=z(e),n=k(e);if($("#crsa-dummy-field").get(0).focus(),t)if(M)S(n,M);else{var i=!1,a={stop:!1,multi:crsaIsCmdPressed(e),source:"tree",event:e,tree_data:n};if(pinegrow.dispatchEvent("on_element_clicked",g,t,null,a),a.stop)i=!0;else if(e.shiftKey){var o=!1,a=pinegrow.selectedElements.getLastSelectedOnPage(g);if(a){for(var l,s=g.tree.getTreeDataItemForPgId(a.getId()),r=s.visible_idx>n.visible_idx?-1:1,c=new PgCollection,d=s.visible_idx+r;d!==n.visible_idx+r;d+=r)D.visibleData[d].level==s.level&&(l=_.getPgelOfDataItem(D.visibleData[d]))&&(c.add(l),o=!0);t.scrollTo(),o&&pinegrow.selectedElements.selectMany(c),i=!0,o||pinegrow.showQuickMessage("SHIFT + Click can only select elements on the same level.")}}i||(pinegrow.selectElement(t,"tree",crsaIsCmdPressed(e)),t.scrollTo(),$(e.target).is(".inline-styles")&&(pinegrow.showUIPanel("style",!1),pinegrow.activeCSSView.updateRulesDisplayOnElementSelect(!0)))}else pgDynElementMessage(M?"Can't edit dynamic elements.":"Can't select a dynamic element.");e.stopImmediatePropagation(),e.preventDefault(),$("body").trigger("click")}),new PgDragHelper(o,".pg-table-grid-cell",null,!0)),U=(C.onGetDragImage=function(){return"none"},C.onBefore=function(e){return!!pgf.edit_html&&!g.tree.getDataFor$Element(e).no_sort},C.on("dragStart",function(e,t,n){$.fn.crsapages("showOverlays");for(var i=g.tree.getDataFor$Element(C.movedElement),a=i.pgid,a=getPgNodeByPgId(a),o=g.getMainType(null,a),l=(p=new PgDragMenu(o,!0,!0,null,a),$('<div class="pg-tree-drag-container with-tree"></div>')),s=D.getNumberOfDescendants(i.idx,D.data)+1,r=i.level,c=0;c<s&&4!=c;c++){var d=D.createCellForData(D.data[i.idx+c]);d.setData(D.data[i.idx+c]),D.onSetDataToCell(D.data[i.idx+c],d),d.showAt((d.data.level-r)*D.levelPadding,c*D.cellHeight,l)}4<s&&$('<div class="pg-table-grid-cell"><name>+ '+(s-4)+" more</name></div>").appendTo(l).css({top:4*D.cellHeight+"px",left:(D.data[i.idx+4].level+1-r)*D.levelPadding+"px"}),l.css("height",Math.min(s,5)*D.cellHeight),p.addElement(l),p.movedPgel=a,p.pgel=a,D.dragStarted(i),p.handleMoveEvent(n,p),I.hide()},this),C.on("drag",function(e,t,n){p.handleMoveEvent(n,p)},this),C.on("dragStop",function(e,t){$.fn.crsapages("showOverlays",!0),D.dragStopped(),p.insert(),p.destroy(),p=null,crsaFuncs.showInsertionLine(null),pinegrow.highlightElement(null),D.showInsertionPoint(null)},this),function(){a=D.$element.get(0).getBoundingClientRect()}),X=(w.onResize=function(){U(),D.onRepaint(),D.show(),I.updateLayout()},w.onDestroy=function(){pinegrow.unregisterTreeView(_),pinegrow.removeEventHandler("on_page_changed",X),pinegrow.removeEventHandler("on_page_loaded",x),pinegrow.removeEventHandler("on_page_refreshed",x),pinegrow.removeEventHandler("on_page_selected",Z),pinegrow.removeEventHandler("on_drag_drop_operation_done",ee),pinegrow.removeEventHandler("on_page_frameworks_changed",J),pinegrow.removeEventHandler("on_element_isolated",K),G.destroy(),o.off("mousemove",ne),o.off("mouseleave",ie),o.off("mouseenter",ae)},function(e,t,n){}),T=function(e){var t;(g=e)?(Y=e.tree.options.classes_filter,q=e.tree.options.num_classes,pinegrow.pageHasIsolatedElement(e)?(h.hide(),pgf.focus_in_tree&&(t=pinegrow.getIsolatedElement(),n(t.getName({short:!0})))):(pgf.focus_in_tree&&n(null),h.show()),e.tree.setShowInteractions(c),e.tree.setFilterOptions(u),e.tree.setTreeView(_),e.tree.setTableGrid(D),f!==e.tree.getDomMode()?(e.tree.setDomMode(f),e.tree.setAutoCollapse(m),e.tree.create()):(t=pinegrow.selectedElements.getLastSelectedOnPage(e))?(A=e.tree.getTreeDataItemForPgId(t.getId()),I.show(),N()):(A=null,I.hide())):(A=null,D.setData([]),I.hide()),_.setPage(e),I.updateLayout()},x=function(e){e.tree.setShowInteractions(c),e.tree.setDomMode(f),e.tree.setAutoCollapse(m),e.tree.create(),e===g&&T(e)},J=function(e){e&&e.tree&&e.tree.create(),(e&&e===g||null===e&&g)&&g&&g.tree&&T(g)},K=function(e,t){(e=e||g)&&e.tree&&(e.tree.create(),T(e))},Z=function(e){w.whenVisible(function(){U(),T(e)})},ee=function(e,t){D&&D.dragStopped()},A=null,O=null,te=new PgMouseSpeed,M=null,H=null,ne=function(e){var t,n,i,a,o,l,s,r,c=_.isOverTree(e);te.track(e),A&&I.isHidden()&&I.show(),M=null,D.quickInsertLine.show(null),H&&(clearTimeout(H),H=null),c&&g&&(n=(t=D).getScrollOffset(),c.top+=n.top,c.left+=n.left,-2==(i=t.getVisibleDataIndexForY(c.top))&&(i=t.getVisibleDataIndexForY(c.top-t.cellHeight)),s=t.visibleData[i],o=Math.max(0,Math.floor(c.left/t.levelPadding)-1),r=D.getDragPos(),p&&r||(t.highlightLevel(i,o),!pgf.edit_html)||pgf.kids||!s||pinegrow.getDragMenu()||s.no_insert||(r=4,a=null,o=s.level,l=t.getYForVisibleDataIndex(i),c.top<=l+r?a="insertBefore":c.top>=l+t.cellHeight-r&&(!(l=t.visibleData.length>s.visible_idx+1?t.visibleData[s.visible_idx+1]:null)||l.level<=s.level?a="insertAfter":(a="prepend",o=s.level+1)),!a)||E&&(E==s&&y==a||E.visible_idx==s.visible_idx+1&&"insertBefore"==y&&("insertAfter"==a||"prepend"==a)||E.visible_idx==s.visible_idx-1&&("insertAfter"==y||"prepend"==y)&&"insertBefore"==a)||(H=setTimeout(function(){M=a,t.quickInsertLine.show(s,o,"insertBefore"==a?"top":"bottom")},450)),p||(s=t.visibleData[i],t.getYForVisibleDataIndex(i),n.top,r=t.getCellForData(s),O!=r&&I.isOverMenu(c)))},ie=function(e){D.highlightLevel(-1),D.quickInsertLine.hide(),H&&(clearTimeout(H),H=null),I.hide(),O&&O.$element.removeClass("hovered"),O=null},ae=function(e){A&&I.show()},N=(o.on("mousemove",ne),o.on("mouseleave",ie),o.on("mouseenter",ae),pinegrow.addEventHandler("on_page_changed",X),pinegrow.addEventHandler("on_page_loaded",x),pinegrow.addEventHandler("on_page_refreshed",x),pinegrow.addEventHandler("on_page_selected",Z),pinegrow.addEventHandler("on_drag_drop_operation_done",ee),pinegrow.addEventHandler("on_element_isolated",K),pinegrow.addEventHandler("on_page_frameworks_changed",J),function(){var e;A&&(e=D.getScrollOffset(),e=D.getYForVisibleDataIndex(A.visible_idx)-e.top,I.showFor(e,e+D.cellHeight,A.selected||!1,A))});this.onSelected=function(e){A=e;var t,n,i,a,o=this.getPgel(e);o&&(t=I.find("hide"),n=t.data("icon")||t.get(0).querySelector("i"),t.data("icon",n),a=o.isHidden()?(i="icon-see","icon-hide"):(i="icon-hide","icon-see"),!n.classList.contains(a)&&n.classList.contains(i)||fastdom.mutate(function(){n.classList.remove(a),n.classList.add(i)})),N()},this.onDeselected=function(e){pinegrow.selectedElements.hasSelection()||(A=null,I.hide())}},PgPageTree=function(f){function d(e){u.withDataAndChildren(e,D)}function g(e){var t=P(e);if(t){for(var n=[t],i=t.idx+u.getNumberOfDescendants(t.idx,_),a=t.idx+1;a<=i;a++)n.push(_[a]);return n}return null}function p(){nextFrame.do("refreshGrid",function(){e.research(),I&&(I.refresh(),h)&&!h.view.isVisible()&&h.view.whenVisible(function(){I.show()})})}var s,u,h,e=this,m=0,o=!1,n=0,v={styles:!1,images:!1},w=!1,_=[],b={},I=(this.getDomMode=function(){return o},this.setDomMode=function(e){o=e},this.setAutoCollapse=function(e){n=e},this.setShowInteractions=function(e){s=e},this.setFilterOptions=function(e){var t=w;w=!1,$.each(e,function(e,t){if(t)return w=!0}),v=e,x=t!==w},this.setTreeView=function(e){h=e},null),D=(this.setTableGrid=function(e){I=e,this.$element=I.$element,e.setData(_),x&&this.research()},$("<div/>").addClass("crsa-tree-branch pg-tree-ul"),this.$element=null,this.highlightOnMouseOver=!0,this.destroy=function(){nextFrame.cancelAll(),h=I=null,u&&u.destroy(),e=b=_=u=null},this.getDataFor$Element=function(e){return I.getDataFor$Element(e)},this.updatePgIdMap=function(){var e=new CrsaProfile;b={},_.forEach(function(e){e.pgid&&(b[e.pgid]=e)}),e.show("updatePgIdMap")},function(e){e&&e.pgid&&delete b[e.pgid]}),P=function(e){return b[e]||null},y=(this.getTreeDataItemForPgId=function(e){return P(e)},function(e,t){var n,i=[];return o?(n=e.get$DOMElement())&&M(i,n?n.get(0):null,!1,t):N(i,e,!1,t),i});const E=1,S=3,k=2;function C(e){e&&(e.populated=!1,e.def=null)}function T(e,t){Array.isArray(e)?e.forEach(function(e){e.force_search=t}):e&&(e.force_search=t)}var i=null,x=(this.research=function(e){var t={selected_ids:{},changed:!1};f.callFrameworkHandler("on_custom_tree_filter",t),(i||t.changed||w||e)&&this.search(i,!0,t)},!1),A=(this.search=function(e,a,t){if(h){x=!1;var n,o,l=0<(e=null===e?"":e).length?new RegExp(escapeRegExp(e),"i"):null,s=!1,r=(e.startsWith("$")&&(e=e.substr(1),s=!0),{}),c=(i=e,t?n=t:f.callFrameworkHandler("on_custom_tree_filter",n={selected_ids:{},changed:!1}),n.selected_ids),d=n.changed;if(e||d||w){if(e)try{f.get$Html().find(e).each(function(e,t){var n=t.getAttribute("data-pg-id");n&&(r[n]=!0)}),0}catch(e){0}u&&(o=f.get$Html().get(0),_.forEach(function(e){e.search=0,e.peek_in&&(e.collapsed=!0,e.peek_in=!1)}),u.forEachWithParents(function(e,t){h.populateDataItem(e,o);var n=!1;if((n=!(s||l&&!e.search_string.match(l))||r[e.pgid]?!0:n)&&d&&(n=c[e.pgid]||!1),w&&e.pgel&&(v.styles?n=!!e.pgel.getAttribute("style")&&n&&!0:v.images?n=n&&"img"===e.pgel.tagName:v.links?n=n&&"a"===e.pgel.tagName:v.components?n=n&&0<e.pgel.findAttributesStartingWith("data-pgc").length:v.wp?n=n&&(0<e.pgel.findAttributesStartingWith("wp-").length||0<e.pgel.findAttributesStartingWith("cms-").length):v.wc?n=n&&0<e.pgel.findAttributesStartingWith("wc-").length:v.ia?n=n&&0<e.pgel.findAttributesStartingWith("data-pg-ia").length:v.texts&&(n=n&&0<e.pgel.text(null,!0).trim().length)),n){e.search=E;for(var i=t.length-1;0<=i&&t[i].search===S;i--)t[i].search=k,t[i].collapsed&&(t[i].peek_in=!0),t[i].collapsed=!1}else if(0&&e.force_search&&a)for(i=t.length-1;0<=i&&t[i].search===S;i--)t[i].search=k;else e.search=S}),I.refresh())}else _.forEach(function(e){e.search=0,e.force_search=!1,e.peek_in&&(e.collapsed=!0,e.peek_in=!1)}),I.refresh()}else x=!0},this.scrollToSelected=null,this.handleEvent=function(e){var t,n,i,a=e.getPgel(),o=P(e.pgId);try{switch(e.operation){case"selected":o&&(this.scrollToSelected=null,o.selected=!0,u.peek(o)?(u.reindexData(0,!0),p()):I&&I.updateItem(o),I&&I.scrollToDelayed(o),this.scrollToSelected=o,h)&&h.onSelected(o);break;case"deselected":o&&(o.selected=!1,this.scrollToSelected==o&&(this.scrollToSelected=null),u.unpeek(o)?(u.reindexData(0,!0),p()):I&&I.updateItem(o),h)&&h.onDeselected(o);break;case"show":o.hide_in_pg=!1,o.hide_in_pg_child=!1,u.withChildren(o,function(e){if(e.hide_in_pg)return!1;e.hide_in_pg_child=!1}),u.reindexData(),p();break;case"hide":o.hide_in_pg=!0,u.withChildren(o,function(e){if(e.hide_in_pg)return!1;e.hide_in_pg_child=!0}),u.reindexData(),p();break;case"remove":case"detach":o&&(u.removeItem(o,D),u.reindexData(),p());break;case"insertAfter":case"insertBefore":var l=P(e.objectId),s=g(e.pgId)||y(a);T(s,!0),u[e.operation](l,s),u.reindexData(),p();break;case"insertAtIndex":var l=P(e.objectId),s=g(e.pgId)||y(a),r=getPgNodeByPgId(e.objectId).getChildPos(a,!0);u.insertAtIndex(l,s,r),T(s,!0),u.reindexData(),p();break;case"appendPrepend":l=P(e.objectId);e.pgId?(s=g(e.pgId)||y(a),e.data.prepend?u.prepend(l,s):u.append(l,s),T(s,!0),u.reindexData(),p()):(C(l),I&&I.updateItem(l));break;case"removeAllChildren":u.withChildren(o,D),u.removeDescendants(o),u.reindexData(),p();break;case"detag":D(o),u.delevel(o),T(o,!0),u.reindexData(),p();break;case"replaceContentWithElement":u.withChildren(o,D);s=g(e.objectId)||y(getPgNodeByPgId(e.objectId));u.replaceContentWith(o,s),T(s,!0),u.reindexData(),p();break;case"replaceContentWithContentOf":u.withChildren(o,D),1<(s=g(e.objectId)||y(getPgNodeByPgId(e.objectId))).length&&(s.shift(),u.replaceContentWith(o,s),T(s,!0),u.reindexData(),p());break;case"replaceWith":d(o);s=g(e.objectId)||y(getPgNodeByPgId(e.objectId));u.replaceWith(o,s),s[0].selected=o.selected||!1,T(s,!0),u.reindexData(),p();break;case"removeAttr":case"setAttr":case"removeClass":case"addClass":case"replaceTag":var c=!1;if(e.data.attr&&e.data.attr.startsWith("data-pg-ia")){if(e.data.info&&e.data.info.pgia_animation)break;c=!0}if(!c){C(o),T(o,!0),I&&I.updateItem(o);break}case"update":case"updateInner":case"html":o||e.data&&e.data.domPgId&&(o=P(e.data.domPgId)),o&&(d(o),t=a,void 0===(n=o)&&(n=P(t.getId())),i=y(t),u.replaceWith(n,i),T(o,!0),u.reindexData(),pinegrow.selectedElements.forEachElement(function(e){var t=P(e.getId());t&&(t.selected=!0)}),p())}}catch(e){console.log("treeError",e)}},!1),O=null,M=(this.options={num_classes:-1,classes_filter:null},this.create=function(){_=[],b=this.treeData_PgIdMap={},this.options={num_classes:-1,classes_filter:null},f.callFrameworkHandler("on_get_tree_options",this.options);var e=!1,t=f.get$Html(),n=pinegrow.getIsolatedElement(f),t=t.get(0),i=f.sourceNode.findOne("html")||f.sourceNode.children[0],a=(A=!1,O=null,n&&(t=(i=n).get$DOMElement().get(0),a=pinegrow.getIsolatedElementOptions(),A=a.tree_hide_scripts,O=a.drag_drop_only_top_level?n:null,o=!1),new CrsaProfile(!0));o?M(_,t,e):i&&N(_,i,e),a.show("create tree data items"),(u=new PgTreeDataHelper(_)).reindexData(),this.research()},function(e,t,n,i){i=i||0;var a="sort",o=(("BODY"==t.tagName&&0<$(t).children().length||"HEAD"==t.tagName||"HTML"==t.tagName)&&(a="no-sort"),""),l=t.tagName,s=null;if("STYLE"==l&&"crsa-inline-styles"==t.id)return"";F(t)&&(a+=" crsa-tree-node-hidden");var r=++m,c=(t.setAttribute("data-pg-tree-id",r),t.getAttribute("data-pg-id")),o=(c?0:(a+=" dyn",s=t),"HTML"==l&&(l=f.name,o+=" tag-block",a+=" doc-root"),{level:i,tags:o,classes:a,name:l,pgid:c,treeId:r,shown:!0,collapsed:W(t,i),dyn_element:s}),d=(e.push(o),c&&(b[c]=o),c&&H(e,t,c,i),t.childNodes);if(0<d.length&&"aaaSVG"!==t.tagName)for(var g=0;g<d.length;g++){var p=d.item(g);1==p.nodeType?pgIsNodePageUI(p)||A&&"SCRIPT"===p.tagName||M(e,p,!1,i+1):p.nodeType}}),H=function(n,e,i,a){if(s){var o,l,t=e.getAttribute("data-pg-ia");if(t)try{(o=JSON.parse(t)).l&&(l=0,o.l.forEach(function(e){var t=e.name||"Interaction "+(l+1);if(e.on)switch(e.on){case"mobile":t+=" [SM]";break;case"desktop":t+=" [LG]";break;case"off":t+=" [OFF]"}e.nopg&&(t+=" [NOPG]"),n.push({level:a+1,name:t,pgid:i,populated:!0,shown:!0,collapsed:!1,no_sort:!0,no_insert:!0,icon:"icon-113",template_type:"interaction",search_string:t,pgia:{type:"a",action:"i",id:i+":animation_"+l,idx_zero:l++,desc:e.a&&e.a.desc?e.a.desc:null}})}))}catch(e){}if(t=e.getAttribute("data-pg-ia-scene"))try{(o=JSON.parse(t)).l&&(l=0,o.l.forEach(function(e){var t=e.name||"Scroll scene"+(1<o.length?" "+(l+1):"");if(e.on)switch(e.on){case"mobile":t+=" [SM]";break;case"desktop":t+=" [LG]";break;case"off":t+=" [OFF]"}e.nopg&&(t+=" [NOPG]"),n.push({level:a+1,name:t,pgid:i,populated:!0,shown:!0,collapsed:!1,no_sort:!0,no_insert:!0,template_type:"scrollscene",search_string:t,pgia:{type:"a",action:"s",id:i+":scene_item_"+l,idx_zero:l++,desc:e.a&&e.a.desc?e.a.desc:null}})}))}catch(e){}}},N=function(e,t,n,i){i=i||0;var a="sort",o=!1,l=f.getTypeThatFiltersTree(t),s=(("body"==t.tagName&&0<t.children.length||"head"==t.tagName||"html"==t.tagName)&&(a="no-sort",o=!0),!1),r=!1,c=(O&&(t===O?(a="no-sort",r=o=!0):t.isDescendantOf(O)&&(s=!0)),""),d=t.tagName,g=(L(t)&&(a+=" crsa-tree-node-hidden",0),t.getId()),c=(g?0:a+=" dyn","html"==d&&(d=f.name,c+=" tag-block",a+=" doc-root"),{level:i,tags:c,classes:a,name:d,pgid:g,pgel:t,treeId:0,shown:!0,collapsed:B(t,i)||s,no_sort:o,focused:r}),p=(e.push(c),g&&(b[g]=c),1&&H(e,t,g,i),t.children);if(0<(p=l&&l.on_filter_tree_children?l.on_filter_tree_children(t):p).length&&"aaasvg"!==t.tagName)for(var u=0;u<p.length;u++){var h=p[u];!h.isElementOrScript||A&&"script"===h.tagName||N(e,h,!1,i+1)}},F=function(e){return""==e.getAttribute("data-pg-hidden")},L=function(e){return e.hasAttribute("data-pg-hidden")},W=function(e,t){return!pgf.kids&&(0<n&&n<=t||("HEAD"==e.tagName?!f.show_head_in_tree:e.hasAttribute("data-pg-collapsed")?"false"!==e.getAttribute("data-pg-collapsed"):"SVG"===e.tagName||"svg"===e.tagName))},B=function(e,t){return!pgf.kids&&(0<n&&n<=t||e.isCollapsed())}};