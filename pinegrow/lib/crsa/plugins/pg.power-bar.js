var PgPowerBar=function(e){function n(e){var t=new pgParser;return t.assignIds=!1,t.parse(e),t.validate().length?null:e}var t=$('<div class="power-bar"></div>').appendTo(e),i=$('<input type="text" class="power-bar-input"/>').appendTo(t),o=$('<button class="btn btn-primary">Go</button>').appendTo(t),a=($('<div class="power-bar-list"></div>').appendTo(t),new PgApi),r="pg-preview-1";i.on("input",function(e){var t=i.val(),t=n(t);t&&a.previewCodeInPage(r,t,"append",null)}),i.on("blur",function(e){a.clearPreviewCodeInPage(r)}),o.on("click",function(e){var t=i.val(),t=n(t);t&&a.append(t,null)})},PgClipboardItem=function(e,t,n,i){if(n=n||"code",this.name=null,this.valid=!1,this.code=e,this.source=t||"pg",this.sticky=!1,this.type=n,this.only_text=!0,this.data=i,"code"==n){var o=new pgParser;if(o.assignIds=!1,o.parse(e),0==o.validate().length){for(var a=[],r=0;r<o.rootNode.children.length;r++){if(!o.rootNode.children[r].textNode){a.push(o.rootNode.children[r].getName());var s=0;for(r+=1;r<o.rootNode.children.length;r++)o.rootNode.children[r].isElementOrScript&&s++;0<s&&a.push("<small> + "+s+" more</small>"),this.only_text=!1;break}var l=$.trim(o.rootNode.children[r].content);l.length&&a.push('<nametext>"'+crsaGetSummaryStr(escapeHtmlCode(l),30,!0)+'"</nametext>')}this.name=a.join(" "),this.valid=!0}else this.name='<nametext>"'+crsaGetSummaryStr(escapeHtmlCode(e),30,!0)+'"</nametext>'}else"css"==n||"attributes"==n?(this.name='<nametext>"'+crsaGetSummaryStr(escapeHtmlCode(e),30,!0)+'"</nametext>',this.valid=!0):"actions"==n?(this.name=`<action>${i[0].def.name}</action>`,1<i.length&&(this.name+=` <small>+ ${i.length-1} more</small>`)):"pgia.timeline"==n?this.name=`<action>Timeline</action>`:"pgia.transform"==n&&(this.name=`<action>Timeline tween</action>`);this.formatText=function(){var t="";return this.code.split(/\n+/).forEach(function(e){(e=$.trim(e)).length&&(t+=`<p>${e}</p>`)}),t}},PgClipboard=function(){function n(){return require("nw.gui").Clipboard.get().get("text")}var p=this,l=[],c=0,r="insertAfter",i="pinegrowisthebesteditorintheuniverse",d=(this.getPlacement=function(){return r},this.setPlacement=function(e){r=e},this.add=function(e,t,n){var i=null;if(e instanceof PgClipboardItem)i=e;else{if(!e||!$.trim(e).length)return;var o=function(e){for(var t=0;t<l.length;t++)if(l[t].code==e)return t;return-1}(e);0<=o&&(n=n||l[o].type,l.splice(o,1)),i=new PgClipboardItem(e,t,n)}l.unshift(i);for(var a=[],r=[],s=c=0;s<l.length;s++)l[s].sticky?(r.push(l[s]),l[s].position=1<s?Math.max(s-1,0):s):a.length<100&&a.push(l[s]);for(s=0;s<r.length;s++)a.splice(Math.min(r[s].position,a.length),0,r[s]);l=a,"undefined"!=typeof pinegrow&&pinegrow.callGlobalFrameworkHandler("on_clipboard_changed",i)},this.select=function(e){e<l.length&&d(l[c=e].code),"undefined"!=typeof pinegrow&&pinegrow.callGlobalFrameworkHandler("on_clipboard_item_selected",c)},this.getCurrentItem=function(){return c<l.length?l[c]:null},this.getCurrentIndex=function(){return c},this.getAll=function(){return l},this.onPageMouseUp=function(e){b(e.currentTarget),e.stopPropagation()},this.onPagePaste=function(e){t()&&s()},function(e){if(!isApp())return!1;setTimeout(function(){require("nw.gui").Clipboard.get().set(e,"text")},100)}),u=function(){if(!isApp())return!1;setTimeout(function(){var e=require("nw.gui").Clipboard.get();e.get("text")===i&&e.clear()},10)},h=function(e){try{var t=n();t&&t!==i?p.add(t,e):u()}catch(e){}},o=(this.addFromClipboard=function(e){h(e)},h(),isApp()||setTimeout(function(){pinegrow.addEventHandler("on_key_pressed",function(e,t,n){var i;n.input||n.edit||!n.ctrl||("c"===n.key?(i=window.getSelection())&&i.toString().length&&document.activeElement&&document.activeElement.contains(i.baseNode)||(a(),n.done=!0):"x"===n.key?(o(),n.done=!0):"v"===n.key&&(s(),n.done=!0))})},0),document.addEventListener("copy",function(e){a()}),function(){var e,t,n;g()||f()?setTimeout(h,100):w()?(n=m(!0),p.add(n,"pg","css"),d(n)):(e=new PgApi,t=[],pinegrow.selectedElements.forEachElement(function(e){t.push(e.toStringOriginal(!0,pinegrow.getFormatHtmlOptions()))}),t.length?(n=t.join(""),p.add(n),d(n)):u(),e.removeElements()),"undefined"!=typeof pinegrow&&pinegrow.callGlobalFrameworkHandler("on_clipboard_cut")}),a=(document.addEventListener("cut",function(e){o()}),function(e,t,n){if(t)switch(t){case"actions":case"pgia.timeline":case"pgia.transform":var i=new PgClipboardItem(t,"pg",t,n);p.add(i);break;case"attributes":i=new PgClipboardItem(n,"pg",t);p.add(i)}else{var o,a,r,s=null,l=pinegrow.findFrameworkByKey("pg.ia");if(l&&l.timelineView&&(s=l.timelineView.getSelectedTransform()),g())setTimeout(h,100);else if(s)pinegrow.clipboard.copySpecial("pgia.transform",s.toData()),pinegrow.showQuickMessage("Tween was copied to clipboard.");else if(f())setTimeout(h,100);else if(y()){var c=v();p.add(c,"pg","attributes"),d(c)}else if(w()){var c=m();p.add(c,"pg","css"),d(c)}else{if(pgf.copy_actions)return void((o=pinegrow.selectedElements.getLastSelected())?(a=[],o.getPage().getAllActionTypes(o).forEach(function(e){a.push({def:e,values:e.getActionValuesForPgel(o)})}),a.length?(pinegrow.clipboard.copySpecial("actions",a),pinegrow.showQuickMessage(a.length+` action${1<a.length?"s":""} copied to clipboard.`)):pinegrow.showQuickError("The selected element has no actions to copy.")):pinegrow.showQuickError("Please select an element first."));e=e||pinegrow.selectedElements.getCollection(),r=[],e.forEachElement(function(e){r.push(e.toStringOriginal(!0,pinegrow.getFormatHtmlOptions()))}),r.length?(c=r.join(""),p.add(c),d(c)):u()}}"undefined"!=typeof pinegrow&&pinegrow.callGlobalFrameworkHandler("on_clipboard_copy")}),s=function(e,t){var n,i,o,a;e=e||p.getCurrentItem(),t=t||pinegrow.selectedElements.getCollection(),e&&("actions"===e.type?(i=new PgApi,e.data.forEach(function(e){i.addAction(t,e.def,null,e.values)}),b()):"pgia.timeline"===e.type||"pgia.transform"===e.type?(n=pinegrow.findFrameworkByKey("pg.ia"))&&n.timelineView.handlePaste(e.type,e.data):"attributes"==e.type?pgf.edit_html&&(i=new PgApi,0<t.getLength()?i.pasteAttributes(t,e.code):pinegrow.showQuickMessage("Please select the destination element first.")):pgf.edit_html&&(e.valid?(o=function(e){(new PgApi).insertElements(e,t,r,{repeater:!0,fix_placement:!0,before_body_scripts:!0})},0===t.getLength()?pinegrow.showQuickMessage("Please select the destination element first."):!e.only_text||(a=!1,t.forEachElement(function(e){var t=e;(t="insertBefore"!=r&&"insertAfter"!=r?e:e.parent)&&t.closest("p")&&(a=!0)}),a)?o(e.code):pinegrow.showAlert(`<p>Would you like to format the text into &lt;p&gt; paragraphs before pasting?</p>`,"Format text?","Cancel","Yes, format",null,function(){o(e.formatText())},"No thanks",function(){o(e.code)})):pinegrow.showNotice("<p>The code has syntax errors (like unclosed tags) and so it can't be pasted to the page.</p><p>If you really want to add it to the page go to Edit code and paste it there.</p>","Can't insert invalid HTML","paste-invalid",function(e){e||pinegrow.showQuickMessage("Can't insert invalid HTML!",3e3,!1,"error")})))},g=(this.copySpecial=function(e,t){a(null,e,t)},this.copy=function(e){a(e)},this.paste=function(e,t){s(e,t)},document.addEventListener("paste",function(e){if(t())return e.preventDefault(),s(),!1},!0),function(){if(crsaIsInEdit())return!0;try{var e=$(document.activeElement);return(e=document.activeElement&&document.activeElement.contentDocument?$(document.activeElement.contentDocument.activeElement):e).is('input,select,textarea,[contenteditable="true"]')&&!e.is("#crsa-dummy-field")}catch(e){}return!1}),t=(this.isInInput=g,function(){return!g()}),e=$("#crsa-dummy-field"),f=function(){var e;return!!isApp()&&(e=window.getSelection().toString())!=i&&e.length},m=function(i){function o(e){for(var t=0;t<e.length;t++){var n=e[t];(n=n.sourceStylesheet?n.sourceStylesheet:n).loaded&&n.stylePane&&(a.length,a+=n.stylePane.getStringOfSelectedItems(i),0<n.importedFiles.length)&&o(n.importedFiles)}}var e=pinegrow.stylesheets.getAllCrsaStylesheets(),a="";return o(e),a},w=function(){function i(e){for(var t=0;t<e.length;t++){var n=e[t];if((n=n.sourceStylesheet?n.sourceStylesheet:n).loaded){if(n.stylePane&&n.stylePane.hasSelectedRules())return!0;if(0<n.importedFiles.length&&i(n.importedFiles))return!0}}return!1}var e=pinegrow.stylesheets.getAllCrsaStylesheets();return i(e)},v=function(){return $(".attributes-panel").data("pg-fast-editor").getStringOfSelectedItems("",'="','" ')},y=function(){return 0<$(".attributes-panel").find(".selected-item").length},b=function(){!isApp()||g()||f()||(e.val(i),e.get(0).focus(),e.get(0).select())},P=($(document).mouseup(b),null);this.onWindowBlur=function(){P=n()},this.onWindowFocus=function(){var e=n();P!=e&&(h("system"),P=e)}},PgClipboardView=function(){function e(e,t){l()}function t(e,t){a(t)}var r=pinegrow.getClipboard(),n=$('<div class="clipboard-view"></div>'),i=new PgUIView(n),o=(this.view=i,new PgInputField("clipboard-placement",{type:"select",show_empty:!1,name:"On paste",options:[{key:"append",name:"append"},{key:"prepend",name:"prepend"},{key:"insertBefore",name:"insert before"},{key:"insertAfter",name:"insert after"}]})),s=(o.setValue(r.getPlacement()),o.on("change",function(e){r.setPlacement(o.getValue())}),o.appendTo(n),$('<ul class="clipboard-list"></ul>').appendTo(n)),a=(pinegrow.addEventHandler("on_clipboard_changed",e),pinegrow.addEventHandler("on_clipboard_item_selected",t),function(e){s.find("li.current").removeClass("current");var t=s.children();t.length>e&&$(t.get(e)).addClass("current")}),l=function(){function n(e){var t=$(e.delegateTarget).closest("li"),n=t.data("item-index");return 0<=n&&n<i.length?{$item:t,item:i[n],idx:n}:null}for(var i=r.getAll(),e=r.getCurrentIndex(),t=(s.html(""),0);t<i.length;t++){var o=$('<li><div class="selector"></div>'+i[t].name+"</li>").data("item-index",t).appendTo(s),a=$('<i class="control paste-control icon icon-right-arrow"></i>').appendTo(o).on("click",function(e){e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation();var t=n(e);t&&r.paste(t.item)}),a=(addTooltip(a,"Paste the item"),$('<i class="control sticky-control icon icon-Pin"></i>').appendTo(o).on("click",function(e){e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation();var t=n(e);t&&(t.item.sticky=!t.item.sticky,t.item.sticky?t.$item.addClass("sticky"):t.$item.removeClass("sticky"))}));addTooltip(a,"Keep the clipboard item in the same position."),i[t].sticky&&o.addClass("sticky"),t==e&&o.addClass("current"),o.on("click",function(e){e.preventDefault();var t=n(e);t&&(s.find("li.current").removeClass("current"),t.$item.addClass("current"),r.select(t.idx))})}};this.show=function(){l()},i.onDestroy=function(){pinegrow.removeEventHandler("on_clipboard_changed",e),pinegrow.removeEventHandler("on_clipboard_item_selected",t)}},PgQuickClipboard=function(){var e=new PgClipboardView,t=new PgQuickWindow("Clipboard",e,"quickClipboard",320,320);t.showAtPosition(200,200),e.show(),t.onDestroy=function(){pinegrow.showNotice("<p>Use <b>Edit -&gt; Show clipboard</b> to show the Clipboard again.</p>","Show clipboard","show-clipboard-3",null,!0)}},PgInputField=function(t,i){var o=this,n=(this.$field=$.fn.crsa("addInputField",null,null,t,i,{},!0),this.$input=this.$field.find("input.crsa-input,textarea.crsa-input"),"selector"!==i.type&&"menu"!==i.type||(this.$input=this.$field.find("input")),0===this.$input.length&&(this.$input=this.$field.find(".crsa-input")),this.$input.length||(this.$input=this.$field.find("input")),this.on=function(e,t){this.$input.on(e,t)},this.off=function(e,t){this.$input.off(e,t)},this.on("input",function(){r(),s()}),this.show=function(){pg$Show(this.$field,"flex")},this.hide=function(){pg$Hide(this.$field)},this.setValue=function(e){"checkbox"===this.$input.attr("type")?this.$input.prop("checked",e==i.value):this.$input.val(e),this.$input.trigger("crsa-field-value-updated"),r(),s(),i.with_clear_icon&&this.$input.trigger("updateclearicon")},this.getValue=function(){return this.$input.is('[type="checkbox"]')?this.$input.prop("checked")?i.value:"neg_value"in i?i.neg_value:null:this.$input.val()},this.appendTo=function(e){this.$field.appendTo(e)},this.prependTo=function(e){this.$field.prependTo(e)},this.setWidth=function(e){this.$input.find(".selector-container").css("width",e+"px")},this.setLabelWidth=function(e){"checkbox"===i.type?this.$field.find('input[type="checkbox"]').css("margin-left",e):this.$field.find("label").css("width",e)},this.focus=function(e){var t=this.$input.get(0);e&&t.setSelectionRange(t.value.length,t.value.length),t.focus()},this.blur=function(){this.$input.get(0).blur()},null),a=!1,r=(this.setError=function(e){e?((n=n||$(`<p class="error-message"></p>`).appendTo(this.$field)).html(e),a||(pg$Show(n),this.$field.addClass("error"),a=!0)):n&&a&&(pg$Hide(n),this.$field.removeClass("error"),a=!1)},function(){var e;i.validate&&(n=n||$(`<p class="error-message"></p>`).appendTo(o.$field).hide(),e=o.getValue(),pinegrow.validateField({},t,e,i,o.$field,{key:e}))}),s=function(){var e,t,n;i.auto_resize&&((t=(e=o.$input).data("start-width"))||(t=e.width(),e.data("start-width",t)),e=e.val(),parseInt(t)<(t=pgMeasureTextWidth(e))||1?(n=20,""===e?o.$field.css("width",n+"px"):o.$field.css("width",(n=t+30)+"px")):o.$field.css("width",""))}},PgLastActivePage=function(){var n=null,i=null;this.setPage=function(e,t){n!==e&&i&&i(),n=e,i=t},this.getPage=function(){return n||pinegrow.getSelectedPage()},this.closePage=function(e){n===e&&(i=n=null)}};